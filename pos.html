<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Ù…Ø·Ø¹Ù… - Ù…ÙˆØ¸Ù</title>
<style>
/* --------- Global --------- */
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(120deg, #0f0c29, #302b63, #24243e);
  color: #f0f0f0;
  overflow-x: hidden;
  transition: background 0.5s ease;
}

h3, h4 { margin: 5px 0; text-shadow: 1px 1px 5px #000; }

/* --------- Header --------- */
.header {
  background: linear-gradient(90deg, #1f1c2c, #928dab);
  color: #fff;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  position: sticky;
  top: 0;
  z-index: 100;
  animation: slideDown 0.5s ease;
}

@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.header button {
  margin-left: 8px;
  padding: 8px 14px;
  border-radius: 6px;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}
.header button:hover { transform: scale(1.1) rotate(-2deg); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

.header .report { background: #3498db; }
.header .logout { background: #e74c3c; }

/* --------- Container --------- */
.container {
  display: flex;
  height: 90vh;
  padding: 15px;
  gap: 15px;
  animation: fadeIn 0.8s ease;
}

@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

/* --------- Products Section --------- */
.products {
  width: 65%;
  padding: 15px;
  background: rgba(30,30,40,0.9);
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.7);
  overflow-y: auto;
  backdrop-filter: blur(10px);
  transition: transform 0.3s ease;
}
.products:hover { transform: scale(1.02); }

.categories {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
}
.categories button {
  padding: 10px 16px;
  background: linear-gradient(45deg, #ff416c, #ff4b2b);
  color: #fff;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 3px 8px rgba(0,0,0,0.4);
}
.categories button.active, .categories button:hover { opacity: 0.85; transform: scale(1.1) rotate(-2deg); }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 15px;
  margin-top: 15px;
}
.product {
  background: linear-gradient(145deg, #1abc9c, #16a085);
  color: #fff;
  padding: 15px;
  text-align: center;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.4s ease;
  position: relative;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  transform-style: preserve-3d;
}
.product:hover { transform: rotateY(15deg) translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.7); }

input, select, .products button.extra {
  padding: 8px;
  margin: 5px 0;
  border-radius: 8px;
  border: none;
  width: 100%;
  box-sizing: border-box;
  background: rgba(255,255,255,0.1);
  color: #fff;
  transition: all 0.3s ease;
}
input:focus, select:focus { background: rgba(255,255,255,0.2); outline: none; }
.products button.extra {
  background: #8e44ad;
  color: #fff;
  font-weight: bold;
}
.products button.extra:hover { transform: scale(1.05); }

/* --------- Cart Section --------- */
.cart {
  width: 35%;
  background: rgba(40,40,50,0.95);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  backdrop-filter: blur(8px);
  transition: transform 0.3s ease;
}
.cart:hover { transform: scale(1.02); }
.cart h3 { margin-bottom: 15px; text-shadow: 1px 1px 4px #000; }
.cart-items p { margin: 5px 0; font-size: 14px; transition: all 0.2s ease; }
.cart-items button { background: #e74c3c; border-radius: 6px; padding: 3px 6px; margin-left: 5px; font-size: 12px; transition: all 0.3s ease; }
.cart-items button:hover { transform: scale(1.2); }
.cart label { font-weight: bold; margin-top: 8px; display: block; }
.cart input { padding: 6px; margin: 3px 0 8px 0; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: #fff; }
.cart .total { font-weight: bold; font-size: 18px; margin-top: 15px; text-align: center; text-shadow: 1px 1px 4px #000; }
.cart button.save { background: #27ae60; }
.cart button.clear { background: #c0392b; }
.cart button:hover { opacity: 0.9; }

/* --------- Login Box --------- */
.login-box {
  max-width: 380px;
  margin: 150px auto;
  background: rgba(20,20,30,0.95);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.7);
  text-align: center;
  color: #fff;
  animation: fadeIn 1s ease;
}
.login-box input {
  padding: 12px;
  margin: 8px 0;
  width: 100%;
  border-radius: 10px;
  border: none;
  background: rgba(255,255,255,0.1);
  color: #fff;
  transition: all 0.3s ease;
}
.login-box input:focus { background: rgba(255,255,255,0.2); outline: none; }
.login-box button {
  margin-top: 12px;
  padding: 12px 20px;
  background: linear-gradient(45deg, #2980b9, #6dd5fa);
  color: #fff;
  border-radius: 10px;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}
.login-box button:hover { transform: scale(1.05) rotate(-2deg); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }

/* --------- Search --------- */
.search-container { flex: 1; margin: 0 10px; }
#searchProduct {
  width: 100%;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
  color: #fff;
  background: rgba(255,255,255,0.1);
  transition: all 0.3s ease;
}
#searchProduct:focus { background: rgba(255,255,255,0.2); outline: none; }
</style>
</head>
<body>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage" class="login-box">
<h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="app" style="display:none;">

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
<div class="header">
  <div id="userInfo"></div>
  <div class="search-container">
    <input type="text" id="searchProduct" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="searchProducts()">
  </div>
  <div>
    <button class="report" onclick="toggleDailyReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
    <button class="logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<div class="container">

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
<div class="products">
  <h3>Ø§Ù„ÙØ¦Ø§Øª</h3>
  <div class="categories" id="categories"></div>
  
  <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
  <div class="grid" id="productGrid"></div>
  
  <br><br>
  <button class="extra" onclick="addExtra()">Ø§ÙƒØ³ØªØ±Ø§</button>
</div>

<!-- Ø§Ù„Ø³Ù„Ø© -->
<div class="cart">
<h3>Ø§Ù„Ø·Ù„Ø¨</h3>
<div class="cart-items" id="cartItems"></div>

<label>Ø¶Ø±ÙŠØ¨Ø© %</label>
<input type="number" id="tax" value="0">

<label>Ø®ØµÙ…</label>
<input type="number" id="discount" value="0">

<div class="total" id="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0</div>

<button class="save" onclick="saveOrder()">Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø©</button>
<button class="clear" onclick="clearCart()">Ù…Ø³Ø­</button>
</div>
</div>
</div>

<!-- Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="invoice"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig={
  apiKey: "AIzaSyBQBGGtON-RNk4qH2Pws3RBBBE3cH3J4PU",
  authDomain: "store-app-d05fa.firebaseapp.com",
  projectId: "store-app-d05fa",
  storageBucket: "store-app-d05fa.firebasestorage.app",
  messagingSenderId: "257385912042",
  appId: "1:257385912042:web:bc30397b745340e31e2993"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Ø­ÙØ¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    document.getElementById("userInfo").innerText = user.email + " | ÙƒØ§Ø´ÙŠØ±";
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadCategories();
    loadProducts();
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("app").style.display = "none";
  }
});

let currentUser=null;
let cart=[];
const USD_TO_LBP=89000;

// --------- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆØ®Ø±ÙˆØ¬ ---------
async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  let userCred;
  try{userCred=await auth.signInWithEmailAndPassword(email,password);}
  catch{userCred=await auth.createUserWithEmailAndPassword(email,password);}
  currentUser=userCred.user;
  document.getElementById("userInfo").innerText=currentUser.email+" | Ù…ÙˆØ¸Ù";
  loginPage.style.display="none";
  app.style.display="block";
  loadCategories();
  loadProducts();
}
function logout(){auth.signOut(); location.reload();}

// --------- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---------
async function loadCategories() {
  const div = document.getElementById("categories");
  div.innerHTML = "";
  
  const allBtn = document.createElement("button");
  allBtn.textContent = "Ø§Ù„ÙƒÙ„";
  allBtn.style.background = "#333";
  allBtn.style.color = "white";
  allBtn.onclick = function() { showProducts('all', allBtn); };
  div.appendChild(allBtn);
  
  const snap = await db.collection("categories").get();
  snap.forEach(doc => {
    const cat = doc.data().name;
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = function() { showProducts(cat, btn); };
    div.appendChild(btn);
  });
}

let allProducts = [];

async function loadProducts() {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";
  allProducts = [];
  
  const snap = await db.collection("products").get();
  snap.forEach(doc => {
    const p = doc.data();
    p.id = doc.id;
    allProducts.push(p);
  });
  
  renderProducts(allProducts);
}

function renderProducts(products) {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";
  
  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "product";
    div.innerHTML = `${p.name} - ${p.category}<br>${p.price}$ (${(p.price*USD_TO_LBP).toLocaleString()} Ù„.Ù„)`;
    
    div.onclick = function() { addToCart(p.name, p.price); };
    
    grid.appendChild(div);
  });
}

function searchProducts() {
  const value = document.getElementById("searchProduct").value.toLowerCase();
  const filtered = allProducts.filter(p =>
    p.name.toLowerCase().includes(value) ||
    p.category.toLowerCase().includes(value)
  );
  renderProducts(filtered);
}
async function showProducts(cat, button) {
  document.querySelectorAll(".categories button").forEach(b => b.classList.remove("active"));
  if (button) button.classList.add("active");
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";
  let snap;
  if (cat === 'all') {
    snap = await db.collection("products").get();
  } else {
    snap = await db.collection("products").where("category", "==", cat).get();
  }
  snap.forEach(doc => {
    const p = doc.data();
    const div = document.createElement("div");
    div.className = "product";
    div.innerHTML = `${p.name} - ${p.category}<br>${p.price}$ (${(p.price*USD_TO_LBP).toLocaleString()} Ù„.Ù„)`;
    div.onclick = function() { addToCart(p.name, p.price); };
    grid.appendChild(div);
  });
}
// --------- Ø§Ù„Ø³Ù„Ø© ---------
function addToCart(name,price){
  let existing=cart.find(i=>i.name===name);
  if(existing){existing.qty+=1; existing.total=existing.price*existing.qty;}
  else{cart.push({name,price,qty:1,total:price});}
  renderCart();
}
function renderCart(){
  const div=document.getElementById("cartItems");
  div.innerHTML="";
  let subtotal=0;
  cart.forEach((item,i)=>{
    subtotal+=item.total;
    div.innerHTML+=`${item.name} Ã— ${item.qty} = ${item.total.toFixed(2)}$ (${(item.total*USD_TO_LBP).toLocaleString()} Ù„.Ù„)<br>`;
  });
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;
  document.getElementById("total").innerText=`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalUSD.toFixed(2)}$ (${totalLBP.toLocaleString()} Ù„.Ù„)`;
}
function clearCart(){cart=[]; renderCart();}
function addExtra(){
  const name=prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
  const weight=parseFloat(prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„ÙƒÙŠÙ„Ùˆ:"));
  const price=parseFloat(prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆØ²Ù†:"));
  if(!name || !weight || !price) return;
  cart.push({name, price, qty: weight, total: price});
  renderCart();
}

// --------- Ø§Ù„ÙØ§ØªÙˆØ±Ø© ---------
async function getNextNumber(){
  const ref=db.collection("counters").doc("orderCounter");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let num=1;
    if(doc.exists) num=doc.data().current+1;
    t.set(ref,{current:num});
    return num;
  });
}
async function saveOrder(){
  if(cart.length===0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
  const number=await getNextNumber();
  const subtotal=cart.reduce((s,i)=>s+i.total,0);
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;
  const now=new Date();
  const dateStr=now.toISOString().split('T')[0];

  await db.collection("sales").add({
    orderNumber:number,
    user:currentUser.email,
    items:cart,
    subtotal,
    tax,
    discount,
    totalUSD,
    totalLBP,
    date:dateStr,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP);
  window.print();
  clearCart();
}

function generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP){
  const now=new Date();
  const dateStr=now.toLocaleString("ar-EG",{hour12:false});
  let html=`<div style="font-family:monospace;width:58mm;font-size:12px;text-align:center;">
  <h3>Ù…Ø·Ø¹Ù… Ø§Ù„Ø³Ù†Ø¯ÙˆÙŠØ´Ø§Øª</h3>
  <p>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${number}</p>
  <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}</p>
  <p>Ø§Ù„Ù…ÙˆØ¸Ù: ${currentUser.email}</p>
  <hr>`;
  cart.forEach(item=>{
    const lbp=(item.total*USD_TO_LBP).toLocaleString();
    html+=`<p>${item.name} Ã— ${item.qty} = ${item.total.toFixed(2)}$ (${lbp} Ù„.Ù„)</p>`;
  });
  html+=`<hr>
  <p>Subtotal: ${subtotal.toFixed(2)}$ (${(subtotal*USD_TO_LBP).toLocaleString()} Ù„.Ù„)</p>
  <p>Tax: ${tax}%</p>
  <p>Discount: ${discount}</p>
  <p><strong>Total: ${totalUSD.toFixed(2)}$ (${totalLBP.toLocaleString()} Ù„.Ù„)</strong></p>
  <hr>
  <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…</p>
  </div>`;
  invoice.innerHTML=html;
}

// --------- ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… ---------
async function toggleDailyReport() {
  const modal = document.createElement("div");
  const content = document.createElement("div");
  document.body.appendChild(modal);
  modal.style.display="block";
  alert("ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… ØºÙŠØ± Ù…ÙØµÙ„ Ù„Ù„Ù…ÙˆØ¸Ù"); // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®ØµÙŠØµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
}
</script>
</body>
</html>
