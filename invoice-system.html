<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoices System</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== Existing Styles ===== */
:root {
  --primary: #C1272D;
  --bg: #f6f7fb;
  --card: #fff;
}
* {box-sizing:border-box;}
body {margin:0;font-family:'Cairo',sans-serif;background:var(--bg);}
header {background:var(--primary);color:#fff;padding:16px;text-align:center;}
header h1 {margin:0;font-size:15px;}
main {padding:20px;max-width:1200px;margin:20px auto;text-align:center;}
.card, .invoice-card {background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:right;}
input, select {width:100%;padding:10px;margin:6px 0 12px;border-radius:8px;border:1px solid #ddd;text-align:center;}
button {padding:6px 10px;border:none;border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;margin:2px;transition:0.2s;}
button:hover {opacity:0.8;}
.invoice-item {display:flex;gap:10px;align-items:center;margin-bottom:8px;justify-content:center;}
.invoice-item input {flex:1;text-align:center;}
.item-list li {margin:2px 0;padding:4px 6px;background:#f4f4f4;border-radius:4px;}
.items-list {margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;}
#search-invoice, #filter-section {min-width:150px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center;}
#search-invoice:focus, #filter-section:focus {outline:none;border-color:var(--primary);box-shadow:0 0 4px rgba(193,39,45,0.5);}
@media(max-width:600px){
  .invoice-item {flex-direction:column;}
  #search-invoice, #filter-section {width:100%;margin-bottom:6px;}
  #auth-section, #invoice-section {display: none;}
}

/* ===== Small Login Form ===== */
#auth-section {
  max-width: 350px;
  margin: 20px auto;
  padding: 15px;
}
#auth-section h2 {font-size:18px;margin-bottom:10px;}
#auth-section input {padding:8px;font-size:14px;}
#auth-section button {padding:6px 10px;font-size:14px;}

/* ===== Invoices Grid ===== */
#invoice-list {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: flex-start;
}
.invoice-card {
  flex: 1 1 400px; /* ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© ØªØ£Ø®Ø° Ù…Ø³Ø§Ø­Ø© 300px Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ */
  max-width: 340px;
  text-align: right;
  border: 1px solid #eee;
  border-radius: 12px;
  padding: 15px;
  transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.4s ease;
  opacity: 0;
  animation: fadeIn 0.5s forwards;
}
.invoice-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

/* ===== Loading CSS ===== */
#loading {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: #ffffff;
  display:flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index:1000;
  font-family:"Cairo",sans-serif;
  color:#C1272D;
}
#loading p { margin-top:20px; font-size:18px; letter-spacing:1px; font-weight:600; }
.loader { display: flex; gap:15px; }
.loader div {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #C1272D;
  box-shadow: 0 0 10px #C1272D, 0 0 20px #e74c3c, 0 0 30px #ff6f61;
  animation: bounce 0.8s infinite alternate ease-in-out, glow 1.2s infinite alternate;
}
.loader div:nth-child(2) { animation-delay: 0.2s; background:#e74c3c; box-shadow: 0 0 10px #e74c3c, 0 0 20px #ff6f61, 0 0 30px #C1272D;}
.loader div:nth-child(3) { animation-delay: 0.4s; background:#ff6f61; box-shadow: 0 0 10px #ff6f61, 0 0 20px #C1272D, 0 0 30px #e74c3c;}
@keyframes bounce { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-25px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
@keyframes glow { 0% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; } 50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; } 100% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; } }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <p>...Loading Database</p>
</div>

<header>
<h1>Invoices System</h1>
</header>

<main>
<div id="auth-section" class="card">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
<button onclick="resetPassword()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
<p id="auth-msg" style="color:red;"></p>
</div>

<div id="invoice-section" style="display:none;">
<div class="card">
<h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</h2>
<select id="invoice-section-select"></select>
<button onclick="addSection()">â• Ù‚Ø³Ù…</button>
<button onclick="editSection()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…</button>
<button onclick="deleteSection()">ğŸ—‘ Ø­Ø°Ù Ù‚Ø³Ù…</button>

<input type="text" id="invoice-number" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
<input type="text" id="invoice-store" placeholder="Ø§Ù„Ù…ØªØ¬Ø± / Ø§Ù„Ø¨Ø§Ø¦Ø¹">
<input type="text" id="invoice-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
<input type="text" id="invoice-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input type="text" id="invoice-date" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD)">

<select id="invoice-currency">
  <option value="USD">USD</option>
  <option value="LBP">LBP</option>
</select>

<div id="items-container"></div>
<button onclick="addItem()">â• Ù…Ù†ØªØ¬</button>

<input type="number" id="discount" placeholder="Ø®ØµÙ…">
<input type="number" id="vat" placeholder="Ø¶Ø±ÙŠØ¨Ø© (%)">
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-display">0</span></p>

<button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
<button onclick="clearForm()">ğŸ†‘ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
<button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
<button onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div class="card">
<h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
<div style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
  <select id="filter-section">
    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
  </select>
  <input type="text" id="search-invoice" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
</div>
<div id="invoice-list" style="margin-top:10px;"></div>
</div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
 apiKey:"AIzaSyB4NzOcosALN-8oLzMM1ONXdi2R-SvZ_co",
 authDomain:"invoice-app-6345a.firebaseapp.com",
 projectId:"invoice-app-6345a",
 storageBucket:"invoice-app-6345a.firebasestorage.app",
 messagingSenderId:"289913191209",
 appId:"1:289913191209:web:2e64b56a2d549f7fa15538"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentInvoiceId=null;
let allInvoices=[];

// ===== Loading Functions =====
const loading = document.getElementById('loading');
function showLoading(){ loading.style.display='flex'; }
function hideLoading(){ loading.style.display='none'; }
showLoading(); // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„

// ===== Add item =====
function addItem(){
  const container=document.getElementById('items-container');
  const div=document.createElement('div');
  div.className="invoice-item";
  div.innerHTML=`
    <input placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">
    <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="0">
    <button onclick="this.parentNode.remove();calculateTotal();">âŒ</button>`;
  container.appendChild(div);
  calculateTotal();
}

// ===== Calculate total =====
function calculateTotal(){
  const items=document.querySelectorAll('#items-container .invoice-item');
  let total=0;
  items.forEach(item=>{
    const qty=parseFloat(item.children[1].value)||0;
    const price=parseFloat(item.children[2].value)||0;
    total += qty*price;
  });
  const discount=parseFloat(document.getElementById('discount').value)||0;
  const vat=parseFloat(document.getElementById('vat').value)||0;
  total = (total - discount) + (total * vat/100);
  const currency=document.getElementById('invoice-currency').value;
  document.getElementById('total-display').textContent = `${total.toFixed(2)} ${currency}`;
}

document.getElementById('items-container').addEventListener('input',calculateTotal);
document.getElementById('discount').addEventListener('input',calculateTotal);
document.getElementById('vat').addEventListener('input',calculateTotal);
document.getElementById('invoice-currency').addEventListener('change',calculateTotal);

// ===== Auth =====
function login(){ 
  const email=document.getElementById('email').value; 
  const password=document.getElementById('password').value; 
  showLoading();
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>{ 
      document.getElementById('auth-msg').textContent=""; 
      loadInvoices(); 
      loadSections(); 
      document.getElementById('auth-section').style.display="none"; 
      document.getElementById('invoice-section').style.display="block";
      hideLoading();
    })
    .catch(e=>{ document.getElementById('auth-msg').textContent=e.message; hideLoading(); });
}

function resetPassword(){ 
  const email=document.getElementById('email').value; 
  auth.sendPasswordResetEmail(email).then(()=>alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯")).catch(e=>alert(e.message));
}

auth.onAuthStateChanged(user=>{
  if(user){ 
    document.getElementById('auth-section').style.display="none"; 
    document.getElementById('invoice-section').style.display="block"; 
    loadSections(); 
    loadInvoices();
    hideLoading();
  } else { 
    document.getElementById('auth-section').style.display="block"; 
    document.getElementById('invoice-section').style.display="none";
    hideLoading();
  }
});

function logout(){ auth.signOut(); }

// ===== Sections =====
function addSection(){ const name=prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:"); if(!name) return; db.collection('users').doc(auth.currentUser.uid).collection('sections').add({name}); }
function editSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„"); const newName=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:"); if(newName) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).update({name:newName}); }
function deleteSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ù„Ø­Ø°Ù"); if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).delete(); }
function loadSections(){ 
  const select=document.getElementById('invoice-section-select'); 
  const filter=document.getElementById('filter-section');
  db.collection('users').doc(auth.currentUser.uid).collection('sections').get().then(snapshot=>{
    select.innerHTML="";
    filter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';
    snapshot.forEach(doc=>{
      const name = doc.data().name;
      const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=name; select.appendChild(opt);
      const fOpt=document.createElement('option'); fOpt.value=doc.id; fOpt.textContent=name; filter.appendChild(fOpt);
    });
  });
}

function getSectionName(id){
  const select=document.getElementById('invoice-section-select');
  const opt=Array.from(select.options).find(o=>o.value===id);
  return opt ? opt.textContent : '';
}

// ===== Invoices =====
function saveInvoice(){
  const userId=auth.currentUser.uid;
  const sectionId=document.getElementById('invoice-section-select').value;
  if(!document.getElementById('invoice-store').value || !document.getElementById('invoice-date').value){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
    return;
  }
  const itemsEl=document.querySelectorAll('#items-container .invoice-item');
  if(itemsEl.length===0){alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}
  const items=[];
  itemsEl.forEach(item=>{
    items.push({
      name:item.children[0].value,
      quantity:parseFloat(item.children[1].value)||0,
      price:parseFloat(item.children[2].value)||0
    });
  });
  const invoiceData={
    section:sectionId,
    invoiceNumber:document.getElementById('invoice-number').value || "INV-" + Date.now(),
    store:document.getElementById('invoice-store').value,
    address:document.getElementById('invoice-address').value,
    phone:document.getElementById('invoice-phone').value,
    date:document.getElementById('invoice-date').value,
    currency:document.getElementById('invoice-currency').value,
    items,
    discount:parseFloat(document.getElementById('discount').value)||0,
    vat:parseFloat(document.getElementById('vat').value)||0,
    total:document.getElementById('total-display').textContent
  };
  const userInvoices=db.collection('users').doc(userId).collection('invoices');
  if(currentInvoiceId){
    userInvoices.doc(currentInvoiceId).update(invoiceData).then(()=>{alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");clearForm();});
  } else {
    userInvoices.add(invoiceData).then(()=>{alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©");clearForm();});
  }
}

// ===== Clear form =====
function clearForm(){
  document.getElementById('invoice-number').value="";
  document.getElementById('invoice-store').value="";
  document.getElementById('invoice-address').value="";
  document.getElementById('invoice-phone').value="";
  document.getElementById('invoice-date').value="";
  document.getElementById('items-container').innerHTML="";
  document.getElementById('discount').value="";
  document.getElementById('vat').value="";
  document.getElementById('total-display').textContent="0";
  currentInvoiceId=null;
}

// ===== Load & Display invoices =====
function loadInvoices(){
  const userId=auth.currentUser.uid;
  db.collection('users').doc(userId).collection('invoices').onSnapshot(snapshot=>{
    allInvoices=[];
    snapshot.forEach(doc=>{
      const data=doc.data();
      data.id=doc.id;
      allInvoices.push(data);
    });
    displayInvoices(allInvoices);
  });
}

function displayInvoices(list){
  const container=document.getElementById('invoice-list');
  container.innerHTML="";
  list.forEach(data=>{
    const card=document.createElement('div');
    card.className="invoice-card";
    card.innerHTML=`
      <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${data.invoiceNumber}</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${getSectionName(data.section)}</p>
      <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${data.date}</p>
      <p><strong>Ø§Ù„Ù…ØªØ¬Ø±:</strong> ${data.store}</p>
      <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${data.phone}</p>
      <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${data.total}</p>
      <p><strong>Ø§Ù„Ø®ØµÙ…:</strong> ${data.discount} ${data.currency}</p>
      <button onclick="toggleItems(this)">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
      <div class="items-list" style="display:none;">
        <ul class="item-list">
          ${data.items.map(item=>`<li>${item.name} - ${item.quantity} Ã— ${item.price} ${data.currency}</li>`).join('')}
        </ul>
      </div>
      <button onclick='editInvoice("${data.id}")'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button onclick='deleteInvoice("${data.id}")'>ğŸ—‘ Ø­Ø°Ù</button>`;
    container.appendChild(card);
  });
}

function toggleItems(btn){
  const div=btn.nextElementSibling;
  div.style.display = div.style.display==="none" ? "block" : "none";
}

document.getElementById('filter-section').addEventListener('change', function(){
  const sectionId=this.value;
  if(!sectionId) displayInvoices(allInvoices);
  else displayInvoices(allInvoices.filter(inv=>inv.section===sectionId));
});

document.getElementById('search-invoice').addEventListener('input', function(){
  const query=this.value.trim().toLowerCase();
  const filtered=allInvoices.filter(inv=>inv.invoiceNumber.toLowerCase().includes(query));
  displayInvoices(filtered);
});

// ===== Edit & Delete invoice =====
function editInvoice(id){
  const inv=allInvoices.find(i=>i.id===id);
  if(!inv) return;
  currentInvoiceId=id;
  document.getElementById('invoice-number').value=inv.invoiceNumber;
  document.getElementById('invoice-store').value=inv.store;
  document.getElementById('invoice-address').value=inv.address;
  document.getElementById('invoice-phone').value=inv.phone;
  document.getElementById('invoice-date').value=inv.date;
  document.getElementById('invoice-currency').value=inv.currency;
  document.getElementById('discount').value=inv.discount;
  document.getElementById('vat').value=inv.vat;
  const container=document.getElementById('items-container');
  container.innerHTML="";
  inv.items.forEach(item=>{
    const div=document.createElement('div');
    div.className="invoice-item";
    div.innerHTML=`
      <input value="${item.name}">
      <input type="number" value="${item.quantity}">
      <input type="number" value="${item.price}">
      <button onclick="this.parentNode.remove();calculateTotal();">âŒ</button>`;
    container.appendChild(div);
  });
  calculateTotal();
}

function deleteInvoice(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")){
    db.collection('users').doc(auth.currentUser.uid).collection('invoices').doc(id).delete();
  }
}

// ===== Export Excel =====
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(allInvoices.map(inv=>{
    return {
      "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©": inv.invoiceNumber,
      "Ø§Ù„Ù‚Ø³Ù…": getSectionName(inv.section),
      "Ø§Ù„Ù…ØªØ¬Ø±": inv.store,
      "Ø§Ù„Ù‡Ø§ØªÙ": inv.phone,
      "Ø§Ù„ØªØ§Ø±ÙŠØ®": inv.date,
      "Ø§Ù„Ø®ØµÙ…": inv.discount,
      "Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©": inv.vat,
      "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ": inv.total
    };
  }));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Invoices");
  XLSX.writeFile(wb,"Invoices.xlsx");
}
</script>

</body>
</html>
