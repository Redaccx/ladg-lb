<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Invoices System </title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #C1272D;
  --bg: #f6f7fb;
  --card: #fff;
}
* {box-sizing:border-box;}
body {margin:0;font-family:'Cairo',sans-serif;background:var(--bg);}
header {background:var(--primary);color:#fff;padding:16px;text-align:center;}
header h1 {margin:0;font-size:15px;}
main {padding:20px;max-width:1200px;margin:20px auto;text-align:center;}
.card, .invoice-card {background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:right;}
input, select {width:100%;padding:10px;margin:6px 0 12px;border-radius:8px;border:1px solid #ddd;text-align:center;}
button {padding:6px 10px;border:none;border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;margin:2px;transition:0.2s;}
button:hover {opacity:0.8;}
.invoice-item {display:flex;gap:10px;align-items:center;margin-bottom:8px;justify-content:center;}
.invoice-item input {flex:1;text-align:center;}
.item-list li {margin:2px 0;padding:4px 6px;background:#f4f4f4;border-radius:4px;}
.items-list {margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;}
#search-invoice, #filter-section {min-width:150px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center;}
#search-invoice:focus, #filter-section:focus {outline:none;border-color:var(--primary);box-shadow:0 0 4px rgba(193,39,45,0.5);}
@media(max-width:600px){
  .invoice-item {flex-direction:column;}
  #search-invoice, #filter-section {width:100%;margin-bottom:6px;}
  #auth-section, #invoice-section {
  display: none;
}
</style>
</head>
<body>

<header>
<h1> Invoices System </h1>
</header>

<main>
<div id="auth-section" class="card">
<h2>تسجيل الدخول</h2>
<input type="email" id="email" placeholder="البريد الإلكتروني">
<input type="password" id="password" placeholder="كلمة المرور">
<button onclick="login()">تسجيل الدخول</button>
<button onclick="resetPassword()">إعادة تعيين كلمة المرور</button>
<p id="auth-msg" style="color:red;"></p>
</div>

<div id="invoice-section" style="display:none;">
<div class="card">
<h2>إضافة / تعديل فاتورة</h2>
<select id="invoice-section-select"></select>
<button onclick="addSection()">➕ قسم</button>
<button onclick="editSection()">✏️ تعديل قسم</button>
<button onclick="deleteSection()">🗑 حذف قسم</button>

<input type="text" id="invoice-number" placeholder="رقم الفاتورة">
<input type="text" id="invoice-store" placeholder="المتجر / البائع">
<input type="text" id="invoice-address" placeholder="العنوان">
<input type="text" id="invoice-phone" placeholder="رقم الهاتف">
<input type="text" id="invoice-date" placeholder="أدخل التاريخ (YYYY-MM-DD)">

<select id="invoice-currency">
  <option value="USD">USD</option>
  <option value="LBP">LBP</option>
</select>

<div id="items-container"></div>
<button onclick="addItem()">➕ منتج</button>

<input type="number" id="discount" placeholder="خصم">
<input type="number" id="vat" placeholder="ضريبة (%)">
<p>الإجمالي: <span id="total-display">0</span></p>

<button onclick="saveInvoice()">💾 حفظ الفاتورة</button>
<button onclick="clearForm()">🆑 مسح الحقول</button>
<button onclick="logout()">تسجيل خروج</button>
<button onclick="exportExcel()">📥 تصدير Excel</button>
</div>

<div class="card">
<h2>قائمة الفواتير</h2>
<div style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
  <select id="filter-section">
    <option value="">كل الأقسام</option>
  </select>
  <input type="text" id="search-invoice" placeholder="ابحث برقم الفاتورة">
</div>
<div id="invoice-list" style="margin-top:10px;"></div>
</div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
 apiKey:"AIzaSyB4NzOcosALN-8oLzMM1ONXdi2R-SvZ_co",
 authDomain:"invoice-app-6345a.firebaseapp.com",
 projectId:"invoice-app-6345a",
 storageBucket:"invoice-app-6345a.firebasestorage.app",
 messagingSenderId:"289913191209",
 appId:"1:289913191209:web:2e64b56a2d549f7fa15538"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentInvoiceId=null;
let allInvoices=[];

// Add item
function addItem(){
  const container=document.getElementById('items-container');
  const div=document.createElement('div');
  div.className="invoice-item";
  div.innerHTML=`
    <input placeholder="اسم المنتج">
    <input type="number" placeholder="الكمية" value="1">
    <input type="number" placeholder="السعر" value="0">
    <button onclick="this.parentNode.remove();calculateTotal();">❌</button>`;
  container.appendChild(div);
  calculateTotal();
}

// Calculate total
function calculateTotal(){
  const items=document.querySelectorAll('#items-container .invoice-item');
  let total=0;
  items.forEach(item=>{
    const qty=parseFloat(item.children[1].value)||0;
    const price=parseFloat(item.children[2].value)||0;
    total += qty*price;
  });
  const discount=parseFloat(document.getElementById('discount').value)||0;
  const vat=parseFloat(document.getElementById('vat').value)||0;
  total = (total - discount) + (total * vat/100);
  const currency=document.getElementById('invoice-currency').value;
  document.getElementById('total-display').textContent = `${total.toFixed(2)} ${currency}`;
}

document.getElementById('items-container').addEventListener('input',calculateTotal);
document.getElementById('discount').addEventListener('input',calculateTotal);
document.getElementById('vat').addEventListener('input',calculateTotal);
document.getElementById('invoice-currency').addEventListener('change',calculateTotal);

// Save invoice
function saveInvoice(){
  const userId=auth.currentUser.uid;
  const sectionId=document.getElementById('invoice-section-select').value;
  if(!document.getElementById('invoice-store').value || !document.getElementById('invoice-date').value){
    alert("الرجاء إدخال اسم المتجر والتاريخ");
    return;
  }
  const itemsEl=document.querySelectorAll('#items-container .invoice-item');
  if(itemsEl.length===0){alert("أضف منتجاً واحداً على الأقل"); return;}
  const items=[];
  itemsEl.forEach(item=>{
    items.push({
      name:item.children[0].value,
      quantity:parseFloat(item.children[1].value)||0,
      price:parseFloat(item.children[2].value)||0
    });
  });
  const invoiceData={
    section:sectionId,
    invoiceNumber:document.getElementById('invoice-number').value || "INV-" + Date.now(),
    store:document.getElementById('invoice-store').value,
    address:document.getElementById('invoice-address').value,
    phone:document.getElementById('invoice-phone').value,
    date:document.getElementById('invoice-date').value,
    currency:document.getElementById('invoice-currency').value,
    items,
    discount:parseFloat(document.getElementById('discount').value)||0,
    vat:parseFloat(document.getElementById('vat').value)||0,
    total:document.getElementById('total-display').textContent
  };
  const userInvoices=db.collection('users').doc(userId).collection('invoices');
  if(currentInvoiceId){
    userInvoices.doc(currentInvoiceId).update(invoiceData).then(()=>{alert("تم تعديل الفاتورة");clearForm();});
  } else {
    userInvoices.add(invoiceData).then(()=>{alert("تمت إضافة الفاتورة");clearForm();});
  }
}

// Clear form
function clearForm(){
  document.getElementById('invoice-number').value="";
  document.getElementById('invoice-store').value="";
  document.getElementById('invoice-address').value="";
  document.getElementById('invoice-phone').value="";
  document.getElementById('invoice-date').value="";
  document.getElementById('items-container').innerHTML="";
  document.getElementById('discount').value="";
  document.getElementById('vat').value="";
  document.getElementById('total-display').textContent="0";
  currentInvoiceId=null;
}

// Load invoices
function loadInvoices(){
  const userId=auth.currentUser.uid;
  db.collection('users').doc(userId).collection('invoices').onSnapshot(snapshot=>{
    allInvoices=[];
    snapshot.forEach(doc=>{
      const data=doc.data();
      data.id=doc.id;
      allInvoices.push(data);
    });
    displayInvoices(allInvoices);
  });
}

// Display invoices
function displayInvoices(list){
  const container=document.getElementById('invoice-list');
  container.innerHTML="";
  list.forEach(data=>{
    const card=document.createElement('div');
    card.className="invoice-card";
    card.innerHTML=`
      <p><strong>رقم الفاتورة:</strong> ${data.invoiceNumber}</p>
      <p><strong>القسم:</strong> ${getSectionName(data.section)}</p>
      <p><strong>التاريخ:</strong> ${data.date}</p>
      <p><strong>المتجر:</strong> ${data.store}</p>
      <p><strong>الهاتف:</strong> ${data.phone}</p>
      <p><strong>الإجمالي:</strong> ${data.total}</p>
      <p><strong>الخصم:</strong> ${data.discount} ${data.currency}</p>
      <button onclick="toggleItems(this)">عرض المنتجات</button>
      <div class="items-list" style="display:none;">
        <ul class="item-list">
          ${data.items.map(item=>`<li>${item.name} - ${item.quantity} × ${item.price} ${data.currency}</li>`).join('')}
        </ul>
      </div>
      <button onclick='editInvoice("${data.id}")'>✏️ تعديل</button>
      <button onclick='deleteInvoice("${data.id}")'>🗑 حذف</button>`;
    container.appendChild(card);
  });
}

// Toggle items
function toggleItems(btn){
  const div=btn.nextElementSibling;
  div.style.display = div.style.display==="none" ? "block" : "none";
}

// Filter invoices by section
document.getElementById('filter-section').addEventListener('change', filterInvoices);
function filterInvoices(){
  const sectionId=document.getElementById('filter-section').value;
  if(!sectionId) displayInvoices(allInvoices);
  else displayInvoices(allInvoices.filter(inv=>inv.section===sectionId));
}

// Live search
document.getElementById('search-invoice').addEventListener('input', function(){
  const query=this.value.trim().toLowerCase();
  const filtered=allInvoices.filter(inv=>inv.invoiceNumber.toLowerCase().includes(query));
  displayInvoices(filtered);
});

// Edit/Delete
function editInvoice(id){
  const userId=auth.currentUser.uid;
  db.collection('users').doc(userId).collection('invoices').doc(id).get().then(doc=>{
    if(doc.exists){
      const data=doc.data();
      document.getElementById('invoice-number').value=data.invoiceNumber;
      document.getElementById('invoice-store').value=data.store;
      document.getElementById('invoice-address').value=data.address;
      document.getElementById('invoice-phone').value=data.phone;
      document.getElementById('invoice-date').value=data.date;
      document.getElementById('discount').value=data.discount;
      document.getElementById('vat').value=data.vat;
      document.getElementById('invoice-currency').value=data.currency;
      document.getElementById('items-container').innerHTML="";
      data.items.forEach(item=>{
        const div=document.createElement('div');
        div.className="invoice-item";
        div.innerHTML=`<input value="${item.name}">
                         <input type="number" value="${item.quantity}">
                         <input type="number" value="${item.price}">
                         <button onclick="this.parentNode.remove();calculateTotal();">❌</button>`;
        document.getElementById('items-container').appendChild(div);
      });
      calculateTotal();
      currentInvoiceId=id;
    }
  });
}
function deleteInvoice(id){
  if(confirm("هل تريد حذف هذه الفاتورة؟")){
    const userId=auth.currentUser.uid;
    db.collection('users').doc(userId).collection('invoices').doc(id).delete();
  }
}

// Auth
function login(){ 
  const email=document.getElementById('email').value; 
  const password=document.getElementById('password').value; 
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>{ document.getElementById('auth-msg').textContent=""; loadInvoices(); loadSections(); document.getElementById('auth-section').style.display="none"; document.getElementById('invoice-section').style.display="block";})
    .catch(e=>document.getElementById('auth-msg').textContent=e.message);
}
function resetPassword(){ 
  const email=document.getElementById('email').value; 
  auth.sendPasswordResetEmail(email).then(()=>alert("تم إرسال البريد")).catch(e=>alert(e.message));
}
auth.onAuthStateChanged(user=>{
  if(user){ document.getElementById('auth-section').style.display="none"; document.getElementById('invoice-section').style.display="block"; loadSections(); loadInvoices();}
  else{ document.getElementById('auth-section').style.display="block"; document.getElementById('invoice-section').style.display="none";}
});
function logout(){ auth.signOut(); }

// Sections
function addSection(){ const name=prompt("أدخل اسم القسم:"); if(!name) return; db.collection('users').doc(auth.currentUser.uid).collection('sections').add({name});}
function editSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("اختر قسم للتعديل"); const newName=prompt("الاسم الجديد:"); if(newName) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).update({name:newName});}
function deleteSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("اختر قسم للحذف"); if(confirm("هل تريد الحذف؟")) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).delete();}
function loadSections(){ 
  const select=document.getElementById('invoice-section-select'); 
  const filter=document.getElementById('filter-section');
  db.collection('users').doc(auth.currentUser.uid).collection('sections').get().then(snapshot=>{
    select.innerHTML="";
    filter.innerHTML = '<option value="">كل الأقسام</option>';
    snapshot.forEach(doc=>{
      const name = doc.data().name;
      const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=name; select.appendChild(opt);
      const fOpt=document.createElement('option'); fOpt.value=doc.id; fOpt.textContent=name; filter.appendChild(fOpt);
    });
  });
}

function getSectionName(id){
  const select=document.getElementById('invoice-section-select');
  const opt=Array.from(select.options).find(o=>o.value===id);
  return opt ? opt.textContent : '';
}

// Export Excel
function exportExcel(){
  const table=document.querySelector('#invoice-list').parentNode;
  const wb=XLSX.utils.table_to_book(table,{sheet:"Invoices"});
  XLSX.writeFile(wb,"Invoices.xlsx");
}
</script>
</body>
</html>
