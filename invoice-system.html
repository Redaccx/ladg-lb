<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #C1272D;
  --bg: #f6f7fb;
  --card: #fff;
}
* {box-sizing:border-box;}
body {margin:0;font-family:'Cairo',sans-serif;background:var(--bg);}
header {background:var(--primary);color:#fff;padding:16px;text-align:center;}
header h1 {margin:0;font-size:15px;}
main {padding:20px;max-width:1200px;margin:20px auto;text-align:center;}
.card {background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;min-width:320px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
input, select {width:100%;padding:10px;margin:6px 0 12px;border-radius:8px;border:1px solid #ddd;text-align:center;}
button {padding:8px 12px;border:none;border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;margin:2px;transition:0.2s;}
button:hover {opacity:0.8;}
.invoice-item {display:flex;gap:10px;align-items:center;margin-bottom:8px;justify-content:center;}
.invoice-item input {flex:1;text-align:center;}
.table-wrapper {overflow-x:auto; -webkit-overflow-scrolling: touch; margin-top:10px;}
table {width:100%;border-collapse:collapse;margin-top:20px;text-align:center;min-width:600px;}
th, td {border:1px solid #ddd;padding:10px;font-size:14px;}
th {background:var(--primary);color:#fff;}
@media(max-width:600px){
  .invoice-item {flex-direction:column;}
  table th, table td {font-size:12px; min-width:100px;}
}
</style>
</head>
<body>

<header>
<h1>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</h1>
</header>

<main>
<div id="auth-section" class="card">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
<button onclick="resetPassword()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
<p id="auth-msg" style="color:red;"></p>
</div>

<div id="invoice-section" style="display:none;">
<div class="card">
<h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</h2>
<select id="invoice-section-select"></select>
<button onclick="addSection()">â• Ù‚Ø³Ù…</button>
<button onclick="editSection()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…</button>
<button onclick="deleteSection()">ğŸ—‘ Ø­Ø°Ù Ù‚Ø³Ù…</button>

<input type="text" id="invoice-number" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
<input type="text" id="invoice-store" placeholder="Ø§Ù„Ù…ØªØ¬Ø± / Ø§Ù„Ø¨Ø§Ø¦Ø¹">
<input type="text" id="invoice-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
<input type="text" id="invoice-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input type="text" id="invoice-date" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD)">
<select id="currency"></select>

<div id="items-container"></div>
<button onclick="addItem()">â• Ù…Ù†ØªØ¬</button>

<input type="number" id="discount" placeholder="Ø®ØµÙ…" value="0">
<input type="number" id="vat" placeholder="Ø¶Ø±ÙŠØ¨Ø© (%)" value="11">
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-display">0</span> <span id="currency-display"></span></p>

<button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
<button onclick="clearForm()">ğŸ†‘ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
<button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
<button onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div class="card">
<h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø§Ù„Ù…ØªØ¬Ø±</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
<th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="invoice-list"></tbody>
</table>
</div>
</div>
</div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
apiKey:"AIzaSyB4NzOcosALN-8oLzMM1ONXdi2R-SvZ_co",
authDomain:"invoice-app-6345a.firebaseapp.com",
projectId:"invoice-app-6345a",
storageBucket:"invoice-app-6345a.firebasestorage.app",
messagingSenderId:"289913191209",
appId:"1:289913191209:web:2e64b56a2d549f7fa15538"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentInvoiceId=null;
let exchangeRates={};
const currencies=["LBP","USD","EUR","CHF","ITL"];
const currencySelect=document.getElementById('currency');
currencies.forEach(c=>{let opt=document.createElement('option'); opt.value=c; opt.textContent=c; currencySelect.appendChild(opt);});
document.getElementById('currency-display').textContent=currencySelect.value;

// Load exchange rates
async function loadExchangeRates(){
  try{
    const res=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=LBP,EUR,CHF,ITL');
    const data=await res.json();
    exchangeRates=data.rates;
  }catch(err){console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù:",err);}
}
loadExchangeRates();

// Calculate total
function calculateTotal(){
  const items=document.querySelectorAll('#items-container .invoice-item');
  let totalUSD=0;
  items.forEach(item=>{
    const qty=parseFloat(item.children[1].value)||0;
    const price=parseFloat(item.children[2].value)||0;
    totalUSD+=qty*price;
  });
  const discount=parseFloat(document.getElementById('discount').value)||0;
  const vat=parseFloat(document.getElementById('vat').value)||0;
  totalUSD=totalUSD-discount+(totalUSD*vat/100);
  const currency=document.getElementById('currency').value;
  let total=totalUSD;
  if(currency!=="USD"){ total=totalUSD*exchangeRates[currency]; }
  document.getElementById('total-display').textContent=total.toFixed(2);
  document.getElementById('currency-display').textContent=currency;
}

currencySelect.addEventListener('change',calculateTotal);
document.getElementById('discount').addEventListener('input',calculateTotal);
document.getElementById('vat').addEventListener('input',calculateTotal);

// Add item
function addItem(){
  const container=document.getElementById('items-container');
  const div=document.createElement('div');
  div.className="invoice-item";
  div.innerHTML=`<input placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"><input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1"><input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="0"><button onclick="this.parentNode.remove();calculateTotal();">âŒ</button>`;
  container.appendChild(div);
  calculateTotal();
}
document.getElementById('items-container').addEventListener('input',calculateTotal);

// Save invoice
function saveInvoice(){
  const userId=auth.currentUser.uid;
  const sectionId=document.getElementById('invoice-section-select').value;
  if(!document.getElementById('invoice-store').value || !document.getElementById('invoice-date').value){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
    return;
  }
  const itemsEl=document.querySelectorAll('#items-container .invoice-item');
  if(itemsEl.length===0){alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}
  const items=[];
  itemsEl.forEach(item=>{
    items.push({name:item.children[0].value,quantity:parseFloat(item.children[1].value)||0,price:parseFloat(item.children[2].value)||0});
  });
  let invoiceData={
    section:sectionId,
    invoiceNumber:document.getElementById('invoice-number').value || "INV-" + Date.now(),
    store:document.getElementById('invoice-store').value,
    address:document.getElementById('invoice-address').value,
    phone:document.getElementById('invoice-phone').value,
    date:document.getElementById('invoice-date').value,
    items,
    discount:parseFloat(document.getElementById('discount').value)||0,
    vat:parseFloat(document.getElementById('vat').value)||0,
    total:parseFloat(document.getElementById('total-display').textContent)||0,
    currency:document.getElementById('currency').value
  };
  if(currentInvoiceId){
    db.collection('users').doc(userId).collection('invoices').doc(currentInvoiceId).update(invoiceData).then(()=>{alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");clearForm();});
  } else {
    db.collection('users').doc(userId).collection('invoices').add(invoiceData).then(()=>{alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©");clearForm();});
  }
}

// Clear form
function clearForm(){
  document.getElementById('invoice-number').value="";
  document.getElementById('invoice-store').value="";
  document.getElementById('invoice-address').value="";
  document.getElementById('invoice-phone').value="";
  document.getElementById('invoice-date').value="";
  document.getElementById('items-container').innerHTML="";
  document.getElementById('discount').value="0";
  document.getElementById('vat').value="11";
  document.getElementById('total-display').textContent="0";
  document.getElementById('currency').value="USD";
  currentInvoiceId=null;
}

// Load invoices
function loadInvoices(){
  const userId=auth.currentUser.uid;
  db.collection('users').doc(userId).collection('invoices').onSnapshot(snapshot=>{
    const list=document.getElementById('invoice-list');
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${data.invoiceNumber}</td><td>${data.date}</td><td>${data.store}</td><td>${data.phone}</td><td>${data.total.toFixed(2)}</td><td>${data.currency}</td>
      <td><button onclick='editInvoice("${doc.id}")'>âœï¸</button><button onclick='deleteInvoice("${doc.id}")'>ğŸ—‘</button></td>`;
      list.appendChild(tr);
    });
  });
}

// Edit/Delete invoice
function editInvoice(id){
  const userId=auth.currentUser.uid;
  db.collection('users').doc(userId).collection('invoices').doc(id).get().then(doc=>{
    if(doc.exists){
      const data=doc.data();
      document.getElementById('invoice-number').value=data.invoiceNumber;
      document.getElementById('invoice-store').value=data.store;
      document.getElementById('invoice-address').value=data.address;
      document.getElementById('invoice-phone').value=data.phone;
      document.getElementById('invoice-date').value=data.date;
      document.getElementById('discount').value=data.discount;
      document.getElementById('vat').value=data.vat;
      document.getElementById('currency').value=data.currency;
      document.getElementById('items-container').innerHTML="";
      data.items.forEach(item=>{
        const div=document.createElement('div');
        div.className="invoice-item";
        div.innerHTML=`<input value="${item.name}"><input type="number" value="${item.quantity}"><input type="number" value="${item.price}"><button onclick="this.parentNode.remove();calculateTotal();">âŒ</button>`;
        document.getElementById('items-container').appendChild(div);
      });
      calculateTotal();
      currentInvoiceId=id;
    }
  });
}
function deleteInvoice(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")){
    const userId=auth.currentUser.uid;
    db.collection('users').doc(userId).collection('invoices').doc(id).delete();
  }
}

// Auth
function login(){ const email=document.getElementById('email').value; const password=document.getElementById('password').value; auth.signInWithEmailAndPassword(email,password).then(()=>{document.getElementById('auth-msg').textContent=""; loadInvoices(); loadSections();}).catch(e=>document.getElementById('auth-msg').textContent=e.message);}
function resetPassword(){ const email=document.getElementById('email').value; auth.sendPasswordResetEmail(email).then(()=>alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯")).catch(e=>alert(e.message));}
auth.onAuthStateChanged(user=>{ if(user){ document.getElementById('auth-section').style.display="none"; document.getElementById('invoice-section').style.display="block"; loadSections(); loadInvoices(); } else { document.getElementById('auth-section').style.display="block"; document.getElementById('invoice-section').style.display="none"; } });
function logout(){ auth.signOut(); }

// Sections
function addSection(){ const name=prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:"); if(!name) return; db.collection('users').doc(auth.currentUser.uid).collection('sections').add({name});}
function editSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„"); const newName=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:"); if(newName) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).update({name:newName});}
function deleteSection(){ const select=document.getElementById('invoice-section-select'); if(!select.value) return alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ù„Ø­Ø°Ù"); if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) db.collection('users').doc(auth.currentUser.uid).collection('sections').doc(select.value).delete();}
function loadSections(){ const select=document.getElementById('invoice-section-select'); db.collection('users').doc(auth.currentUser.uid).collection('sections').get().then(snapshot=>{ select.innerHTML=""; snapshot.forEach(doc=>{ const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=doc.data().name; select.appendChild(opt); });});}

// Export Excel
function exportExcel(){
  const table=document.querySelector('#invoice-list').parentNode;
  const wb=XLSX.utils.table_to_book(table,{sheet:"Invoices"});
  XLSX.writeFile(wb,"Invoices.xlsx");
}
window.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem("mainAccess") !== "true") {
        window.location.href = "system"; 
        return;
    }

    // Ø¥Ø°Ø§ Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠÙØªØ­ â†’ ØµÙØ­Ø© Ù…Ù‚ÙÙˆÙ„Ø©
    if (!sessionStorage.getItem("refreshedOnce")) {
        sessionStorage.setItem("refreshedOnce", "true");
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Reload the page to access Payroll System</h2>";
    } 
    // Ø¥Ø°Ø§ Ø¹Ù…Ù„ Refresh â†’ ÙŠØ¨ÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
});

  
</script>
</body>
</html>
