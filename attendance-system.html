<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance System - Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:"Segoe UI", Tahoma, sans-serif; background:#f4f6f9; margin:0; padding:0; text-align:center; overflow-x:hidden;}
header { background:#2c3e50; color:white; padding:15px; font-size:20px;}
main { padding:20px; max-width:1000px; margin:auto;}
input, select { padding:10px; width:97%; max-width:200px; border:1px solid #ccc; border-radius:5px; margin-bottom:10px; font-size:14px;}
#passwordContainer{position:relative; width:100%; max-width:200px; margin:auto;}
#togglePass{position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; width:25px; height:25px; background:url('https://img.icons8.com/ios/50/000000/visible--v1.png') no-repeat center center; background-size:contain;}
button { padding:10px 18px; margin:5px; cursor:pointer; border:none; border-radius:5px; font-size:14px; transition:0.3s;}
button:hover{opacity:0.85;}
.in{background:#27ae60;color:white;} /* حاضر */
.out{background:#e74c3c;color:white;} /* غائب */
.edit{background:#f39c12;color:white;} /* تعديل */
.delete{background:#c0392b;color:white;} /* حذف */
.excel{background:#2980b9;color:white;}
.logout{background:#8e44ad;color:white;}
.resetPass{background:#f39c12;color:white;}
.login{background:#34495e;color:white;}
table{width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0px 2px 6px rgba(0,0,0,0.1);}
th, td{border:1px solid #ddd; padding:12px; text-align:center; font-size:14px;}
th{background:#34495e;color:white;}
.status-hadir{color:#27ae60;font-weight:bold;}
.status-ghayeb{color:#e74c3c;font-weight:bold;}
#loginPage, #app{display:none;}
.login-container{background:white; padding:35px; border-radius:5px; box-shadow:0 2px 8px rgba(0,0,0,0.2); display:inline-block; margin-top:50px; width:50%; max-width:400px;}
#searchBox{width:90%; max-width:300px; padding:8px 12px; font-size:14px; margin-top:10px;}
.table-container{overflow-x:auto;}
@media (max-width:768px){input,select{width:95%;} button{width:95%; margin:5px 0;} table, th, td{font-size:12px;}}
</style>
</head>
<body>

<header>📋 Attendance System</header>

<!-- Login Page -->
<div id="loginPage">
  <div class="login-container">
    <h2>🔑 Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <div id="passwordContainer">
      <input type="password" id="password" placeholder="Password"><br>
      <div id="togglePass"></div>
    </div>
    <button class="login" onclick="login()">Login</button><br>
    <button class="resetPass" onclick="resetPassword()">Reset Password</button>
  </div>
</div>

<!-- App Page -->
<div id="app">
<main>
<button class="logout" onclick="logout()">🚪 Logout</button>

<div class="controls">
  <select id="employeeSelect"></select><br>
  <button class="in" onclick="markPresent()">✅ حاضر</button>
  <button class="out" onclick="markAbsent()">❌ غائب</button>
  <button class="excel" onclick="exportExcel()">📊 Export Excel</button>
</div>

<div>
  <input type="text" id="searchBox" placeholder="🔍 Search by Name or ID" onkeyup="searchRecords()">
</div>

<h2>📑 Records</h2>
<div class="table-container">
<table id="attendanceTable">
<tr>
<th>ID</th><th>Name</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Status</th><th>Actions</th>
</tr>
</table>
</div>
</main>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDN5lTsnyfIombF5mYhNOeppcPgLMBRX1c",
  authDomain: "my-lebanons-app.firebaseapp.com",
  projectId: "my-lebanons-app",
  storageBucket: "my-lebanons-app.firebasestorage.app",
  messagingSenderId: "1025400869383",
  appId: "1:1025400869383:web:9f58b59ce4e018849650a2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Employees list
let employees = [
  { id: "123-456-7907", name: "ميس السلوم" },
  { id: "123-456-7906", name: "علي جعفر" },
  { id: "123-456-7905", name: "وعد الأحمد" },
  { id: "123-456-7904", name: "أنور نمر" },
  { id: "123-456-7903", name: "محسن يوسف" },
  { id: "123-456-7902", name: "جمعة المحمد" },
  { id: "123-456-7901", name: "هادي جعفر" },
  { id: "123-456-7899", name: "محمد جعفر" },
  { id: "123-456-7898", name: "غدير مصطفى" },
  { id: "123-456-7897", name: "إلسي عبد الساتر" },
  { id: "123-456-7895", name: "نور نبها" },
  { id: "123-456-7894", name: "جاد نبها" },
  { id: "123-456-7892", name: "هادي عبد الساتر" },
  { id: "123-456-7891", name: "رضا الجمعة" }
];

// Toggle password visibility
let passVisible = false;
document.getElementById("togglePass").addEventListener("click", ()=>{
  const pass = document.getElementById("password");
  passVisible = !passVisible;
  pass.type = passVisible ? "text" : "password";
  document.getElementById("togglePass").style.backgroundImage = passVisible 
    ? "url('https://img.icons8.com/ios/50/000000/closed-eye.png')" 
    : "url('https://img.icons8.com/ios/50/000000/visible--v1.png')";
});

// Auth state
auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadEmployees();
    loadData();
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("app").style.display = "none";
  }
});

// Login
function login(){
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  auth.signInWithEmailAndPassword(email,password)
    .catch(err=>alert("⚠️ "+err.message));
}

// Reset Password
function resetPassword(){
  const email = document.getElementById("email").value.trim();
  if(!email){ return alert("⚠️ أدخل البريد الإلكتروني لإرسال رابط إعادة التعيين"); }
  auth.sendPasswordResetEmail(email)
    .then(()=>{ alert("✅ تم إرسال رابط إعادة تعيين كلمة المرور"); })
    .catch(err=>alert("⚠️ "+err.message));
}

// Logout
function logout(){ auth.signOut(); }

// Load employees
function loadEmployees(){
  const sel = document.getElementById("employeeSelect");
  sel.innerHTML="";
  employees.forEach(emp=>{
    const opt=document.createElement("option");
    opt.value=emp.id;
    opt.textContent=`${emp.id} - ${emp.name}`;
    sel.appendChild(opt);
  });
}

// Format date
function formatDate(dateStr){
  const d=new Date(dateStr);
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}

// Load data
function loadData(){
  db.collection("attendance").orderBy("date","desc").get().then(snapshot=>{
    const table=document.getElementById("attendanceTable");
    table.innerHTML=`<tr>
      <th>ID</th><th>Name</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Status</th><th>Actions</th>
      </tr>`;
    snapshot.forEach(doc=>{
      const r=doc.data();
      const row=table.insertRow();
      row.insertCell(0).innerText=r.id;
      row.insertCell(1).innerText=r.name;
      row.insertCell(2).innerText=formatDate(r.date);
      row.insertCell(3).innerText=r.checkin?r.checkin:"-";
      row.insertCell(4).innerText=r.checkout?r.checkout:"-";
      const st=row.insertCell(5);
      st.innerText=r.status;
      st.className=r.status==="حاضر"?"status-hadir":"status-ghayeb";
      const actions=row.insertCell(6);
      actions.innerHTML=`<button class="edit" onclick="editRecord('${doc.id}')">✏️ تعديل</button>
                         <button class="delete" onclick="deleteRecord('${doc.id}')">🗑️ حذف</button>`;
    });
  });
}

// Mark Present / Absent
function markPresent(){
  const id=document.getElementById("employeeSelect").value;
  const emp=employees.find(e=>e.id===id);
  const now=new Date();
  db.collection("attendance").add({
    id: emp.id,
    name: emp.name,
    date: now.toISOString(),
    checkin: new Date().toLocaleTimeString("en-GB"),
    checkout: "-",
    status: "حاضر"
  }).then(()=>loadData());
}
function markAbsent(){
  const id=document.getElementById("employeeSelect").value;
  const emp=employees.find(e=>e.id===id);
  const now=new Date();
  db.collection("attendance").add({
    id: emp.id,
    name: emp.name,
    date: now.toISOString(),
    checkin: "-",
    checkout: "-",
    status: "غائب"
  }).then(()=>loadData());
}

// Edit record
function editRecord(docId){
  db.collection("attendance").doc(docId).get().then(doc=>{
    const r=doc.data();
    const newStatus=prompt("حالة الموظف (حاضر/غائب):", r.status);
    if(newStatus){
      const newCheckIn=newStatus==="حاضر"?prompt("وقت الحضور HH:MM", r.checkin):"-";
      const newCheckOut=newStatus==="حاضر"?prompt("وقت الانصراف HH:MM", r.checkout):"-";
      const newDate=prompt("تاريخ اليوم DD/MM/YYYY:", formatDate(r.date));
      const parts=newDate.split("/");
      const isoDate=new Date(parts[2],parts[1]-1,parts[0]).toISOString();
      db.collection("attendance").doc(docId).update({
        status:newStatus,
        checkin:newCheckIn,
        checkout:newCheckOut,
        date:isoDate
      }).then(()=>loadData());
    }
  });
}

// Delete record
function deleteRecord(docId){
  if(confirm("هل أنت متأكد من حذف هذا السجل؟")){
    db.collection("attendance").doc(docId).delete().then(()=>loadData());
  }
}

// Export Excel
function exportExcel(){
  db.collection("attendance").get().then(snapshot=>{
    const data=[];
    snapshot.forEach(doc=>{
      const r=doc.data();
      data.push({
        ID:r.id,
        Name:r.name,
        Date:formatDate(r.date),
        "Check In":r.checkin,
        "Check Out":r.checkout,
        Status:r.status
      });
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Records");
    XLSX.writeFile(wb,"attendance.xlsx");
  });
}

// Search
function searchRecords(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  const table=document.getElementById("attendanceTable");const tr=table.getElementsByTagName("tr");
  for(let i=1;i<tr.length;i++){
    let td0=tr[i].getElementsByTagName("td")[0];let td1=tr[i].getElementsByTagName("td")[1];
    if(td0&&td1){let txt=(td0.textContent+td1.textContent).toLowerCase();tr[i].style.display=txt.includes(q)?"":"none";}
  }
}
</script>
</body>
</html>
