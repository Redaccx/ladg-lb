<<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing:border-box; }

body {
  margin: 0;
  padding: 0;
  font-family: 'Cairo', sans-serif;
  background: #f4f6f9;
  text-align:center;
  height: 100%;
  
}
main {
  padding-top: 0;
  padding-bottom: 0;
  margin-top: 0;
  margin-bottom: 0;
}

header { background:#C1272D; color:white; padding:15px; font-size:20px; font-weight:bold; }
main { padding:20px; max-width:1000px; margin:auto; }
input, select { padding:10px; width:97%; max-width:200px; border:1px solid #ccc; border-radius:5px; margin-bottom:10px; font-size:14px; }
input:focus, select:focus { border-color:#2980b9; outline:none; }
button { padding:8px 16px; margin:5px; cursor:pointer; border:none; border-radius:5px; font-size:13px; transition:0.3s; }
button:hover { opacity:0.85; }
.in{background:#27ae60;color:white;} 
.out{background:#e74c3c;color:white;} 
.present{background:#2ecc71;color:white;} 
.edit{background:#f39c12;color:white;} 
.delete{background:#c0392b;color:white;} 
.excel{background:#2980b9;color:white;}
.logout{background:#8e44ad;color:white;}
.resetPass{background:#000;color:white;}
.login{background:#C1272D;color:white;}
.add { background:#16a085; color:white; }
.add:hover { opacity:0.85; }
/* === Table === */
table{width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0px 2px 6px rgba(0,0,0,0.1);}
th, td{border:1px solid #ddd; padding:7px; text-align:center; font-size:12px; max-width:250px; word-break:break-word;}
th{background:#34495e;color:white;}
.status-hadir{color:#27ae60;font-weight:bold;}
.status-ghayeb{color:#e74c3c;font-weight:bold;}
.table-container{overflow-x:auto; white-space:nowrap;}
#loginPage, #app{display:none;}
.login-container{background:white; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); display:inline-block; margin-top:50px; width:90%; max-width:400px; text-align:center; }
.login-container h2{margin-bottom:20px;}
.password-wrapper{position:relative; width:100%; max-width:200px; margin:auto;}
.password-wrapper input{width:100%; padding-right:50px;}
.toggle-pass{position:absolute; right:-10px; top:-20%; height:100%; cursor:pointer; font-size:14px; background:none; border:none;}
#searchBox{width:90%; max-width:300px; padding:8px 12px; font-size:14px; margin-top:10px;}

/* ===== Loader Styles ===== */
#loadingOverlay {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: #ffffff;
  display:flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index:1000;
  font-family:"Segoe UI", Tahoma, sans-serif;
  color:#C1272D;
}

#loadingOverlay p {
  margin-top:20px;
  font-size:18px;
  letter-spacing:1px;
  font-weight:600;
}

.loader {
  display: flex;
  gap:15px;
}

.loader div {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #C1272D;
  box-shadow: 0 0 10px #C1272D, 0 0 20px #e74c3c, 0 0 30px #ff6f61;
  animation: bounce 0.8s infinite alternate ease-in-out, glow 1.2s infinite alternate;
}

.loader div:nth-child(2) { 
  animation-delay: 0.2s; 
  background:#e74c3c; 
  box-shadow: 0 0 10px #e74c3c, 0 0 20px #ff6f61, 0 0 30px #C1272D;
}
.loader div:nth-child(3) { 
  animation-delay: 0.4s; 
  background:#ff6f61; 
  box-shadow: 0 0 10px #ff6f61, 0 0 20px #C1272D, 0 0 30px #e74c3c;
}

@keyframes bounce {
  0% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-25px) scale(1.2); }
  100% { transform: translateY(0) scale(1); }
}

@keyframes glow {
  0% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }
  50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; }
  100% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }
}


.day-box {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
  padding: 10px;
}
.day-header {
  background: #C1272D;
  color: #fff;
  font-weight: bold;
  padding: 10px;
  border-radius: 6px;
  text-align: center;
  margin-bottom: 10px;
}
.deleteAll {
  background:#000;
  color:white;
}
.deleteAll:hover {
  opacity:0.8;
}
</style>
</head>
<body>

<header>Attendance System</header>

<!-- ===== Loader Overlay ===== -->
<div id="loadingOverlay">
  <div class="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <p>Loading data...</p>
</div>

<div id="loginPage">
  <div class="login-container">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <div class="password-wrapper">
      <input type="password" id="password" placeholder="Password">
      <button class="toggle-pass" id="togglePass">Show</button>
    </div>
    <button class="login" onclick="login()">Login</button><br>
    <button class="resetPass" onclick="resetPassword()">Reset Password</button>
  </div>
</div>

<div id="app">
<main>
<button class="logout" onclick="logout()">Logout</button>
<div class="controls">
    <select id="employeeSelect"></select>
    <button class="in" onclick="manualCheckIn()">Check In</button>
    <button class="out" onclick="manualCheckOut()">Check Out</button>
    <button class="excel" onclick="exportExcel()">Export Excel</button>
    <button class="add" onclick="addEmployee()">Ôºã Add Employee</button>
    <button class="delete" onclick="deleteEmployee()">Delete Employee</button>
    <button class="deleteAll" onclick="deleteAllData()">üóëÔ∏è Delete All Records</button>
    
  
</div>
<!-- üîç ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
<div class="filters" style="margin:20px 0;">
    <label><b>üóìÔ∏è ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™:</b></label>
    <select id="filterSelect" onchange="applyFilter()" style="padding:8px 12px; border-radius:5px; margin-right:10px;">
        <option value="all">ŸÉŸÑ ÿßŸÑÿ£ŸäÿßŸÖ</option>
        <option value="today">ÿßŸÑŸäŸàŸÖ</option>
        <option value="yesterday">ÿ£ŸÖÿ≥</option>
        <option value="week">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</option>
        <option value="month">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</option>
    </select>
    
    <label style="margin-left:20px;"><b>üìÖ ÿ™ÿßÿ±ŸäÿÆ ŸÖÿ≠ÿØÿØ:</b></label>
    <input type="date" id="dateFilter" onchange="filterByDate()" style="padding:8px 12px; border-radius:5px;">
    
    <button onclick="clearFilters()" style="padding:8px 14px; background:#555; color:white; border:none; border-radius:5px; margin-left:10px;">ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>

<div>
  <input type="text" id="searchBox" placeholder="Search by Name or ID" onkeyup="searchRecords()">
</div>

<h2>Records</h2>
<div class="table-container">
<table id="attendanceTable">
<tr>
<th>ID</th><th>Name</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Work Hours</th><th>Status</th><th>Actions</th>
</tr>
</table>
</div>
</main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyDVbS9U5qVC4DSk326d0ljW6ETGkyHVLUQ",
  authDomain: "ladg-attendance.firebaseapp.com",
  projectId: "ladg-attendance",
  storageBucket: "ladg-attendance.firebasestorage.app",
  messagingSenderId: "499991014945",
  appId: "1:499991014945:web:e4cd793de709191a157d60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const loader = document.getElementById("loadingOverlay");

// ===== Auth listener =====
auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    loader.style.display = "flex"; 
    loadEmployees().then(()=>{}); 
    loadData().then(()=>{ loader.style.display="none"; }); 
  } else {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("app").style.display = "none";
    loader.style.display = "none"; 
  }
});

// ===== Auth functions =====
function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}
function logout(){ auth.signOut(); }
function resetPassword(){
  const email=document.getElementById("email").value.trim();
  if(!email){alert("Enter your email"); return;}
  auth.sendPasswordResetEmail(email).then(()=>alert("Reset link sent")).catch(err=>alert(err.message));
}

// ===== Employees =====
async function loadEmployees(){
  const sel=document.getElementById("employeeSelect"); sel.innerHTML="";
  const snapshot = await db.collection("employees").get();
  snapshot.forEach(doc=>{
    const e=doc.data();
    const opt=document.createElement("option");
    opt.value=doc.id;
    opt.textContent=`${doc.id} - ${e.name}`;
    sel.appendChild(opt);
  });
}

// ===== Attendance =====
function formatDate(dateStr){
  const d=new Date(dateStr);
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}
function calculateWorkHours(checkin, checkout, date){
  if(!checkin || !checkout || checkout==='-') return '-';
  const inParts=checkin.split(':').map(Number);
  const outParts=checkout.split(':').map(Number);
  const inDate=new Date(date); inDate.setHours(inParts[0],inParts[1],0,0);
  const outDate=new Date(date); outDate.setHours(outParts[0],outParts[1],0,0);
  const diffMs=outDate-inDate;
  const diffH=Math.floor(diffMs/3600000);
  const diffM=Math.floor((diffMs%3600000)/60000);
  return `${diffH}h ${diffM}m`;
}

async function loadData() {
    const container = document.querySelector(".table-container");
    container.innerHTML = "";
    
    const snapshot = await db.collection("attendance").orderBy("date", "desc").get();
    
    // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    const grouped = {};
    snapshot.forEach(doc => {
        const r = doc.data();
        const dateKey = formatDate(r.date);
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push({ id: doc.id, ...r });
    });
    
    if (Object.keys(grouped).length === 0) {
        container.innerHTML = `<p style="text-align:center;margin-top:30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£Ÿä ÿ≥ÿ¨ŸÑÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã.</p>`;
        return;
    }
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿßŸÑŸäŸàŸÖŸäÿ©
    Object.keys(grouped).forEach(date => {
        const box = document.createElement("div");
        box.className = "day-box";
        
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = `üìÖ ${date}`;
        box.appendChild(header);
        
        const table = document.createElement("table");
        table.innerHTML = `
      <tr>
        <th>ID</th><th>Name</th><th>Date</th>
        <th>Check In</th><th>Check Out</th>
        <th>Work Hours</th><th>Status</th><th>Actions</th>
      </tr>`;
        
        grouped[date].forEach(r => {
            const row = table.insertRow();
            row.insertCell(0).innerText = r.id;
            row.insertCell(1).innerText = r.name;
            row.insertCell(2).innerText = date;
            row.insertCell(3).innerText = r.checkin || "-";
            row.insertCell(4).innerText = r.checkout || "-";
            row.insertCell(5).innerText = calculateWorkHours(r.checkin, r.checkout, r.date);
            const st = row.insertCell(6);
            st.innerText = r.status;
            st.className = r.status === "ÿ≠ÿßÿ∂ÿ±" ? "status-hadir" : "status-ghayeb";
            const actions = row.insertCell(7);
            actions.innerHTML = `
        <button class="present" onclick="toggleStatus('${r.id}','${r.status}')">Status</button>
        <button class="edit" onclick="editRecord('${r.id}')">Edit</button>
        <button class="delete" onclick="deleteRecord('${r.id}')">Delete</button>`;
        });
        
        box.appendChild(table);
        container.appendChild(box);
    });
}


// ===== ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ =====
function applyFilter() {
    const filter = document.getElementById("filterSelect").value;
    const today = new Date();
    const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
    
    document.querySelectorAll(".day-box").forEach(box => {
        const dateText = box.querySelector(".day-header").textContent.replace("üìÖ", "").trim();
        const [day, month, year] = dateText.split("/").map(Number);
        const boxDate = new Date(year, month - 1, day);
        let show = true;
        
        switch (filter) {
            case "today":
                show = boxDate >= startOfToday && boxDate < endOfToday;
                break;
            case "yesterday":
                const startOfYesterday = new Date(startOfToday);
                startOfYesterday.setDate(startOfYesterday.getDate() - 1);
                const endOfYesterday = new Date(startOfToday);
                show = boxDate >= startOfYesterday && boxDate < endOfYesterday;
                break;
            case "week":
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 7);
                show = boxDate >= startOfWeek && boxDate < endOfWeek;
                break;
            case "month":
                show = (boxDate.getMonth() === today.getMonth() && boxDate.getFullYear() === today.getFullYear());
                break;
            default:
                show = true;
        }
        box.style.display = show ? "" : "none";
    });
    
    // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ÿπŸÖŸÑÿ™ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
    document.getElementById("dateFilter").value = "";
}

// ===== ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ŸÖÿ≠ÿØÿØ =====
function filterByDate() {
    const dateInput = document.getElementById("dateFilter").value;
    if (!dateInput) return;
    const [year, month, day] = dateInput.split("-").map(Number);
    const selectedDate = new Date(year, month - 1, day);
    
    document.querySelectorAll(".day-box").forEach(box => {
        const dateText = box.querySelector(".day-header").textContent.replace("üìÖ", "").trim();
        const [d, m, y] = dateText.split("/").map(Number);
        const boxDate = new Date(y, m - 1, d);
        box.style.display = (boxDate.toDateString() === selectedDate.toDateString()) ? "" : "none";
    });
    
    // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÖÿß ÿ™ÿÆÿ™ÿßÿ± ÿ™ÿßÿ±ŸäÿÆ
    document.getElementById("filterSelect").value = "all";
}

// ===== ÿ•ÿ≤ÿßŸÑÿ© ŸÉŸÑ ÿßŸÑŸÅŸÑÿßÿ™ÿ± =====
function clearFilters() {
    document.getElementById("filterSelect").value = "all";
    document.getElementById("dateFilter").value = "";
    document.querySelectorAll(".day-box").forEach(b => b.style.display = "");
}

async function deleteAllData() {
    if (!confirm("‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!")) return;
    const snapshot = await db.collection("attendance").get();
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠");
    loadData();
}

// ===== Check In / Out =====
function manualCheckIn(){
  const empId=document.getElementById("employeeSelect").value;
  if(!empId){alert("Select employee"); return;}
  db.collection("employees").doc(empId).get().then(doc=>{
    if(!doc.exists){alert("Employee not found"); return;}
    const emp=doc.data();
    const now=new Date();
    db.collection("attendance").add({
      id: empId, name: emp.name,
      date: now.toISOString(),
      checkin: now.toLocaleTimeString("en-GB",{hour12:false}),
      checkout: "-",
      status: "ÿ≠ÿßÿ∂ÿ±"
    }).then(()=>loadData());
  });
}
function manualCheckOut(){
  const empId=document.getElementById("employeeSelect").value;
  if(!empId){alert("Select employee"); return;}
  db.collection("attendance").where("id","==",empId).where("checkout","==","-").get().then(snap=>{
    if(!snap.empty){
      snap.forEach(doc=>{
        const now=new Date();
        doc.ref.update({checkout:now.toLocaleTimeString("en-GB",{hour12:false})}).then(()=>loadData());
      });
    } else alert("No check-in found");
  });
}

function toggleStatus(docId,current){
  const newStatus=current==="ÿ≠ÿßÿ∂ÿ±"?"ÿ∫ÿßÿ¶ÿ®":"ÿ≠ÿßÿ∂ÿ±";
  db.collection("attendance").doc(docId).update({status:newStatus}).then(()=>loadData());
}
function editRecord(docId){
  db.collection("attendance").doc(docId).get().then(doc=>{
    const r=doc.data();
    const newDate=prompt("Enter Date YYYY-MM-DD", r.date.substring(0,10));
    const newCheckIn=prompt("Enter Check In HH:MM", r.checkin);
    const newCheckOut=prompt("Enter Check Out HH:MM", r.checkout);
    db.collection("attendance").doc(docId).update({
      date: newDate+"T00:00:00.000Z",
      checkin: newCheckIn,
      checkout: newCheckOut
    }).then(()=>loadData());
  });
}
function deleteRecord(docId){
  if(confirm("Delete this record?")) db.collection("attendance").doc(docId).delete().then(()=>loadData());
}

// ===== Export Excel =====
function exportExcel(){
  db.collection("attendance").get().then(snapshot=>{
    const data=[];
    snapshot.forEach(doc=>{
      const r=doc.data();
      data.push({
        ID:r.id, Name:r.name, Date:formatDate(r.date),
        "Check In":r.checkin, "Check Out":r.checkout,
        "Work Hours":calculateWorkHours(r.checkin,r.checkout,r.date),
        Status:r.status
      });
    });
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Records");
    XLSX.writeFile(wb,"attendance.xlsx");
  });
}

// ===== Search =====
function searchRecords(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  const table=document.getElementById("attendanceTable");
  const tr=table.getElementsByTagName("tr");
  for(let i=1;i<tr.length;i++){
    let td0=tr[i].getElementsByTagName("td")[0];
    let td1=tr[i].getElementsByTagName("td")[1];
    if(td0&&td1){
      let txt=(td0.textContent+td1.textContent).toLowerCase();
      tr[i].style.display=txt.includes(q)?"":"none";
    }
  }
}

// ===== Add/Delete Employee =====
function addEmployee(){
  const name=prompt("Enter Employee Name:");
  if(!name) return;
  const id=prompt("Enter Employee ID:");
  if(!id) return;
  db.collection("employees").doc(id).set({name:name}).then(()=>loadEmployees());
}
function deleteEmployee(){
  const empId=document.getElementById("employeeSelect").value;
  if(!empId){alert("Select employee"); return;}
  if(confirm("Delete this employee permanently?")){
    db.collection("employees").doc(empId).delete().then(()=>loadEmployees());
  }
}

// ===== Password toggle =====
let passVisible=false;
document.getElementById("togglePass").addEventListener("click",()=>{
  const pass=document.getElementById("password");
  passVisible=!passVisible;
  pass.type=passVisible?"text":"password";
  document.getElementById("togglePass").textContent=passVisible?"Hide":"Show";
});
</script>
</body>
</html>
