<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Attendance System 2.0 â€” Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- Firebase (compat for easier migration from your current code) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --accent:#C1272D;
  --muted:#6b7280;
  --card:#ffffff;
  --bg:#f4f6f9;
  --radius:12px;
  --glass: rgba(255,255,255,0.85);
  --shadow: 0 6px 18px rgba(12,24,40,0.06);
  --tap: 48px; /* touch target */
  --text: #111827;
  --success: #27ae60;
  --danger: #e74c3c;
}

/* reset */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:"Cairo",system-ui,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;min-height:100vh;}

/* SIDEBAR (desktop >=900) */
.sidebar{
  width:260px;background:#0f1724;color:white;padding:18px 12px;box-shadow:2px 0 18px rgba(2,6,23,0.2);
  display:flex;flex-direction:column;gap:12px;transition:transform .22s ease;
}
.brand{font-weight:700;font-size:18px;color:var(--accent);text-align:center;padding-bottom:6px}
.nav-btn{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;color:#e6eef5;font-size:15px}
.nav-btn:hover{background:rgba(255,255,255,0.02)}
.nav-btn.active{background:rgba(255,255,255,0.04);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
.small{font-size:13px;color:#9aa7b7}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column}
.header{
  display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 18px;background:transparent;
  border-bottom:1px solid rgba(0,0,0,0.04);
}
.h-left{display:flex;align-items:center;gap:12px}
.logo{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;font-weight:700}
.search{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);min-width:180px;max-width:420px}
.actions{display:flex;gap:8px;align-items:center}

/* Cards row */
.container-inner{padding:14px}
.cards{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);flex:1;min-width:160px}
.card h3{margin:0;font-size:13px;color:var(--muted)}
.card p{font-size:20px;margin:8px 0 0;font-weight:700}

/* table + controls */
.controls{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:white;min-height:var(--tap)}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#333}
.table-wrap{background:var(--card);padding:10px;border-radius:12px;box-shadow:var(--shadow);overflow:auto}
table{width:100%;border-collapse:collapse;min-width:780px}
th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:center;font-size:13px}
th{background:transparent;color:var(--muted);font-weight:700}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:120}
.modal{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:480px;box-shadow:var(--shadow)}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row input, .form-row select, .form-row textarea{flex:1;padding:10px;border-radius:10px;border:1px solid #e6e6e6;font-size:14px}
.label{font-size:13px;margin-bottom:6px;color:#333}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#111;color:white;padding:10px 14px;border-radius:12px;z-index:130;box-shadow:0 8px 24px rgba(0,0,0,0.2);opacity:0;transition:opacity .25s}

/* mobile bottom nav */
.bottom-nav{display:flex;gap:6px;position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:110}
.bottom-nav .nav-item{background:var(--card);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;cursor:pointer;min-width:56px}

/* responsive rules */
@media (max-width:900px){
  .app{flex-direction:column}
  .sidebar{display:none}
  .header{padding:10px}
  .container-inner{padding:12px}
  .cards{flex-direction:column}
  .table-wrap{padding:6px}
  table{min-width:700px}
  .modal{width:100%;height:100%;border-radius:0;max-width:100%;max-height:100%;overflow:auto}
  .search{min-width:120px}
  .bottom-nav{display:flex}
}

/* helper small */
.small-muted{font-size:12px;color:#666}
.actions .logout{background:#111;color:white;padding:8px 12px;border-radius:8px;border:none}

/* compact controls on very small */
@media (max-width:420px){
  .search{display:none}
  .actions button{padding:8px}
  th,td{padding:8px;font-size:12px}
}
</style>
</head>
<body class="rtl">
<div class="app">

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Attendance System 2.0</div>
    <div id="navDashboard" class="nav-btn active" onclick="switchView('dashboard')">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… <div class="small" style="margin-right:auto">Dashboard</div></div>
    <div id="navAttendance" class="nav-btn" onclick="switchView('attendance')">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
    <div id="navEmployees" class="nav-btn" onclick="switchView('employees')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div id="navReports" class="nav-btn" onclick="switchView('reports')">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div id="navSettings" class="nav-btn" onclick="switchView('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div style="margin-top:auto">
      <div class="small-muted" id="userEmail">--</div>
      <button class="btn" style="width:100%;margin-top:8px" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <!-- HEADER -->
    <div class="header">
      <div class="h-left">
        <button class="btn ghost" id="hamb" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" onclick="toggleSidebar()">â˜°</button>
        <div class="logo">LADG</div>
        <input id="globalSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¥Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ..." oninput="applySearch(this.value)">
      </div>
      <div class="actions">
        <button class="btn" onclick="openCheckModal('in')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
        <button class="btn" onclick="openCheckModal('out')">ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>

    <div class="container-inner">
      <!-- VIEWS -->
      <div id="view-dashboard">
        <div class="cards">
          <div class="card">
            <h3>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
            <p id="stat-present">0</p>
            <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          <div class="card">
            <h3>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
            <p id="stat-absent">0</p>
            <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</div>
          </div>
          <div class="card">
            <h3>Ø³Ø¬Ù„Ø§Øª (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3>
            <p id="stat-records">0</p>
            <div class="small-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
          </div>
        </div>

        <div class="table-wrap" style="margin-bottom:12px">
          <canvas id="chartDays" height="120"></canvas>
        </div>
      </div>

      <div id="view-attendance" style="display:none">
        <div class="controls">
          <select id="filterEmployee" onchange="renderTable()"><option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
          <input type="date" id="filterDate" onchange="renderTable()" />
          <button class="btn ghost" onclick="clearFilters()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <button class="btn" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
        </div>

        <div class="table-wrap">
          <table id="attendanceTable">
            <thead>
              <tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¯Ø®ÙˆÙ„</th><th>Ø®Ø±ÙˆØ¬</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø£ÙˆØ§Ù…Ø±</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="view-employees" style="display:none">
        <div class="controls">
          <button class="btn" onclick="openEmployeeModal()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
        </div>
        <div class="table-wrap">
          <table id="employeesTable">
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</th><th>Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="view-reports" style="display:none">
        <div class="card" style="margin-bottom:12px">
          <h3>ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠØ¹</h3>
          <p class="small-muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ‘Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆØ¸Ù.</p>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input type="date" id="reportFrom"> Ø¥Ù„Ù‰ <input type="date" id="reportTo">
            <select id="reportEmp"><option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
            <button class="btn" onclick="generateReport()">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>
      </div>

      <div id="view-settings" style="display:none">
        <div class="card">
          <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
          <p class="small-muted">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</p>
          <div style="margin-top:8px">
            <label class="label">Ø¨Ø¯Ø§ÙŠØ© Ø¯ÙˆØ§Ù… (HH:MM)</label>
            <input id="workStart" type="time" value="09:00" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6"/>
            <label class="label">Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù… (HH:MM)</label>
            <input id="workEnd" type="time" value="17:00" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6"/>
            <div style="margin-top:8px">
              <button class="btn" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
          </div>
        </div>
      </div>

    </div><!-- container-inner end -->
  </div><!-- main end -->
</div><!-- app end -->

<!-- bottom nav (mobile) -->
<div class="bottom-nav" id="bottomNav" style="display:none">
  <div class="nav-item" onclick="switchView('dashboard')">ğŸ </div>
  <div class="nav-item" onclick="switchView('attendance')">ğŸ“‹</div>
  <div class="nav-item" onclick="switchView('employees')">ğŸ‘¥</div>
  <div class="nav-item" onclick="switchView('reports')">ğŸ“Š</div>
  <div class="nav-item" onclick="switchView('settings')">âš™ï¸</div>
</div>

<!-- MODALS -->
<div id="modalBack" class="modal-back" onclick="onModalBackClick(event)">
  <div class="modal" id="modalContent" role="dialog" aria-modal="true" ></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== Firebase config - Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø§Ø²Ù… ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDVbS9U5qVC4DSk326d0ljW6ETGkyHVLUQ",
  authDomain: "ladg-attendance.firebaseapp.com",
  projectId: "ladg-attendance",
  storageBucket: "ladg-attendance.firebasestorage.app",
  messagingSenderId: "499991014945",
  appId: "1:499991014945:web:e4cd793de709191a157d60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ===== Global state ===== */
let currentUser = null;
let attendanceCache = [];
let employeesCache = [];
let settingsCache = { workStart: "09:00", workEnd: "17:00" };

/* UI helpers */
function showToast(text, timeout=3000){
  const t = document.getElementById('toast');
  t.textContent = text; t.style.opacity = '1';
  clearTimeout(t._hid);
  t._hid = setTimeout(()=>{ t.style.opacity = '0'; }, timeout);
}
function onModalBackClick(e){
  if(e.target.id === 'modalBack') modalClose();
}
function toggleSidebar(){
  const sb = document.getElementById('sidebar');
  if(!sb) return;
  const isHidden = getComputedStyle(sb).display === 'none';
  sb.style.display = isHidden ? 'flex' : 'none';
}

/* ===== Auth listener ===== */
auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user){
    document.getElementById('userEmail').innerText = user.email || user.displayName || '--';
    await loadSettings();
    await loadEmployees();
    await loadAttendance();
    renderTable();
    renderDashboard();
  } else {
    showLogin();
  }
});

/* ===== Responsive bottom nav visibility ===== */
function updateMobileNav(){
  const bottom = document.getElementById('bottomNav');
  if(window.innerWidth <= 900){ bottom.style.display = 'flex'; }
  else bottom.style.display = 'none';
}
window.addEventListener('resize', updateMobileNav);
updateMobileNav();

/* ===== UI view switch ===== */
function switchView(name){
  const views = ['dashboard','attendance','employees','reports','settings'];
  views.forEach(v=>{
    const el = document.getElementById('view-'+v);
    if(!el) return;
    el.style.display = (v===name)?'block':'none';
    const nav = document.getElementById('nav'+capitalize(v));
    if(nav) nav.classList.toggle('active', v===name);
  });
  // hide modal and scroll to top on view change (mobile friendly)
  window.scrollTo({top:0,behavior:'smooth'});
}
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1) }

/* ===== LOGIN modal (simple) ===== */
function showLogin(){
  const content = `
    <h3 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <div class="form-row"><input id="loginEmail" placeholder="Email"></div>
    <div class="form-row" style="align-items:center">
      <input id="loginPass" type="password" placeholder="Password" style="flex:1">
      <button class="btn ghost" style="margin-right:8px" onclick="togglePass('loginPass')">Ø¥Ø¸Ù‡Ø§Ø±</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <p style="margin-top:8px;font-size:13px">Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ùƒ.</p>
  `;
  showModal(content,false);
}
function togglePass(id){ const el=document.getElementById(id); if(!el) return; el.type = el.type === 'password' ? 'text' : 'password'; }

/* login flow */
async function doLogin(){
  const e=document.getElementById('loginEmail').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  if(!e || !p){ showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  try{
    await auth.signInWithEmailAndPassword(e,p);
    modalClose();
    showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
  }catch(err){
    showToast(err.message);
  }
}
function logout(){ auth.signOut(); location.reload(); }

/* ===== Modal helpers ===== */
function showModal(html, closable=true){
  document.getElementById('modalContent').innerHTML = html;
  const mb = document.getElementById('modalBack');
  mb.style.display = 'flex';
  if(!closable) mb.onclick = null;
}
function modalClose(){ document.getElementById('modalBack').style.display='none'; }

/* ===== Save settings ===== */
async function loadSettings(){
  try{
    const doc = await db.collection('settings').doc('main').get();
    if(doc.exists) settingsCache = {...settingsCache, ...doc.data()};
    document.getElementById('workStart').value = settingsCache.workStart || '09:00';
    document.getElementById('workEnd').value = settingsCache.workEnd || '17:00';
  }catch(e){ console.error(e) }
}
function saveSettings(){
  settingsCache.workStart = document.getElementById('workStart').value;
  settingsCache.workEnd = document.getElementById('workEnd').value;
  db.collection('settings').doc('main').set(settingsCache).then(()=> showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸'));
}

/* ===== Employees ===== */
async function loadEmployees(){
  employeesCache = [];
  const sel = document.getElementById('filterEmployee');
  const rep = document.getElementById('reportEmp');
  sel.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
  rep.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
  try{
    const snapshot = await db.collection('employees').orderBy('name').get();
    snapshot.forEach(doc=>{
      const e = { id: doc.id, ...doc.data() };
      employeesCache.push(e);
      const opt = document.createElement('option');
      opt.value = e.id; opt.textContent = `${e.id} - ${e.name}`;
      sel.appendChild(opt);
      const opt2 = opt.cloneNode(true); rep.appendChild(opt2);
    });
  }catch(err){ console.error(err); showToast('Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†') }
  renderEmployeesTable();
}

/* ===== Attendance =====
   NOTE on date handling:
   - When user selects a date we create a local-midnight ISO WITHOUT Z to avoid timezone shifts
   - Firestore can store timestamps; here we keep string ISO for compatibility with your existing logic.
*/
function localDateISO(dateString){
  // dateString in YYYY-MM-DD OR Date object -> returns ISO like '2025-11-26T00:00:00'
  if(!dateString) return new Date().toISOString();
  if(typeof dateString === 'string' && dateString.includes('T')) return dateString;
  const d = (typeof dateString === 'string') ? new Date(dateString + 'T00:00:00') : new Date(dateString);
  // return ISO without Z to keep it local (consistent with previous code)
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString();
}

function formatDateISOorString(d){
  try{
    const dt = new Date(d);
    return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
  }catch(e){ return d }
}
function timeNowHHMM(){
  const now = new Date();
  return now.toTimeString().slice(0,5); // "HH:MM"
}
function calcWorkHours(checkin,checkout,dateISO){
  if(!checkin || !checkout || checkout==='-' || checkin==='-') return '-';
  const inParts = checkin.split(':').map(Number);
  const outParts = checkout.split(':').map(Number);
  const base = new Date(dateISO);
  base.setHours(inParts[0], inParts[1], 0, 0);
  const out = new Date(dateISO); out.setHours(outParts[0], outParts[1], 0, 0);
  const diffMs = out - base;
  if(isNaN(diffMs) || diffMs < 0) return '-';
  const h = Math.floor(diffMs/3600000); const m = Math.floor((diffMs%3600000)/60000);
  return `${h}h ${m}m`;
}

async function loadAttendance(){
  attendanceCache = [];
  try{
    const snap = await db.collection('attendance').orderBy('date','desc').limit(800).get();
    snap.forEach(doc => attendanceCache.push({ docId: doc.id, ...doc.data() }));
    renderTable(); renderDashboard(); renderEmployeesTable();
  }catch(err){
    console.error(err); showToast('Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
  }
}

/* Dashboard render */
function renderDashboard(){
  const today = new Date();
  const startOfToday = new Date(today.getFullYear(),today.getMonth(),today.getDate());
  const endOfToday = new Date(startOfToday.getTime() + 86400000 - 1);
  const present = attendanceCache.filter(r => {
    const d = new Date(r.date);
    return (d >= startOfToday && d <= endOfToday && r.checkin && r.checkin!=='-');
  }).length;
  const allEmployees = employeesCache.length || 0;
  const absent = Math.max(0, allEmployees - present);
  document.getElementById('stat-present').innerText = present;
  document.getElementById('stat-absent').innerText = absent;
  document.getElementById('stat-records').innerText = attendanceCache.length;

  // last 7 days chart
  const labels=[]; const dataP=[]; const dataA=[];
  for(let i=6;i>=0;i--){
    const dt = new Date(); dt.setDate(dt.getDate()-i);
    const key = dt.toDateString();
    labels.push(`${dt.getDate()}/${dt.getMonth()+1}`);
    const dayRecords = attendanceCache.filter(r => (new Date(r.date)).toDateString() === key);
    const p = dayRecords.filter(rr=> rr.checkin && rr.checkin!=='-').length;
    const a = Math.max(0, employeesCache.length - p);
    dataP.push(p); dataA.push(a);
  }
  const ctx = document.getElementById('chartDays').getContext('2d');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets:[
        { label:'Ø­Ø§Ø¶Ø±', data: dataP, backgroundColor: '#27ae60' },
        { label:'ØºØ§Ø¦Ø¨', data: dataA, backgroundColor: '#e74c3c' }
      ]
    },
    options:{responsive:true, maintainAspectRatio:false}
  });
}

/* Render attendance table with filters */
function renderTable(){
  const tbody = document.querySelector('#attendanceTable tbody');
  tbody.innerHTML = '';
  const empFilter = document.getElementById('filterEmployee').value;
  const dateFilter = document.getElementById('filterDate').value; // YYYY-MM-DD

  const rows = attendanceCache.filter(r=>{
    if(empFilter!=='all' && r.id !== empFilter) return false;
    if(dateFilter){
      const sel = new Date(dateFilter + 'T00:00:00');
      const rowDate = new Date(r.date);
      return sel.toDateString() === rowDate.toDateString();
    }
    return true;
  });

  rows.forEach((r)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td>
      <td>${r.name}</td>
      <td>${formatDateISOorString(r.date)}</td>
      <td>${r.checkin||'-'}</td>
      <td>${r.checkout||'-'}</td>
      <td>${calcWorkHours(r.checkin,r.checkout,r.date)}</td>
      <td>${r.status||'-'}</td>
<td style="min-width:210px">
  <button class="btn ghost" onclick="openEditRecord('${r.docId}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
  <button class="btn ghost" onclick="deleteRecord('${r.docId}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
  <button class="btn" style="background:${'var(--success)'}" onclick="markStatus('${r.docId}','Ø­Ø§Ø¶Ø±')">âœ…</button>
  <button class="btn" style="background:${'var(--danger)'}" onclick="markStatus('${r.docId}','ØºØ§Ø¦Ø¨')">âŒ</button>
</td>`;
    tbody.appendChild(tr);
  });
}

/* Employee stats + table */
function calcEmployeeStats(empId){
  const empRecords = attendanceCache.filter(r => r.id === empId);
  let daysPresent = 0, daysAbsent = 0, totalMinutes = 0;
  const dateMap = {};
  empRecords.forEach(r=>{
    const dateKey = (new Date(r.date)).toDateString();
    if(!dateMap[dateKey]) dateMap[dateKey] = r;
  });
  Object.values(dateMap).forEach(r=>{
    const checkin = r.checkin && r.checkin!=='-' ? r.checkin : null;
    const checkout = r.checkout && r.checkout!=='-' ? r.checkout : null;
    if(checkin){
      daysPresent++;
      const inParts = checkin.split(':').map(Number);
      const outParts = (checkout?checkout:'00:00').split(':').map(Number);
      const minutes = ((outParts[0]*60 + outParts[1]) - (inParts[0]*60 + inParts[1]));
      if(minutes>0) totalMinutes += minutes;
    } else daysAbsent++;
  });
  const totalHours = Math.floor(totalMinutes/60);
  const totalMins = totalMinutes % 60;
  return { daysPresent, daysAbsent, totalHours, totalMins };
}
function renderEmployeesTable(){
  const tbody = document.querySelector('#employeesTable tbody');
  tbody.innerHTML = '';
  employeesCache.forEach(e => {
    const stats = calcEmployeeStats(e.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.id}</td>
      <td>${e.name}</td>
      <td>${e.role||'employee'}</td>
      <td>
        Ø­Ø§Ø¶Ø±: ${stats.daysPresent} ÙŠÙˆÙ…<br>
        ØºØ§Ø¦Ø¨: ${stats.daysAbsent} ÙŠÙˆÙ…<br>
        Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: ${stats.totalHours}h ${stats.totalMins}m
      </td>
      <td>
        <button class="btn ghost" onclick="openEmployeeModal('${e.id}','${e.name}','${e.role||'employee'}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn ghost" onclick="deleteEmployee('${e.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* Search */
function applySearch(q){
  q = q.trim().toLowerCase();
  if(!q){ renderTable(); return; }
  const tbody = document.querySelector('#attendanceTable tbody'); tbody.innerHTML='';
  attendanceCache.filter(r=> (r.id+' '+r.name).toLowerCase().includes(q)).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td><td>${r.name}</td><td>${formatDateISOorString(r.date)}</td><td>${r.checkin||'-'}</td><td>${r.checkout||'-'}</td><td>${calcWorkHours(r.checkin,r.checkout,r.date)}</td><td>${r.status||'-'}</td><td>
      <button class="btn ghost" onclick="openEditRecord('${r.docId}')">ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn ghost" onclick="deleteRecord('${r.docId}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Check In / Out via modal (supports past date + custom time) ===== */
let activeCheckAction = null;

function openCheckModal(action){
  activeCheckAction = action;
  let empOptions = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù</option>';
  employeesCache.forEach(e=> empOptions += `<option value="${e.id}">${e.id} - ${e.name}</option>`);
  const html = `
    <h3 style="margin-top:0">${action==='in' ? 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±' : 'ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØµØ±Ø§Ù'}</h3>
    <div class="label">Ø§Ù„Ù…ÙˆØ¸Ù</div>
    <div class="form-row"><select id="modalEmp">${empOptions}</select></div>
    <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ…)</div>
    <div class="form-row"><input id="modalDate" type="date" /></div>
    <div class="label">Ø§Ù„ÙˆÙ‚Øª (HH:MM) - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ù„ÙŠØ£Ø®Ø° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    <div class="form-row"><input id="modalTime" type="time" /></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="submitCheck()">Ø­ÙØ¸</button>
      <button class="btn ghost" onclick="modalClose()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;
  showModal(html);
}

async function submitCheck(){
  const empId = document.getElementById('modalEmp').value;
  if(!empId){ showToast('Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù'); return; }
  const emp = employeesCache.find(x=>x.id===empId);
  if(!emp){ showToast('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

  const dateVal = document.getElementById('modalDate').value;
  const timeVal = document.getElementById('modalTime').value;
  const isoDate = dateVal ? localDateISO(dateVal) : localDateISO(new Date());
  const timeStr = timeVal ? timeVal : timeNowHHMM();

  try{
    if(activeCheckAction === 'in'){
      // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®
      const q = await db.collection('attendance')
        .where('id','==',empId)
        .get();
      let found = false;
      for(const doc of q.docs){
        const r = doc.data();
        const rowDate = new Date(r.date);
        if(rowDate.toDateString() === (new Date(isoDate)).toDateString()){
          await doc.ref.update({ checkin: timeStr, status:'Ø­Ø§Ø¶Ø±' });
          found = true;
        }
      }
      if(!found){
        await db.collection('attendance').add({
          id: emp.id,
          name: emp.name,
          date: isoDate,
          checkin: timeStr,
          checkout: '-',
          status: 'Ø­Ø§Ø¶Ø±',
          createdBy: currentUser ? currentUser.uid : null
        });
      }
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
      // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
      const q = await db.collection('attendance')
        .where('id','==',empId)
        .where('checkout','==','-')
        .get();
      if(!q.empty){
        let updated = false;
        for(const doc of q.docs){
          const r = doc.data();
          const rowDate = new Date(r.date);
          if(!dateVal || rowDate.toDateString() === (new Date(dateVal+'T00:00:00')).toDateString()){
            await doc.ref.update({ checkout: timeStr });
            updated = true;
          }
        }
        if(!updated){ showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ check-in Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®'); modalClose(); return; }
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      } else {
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù');
        modalClose(); return;
      }
    }
    await loadAttendance();
    modalClose();
  }catch(err){
    console.error(err); showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„');
  }
}

/* ===== Edit / Delete record ===== */
function openEditRecord(docId){
  const rec = attendanceCache.find(r=> r.docId === docId);
  if(!rec) return showToast('Record not found');
  const dateISO = new Date(rec.date);
  const dateStr = dateISO.toISOString().substring(0,10);
  const html = `
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
    <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
    <div class="form-row"><input id="editDate" type="date" value="${dateStr}"></div>
    <div class="label">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="form-row"><input id="editIn" type="time" value="${rec.checkin && rec.checkin!=='-'?rec.checkin:''}"></div>
    <div class="label">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    <div class="form-row"><input id="editOut" type="time" value="${rec.checkout && rec.checkout!=='-'?rec.checkout:''}"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="submitEdit('${docId}')">Ø­ÙØ¸</button>
      <button class="btn ghost" onclick="modalClose()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;
  showModal(html);
}
async function submitEdit(docId){
  const d = document.getElementById('editDate').value;
  const inT = document.getElementById('editIn').value || '-';
  const outT = document.getElementById('editOut').value || '-';
  if(!d){ showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®'); return; }
  const iso = localDateISO(d);
  try{
    await db.collection('attendance').doc(docId).update({ date: iso, checkin: inT, checkout: outT });
    await loadAttendance();
    showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
    modalClose();
  }catch(err){ console.error(err); showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„') }
}
function deleteRecord(docId){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  db.collection('attendance').doc(docId).delete().then(()=>{ loadAttendance(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); })
  .catch(()=> showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù'));
}

/* ===== Manual Status Update ===== */
async function markStatus(docId, status) {
  try {
    await db.collection('attendance').doc(docId).update({ status });
    await loadAttendance();
    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
  } catch (e) { console.error(e); showToast('Ø­Ø¯Ø« Ø®Ø·Ø£') }
}

/* ===== Employees CRUD ===== */
function openEmployeeModal(id='', name='', role='employee'){
  const html = `
    <h3>${id ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù' : 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù'}</h3>
    <div class="label">Ø§Ù„Ø±Ù‚Ù… (ID)</div>
    <div class="form-row"><input id="empId" ${id?'readonly':''} value="${id}"></div>
    <div class="label">Ø§Ù„Ø§Ø³Ù…</div>
    <div class="form-row"><input id="empName" value="${name}"></div>
    <div class="label">Ø§Ù„Ø¯ÙˆØ±</div>
    <div class="form-row"><select id="empRole"><option value="employee">employee</option><option value="admin">admin</option></select></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="submitEmployee('${id ? 'edit' : 'create'}')">Ø­ÙØ¸</button>
      <button class="btn ghost" onclick="modalClose()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;
  showModal(html);
  setTimeout(()=>{ document.getElementById('empRole').value = role; },50);
}
async function submitEmployee(mode){
  const id = document.getElementById('empId').value.trim();
  const name = document.getElementById('empName').value.trim();
  const role = document.getElementById('empRole').value;
  if(!id || !name) return showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ID ÙˆØ§Ø³Ù…');
  try{
    await db.collection('employees').doc(id).set({ name, role });
    await loadEmployees();
    modalClose(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù');
  }catch(e){ console.error(e); showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸') }
}
function deleteEmployee(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø³ÙŠØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ')) return;
  db.collection('employees').doc(id).delete().then(()=>loadEmployees()).then(()=>showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'));
}

/* ===== Reports & Export ===== */
function exportExcel(){
  const data = attendanceCache.map(r=>({
    ID:r.id, Name:r.name, Date: formatDateISOorString(r.date),
    'Check In': r.checkin || '-', 'Check Out': r.checkout || '-', 'Work Hours': calcWorkHours(r.checkin,r.checkout,r.date), Status: r.status || '-'
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Records');
  XLSX.writeFile(wb,'attendance.xlsx');
}

async function generateReport(){
  const from = document.getElementById('reportFrom').value;
  const to = document.getElementById('reportTo').value;
  const emp = document.getElementById('reportEmp').value;
  if(!from || !to) return showToast('Ø§Ø®ØªØ± Ù…Ù† ÙˆØ¥Ù„Ù‰');
  const f = new Date(from+'T00:00:00'), t = new Date(to+'T23:59:59');
  const rows = attendanceCache.filter(r=>{
    const d = new Date(r.date);
    if(d < f || d > t) return false;
    if(emp !== 'all' && r.id !== emp) return false;
    return true;
  }).map(r=>({
    ID:r.id, Name:r.name, Date: formatDateISOorString(r.date),
    'Check In': r.checkin || '-', 'Check Out': r.checkout || '-', 'Work Hours': calcWorkHours(r.checkin,r.checkout,r.date), Status: r.status || '-'
  }));
  if(rows.length===0) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Report');
  XLSX.writeFile(wb,'report.xlsx');
}

/* Utilities */
function clearFilters(){ document.getElementById('filterEmployee').value='all'; document.getElementById('filterDate').value=''; renderTable(); }

/* initial view */
switchView('dashboard');

</script>
</body>
</html>
