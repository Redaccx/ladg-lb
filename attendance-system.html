<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance System 2.0 â€” Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --accent:#C1272D;
  --muted:#6b7280;
  --card:#fff;
  --bg:#f4f6f9;
  --radius:10px;
}
*{box-sizing:border-box;}
body{margin:0;font-family:"Cairo",system-ui,Arial;background:var(--bg);color:#111;}
.app{display:flex;min-height:100vh;}

/* Sidebar */
.sidebar{
  width:260px;background:#0f1724;color:white;padding:20px 12px;box-shadow:2px 0 18px rgba(2,6,23,0.2);
  display:flex;flex-direction:column;gap:14px;transition: all 0.3s ease;
}
.brand{font-weight:700;font-size:20px;color:var(--accent);text-align:center;padding-bottom:6px;}
.nav-btn{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;cursor:pointer;color:#e6eef5;white-space:nowrap;}
.nav-btn:hover{background:rgba(255,255,255,0.03);}
.nav-btn.active{background:rgba(255,255,255,0.06);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);}
.small{font-size:13px;color:#9aa7b7;}
.small-muted{font-size:12px;color:#666;}

/* Main */
.main{
  flex:1;padding:20px;
}
.header{
  display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap;
}
.h-left{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.logo{background:var(--accent);color:white;padding:8px 14px;border-radius:8px;font-weight:700;}
.search{padding:8px 12px;border-radius:8px;border:1px solid #e6eef5;min-width:260px;flex:1;}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

/* Cards row */
.cards{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(12,24,40,0.06);flex:1;min-width:200px;}
.card h3{margin:0;font-size:14px;color:var(--muted);}
.card p{font-size:20px;margin:8px 0 0;font-weight:700;}

/* Table and controls */
.controls{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;}
.btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;background:var(--accent);color:white;font-size:13px;}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#333;font-size:12px;padding:5px 8px;}
.table-wrap{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,24,40,0.06);overflow-x:auto;}
table{width:100%;border-collapse:collapse;table-layout:fixed;}
th,td{padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:center;word-wrap:break-word;font-size:13px;}
th{background:transparent;color:var(--muted);font-weight:700;}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:50;}
.modal{background:white;padding:16px;border-radius:12px;min-width:300px;max-width:400px;}
.form-row{display:flex;gap:8px;margin-bottom:8px;}
.form-row input, .form-row select{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e6e6;}
.label{font-size:13px;margin-bottom:6px;color:#333;}

/* responsive */
@media(max-width:1024px){
  .app{flex-direction:column;}
  .sidebar{
    width:100%;
    display:flex;
    flex-direction:row;
    overflow-x:auto;
    padding:8px;
  }
  .sidebar .nav-btn{flex:1;text-align:center;font-size:14px;padding:8px;}
  .main{padding:12px;}
}

@media(max-width:768px){
  .header{flex-direction:column;align-items:flex-start;gap:10px;}
  .h-left{flex-direction:column;align-items:flex-start;gap:6px;}
  .search{min-width:100%;}
  .actions{width:100%;justify-content:space-between;}
  .cards{flex-direction:column;gap:10px;}
  .card{width:100%;}
  table, th, td{font-size:12px;}
  .controls{flex-direction:column;align-items:flex-start;gap:6px;}
  .controls input, .controls select, .controls button{width:100%;margin-bottom:6px;}
}
.actions .logout{background:#111;color:white;padding:8px 12px;border-radius:8px;border:none;}
</style>
</head>
<body class="rtl">
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Attendance System 2.0</div>
    <div id="navDashboard" class="nav-btn active" onclick="switchView('dashboard')">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… <div class="small" style="margin-right:auto">Dashboard</div></div>
    <div id="navAttendance" class="nav-btn" onclick="switchView('attendance')">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
    <div id="navEmployees" class="nav-btn" onclick="switchView('employees')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div id="navReports" class="nav-btn" onclick="switchView('reports')">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div id="navSettings" class="nav-btn" onclick="switchView('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div style="margin-top:auto">
      <div class="small-muted" id="userEmail">--</div>
      <button class="btn" style="width:100%;margin-top:8px" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- HEADER -->
    <div class="header">
      <div class="h-left">
        <div class="logo">LADG</div>
        <input id="globalSearch" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¥Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ..." oninput="applySearch(this.value)">
      </div>
      <div class="actions">
        <button class="btn" onclick="openCheckModal('in')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
        <button class="btn" onclick="openCheckModal('out')">ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>

    <!-- VIEWS -->
    <div id="view-dashboard">
      <div class="cards">
        <div class="card">
          <h3>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
          <p id="stat-present">0</p>
          <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="card">
          <h3>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
          <p id="stat-absent">0</p>
          <div class="small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</div>
        </div>
        <div class="card">
          <h3>Ø³Ø¬Ù„Ø§Øª (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3>
          <p id="stat-records">0</p>
          <div class="small-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
        </div>
      </div>

      <div class="table-wrap" style="margin-bottom:12px">
        <canvas id="chartDays" height="120"></canvas>
      </div>
    </div>

    <div id="view-attendance" style="display:none">
      <div class="controls">
        <select id="filterEmployee" onchange="renderTable()"><option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
        <input type="date" id="filterDate" onchange="renderTable()" />
        <button class="btn ghost" onclick="clearFilters()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        <button class="btn" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
      </div>
      <div class="table-wrap">
        <table id="attendanceTable">
          <thead>
            <tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¯Ø®ÙˆÙ„</th><th>Ø®Ø±ÙˆØ¬</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø£ÙˆØ§Ù…Ø±</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="view-employees" style="display:none">
      <div class="controls">
        <button class="btn" onclick="openEmployeeModal()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
      </div>
      <div class="table-wrap">
        <table id="employeesTable">
          <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="view-reports" style="display:none">
      <div class="card" style="margin-bottom:12px">
        <h3>ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠØ¹</h3>
        <p class="small-muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ‘Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆØ¸Ù.</p>
        <div style="margin-top:8px">
          <input type="date" id="reportFrom"> Ø¥Ù„Ù‰ <input type="date" id="reportTo">
          <select id="reportEmp"><option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
          <button class="btn" onclick="generateReport()">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
    </div>

    <div id="view-settings" style="display:none">
      <div class="card">
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <p class="small-muted">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</p>
        <div style="margin-top:8px">
          <label class="label">Ø¨Ø¯Ø§ÙŠØ© Ø¯ÙˆØ§Ù… (HH:MM)</label>
          <input id="workStart" type="time" value="09:00"/>
          <label class="label">Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù… (HH:MM)</label>
          <input id="workEnd" type="time" value="17:00"/>
          <div style="margin-top:8px">
            <button class="btn" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div id="modalBack" class="modal-back">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDVbS9U5qVC4DSk326d0ljW6ETGkyHVLUQ",
  authDomain: "ladg-attendance.firebaseapp.com",
  projectId: "ladg-attendance",
  storageBucket: "ladg-attendance.firebasestorage.app",
  messagingSenderId: "499991014945",
  appId: "1:499991014945:web:e4cd793de709191a157d60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ===== Global State =====
let currentUser=null, attendanceCache=[], employeesCache=[], settingsCache={workStart:"09:00",workEnd:"17:00"};

// ===== Auth Listener =====
auth.onAuthStateChanged(async user=>{
  currentUser=user;
  if(user){
    document.getElementById('userEmail').innerText=user.email;
    await loadSettings(); await loadEmployees(); await loadAttendance();
  } else showLogin();
});

// ===== UI Helpers =====
function switchView(name){
  const views=['dashboard','attendance','employees','reports','settings'];
  views.forEach(v=>{
    document.getElementById('view-'+v).style.display=(v===name?'block':'none');
    document.getElementById('nav'+capitalize(v))?.classList.toggle('active', v===name);
  });
}
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

// ===== Login =====
function showLogin(){
  const html=`
    <h3 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <div class="form-row"><input id="loginEmail" placeholder="Email"></div>
    <div class="form-row"><input id="loginPass" type="password" placeholder="Password"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <p style="margin-top:8px;font-size:13px">Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ùƒ.</p>`;
  showModal(html,false);
}
async function doLogin(){
  const e=document.getElementById('loginEmail').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  try{ await auth.signInWithEmailAndPassword(e,p); modalClose(); } catch(err){ alert(err.message); }
}
function logout(){ auth.signOut(); location.reload(); }

// ===== Modal =====
function showModal(html,closable=true){
  const mb=document.getElementById('modalBack');
  document.getElementById('modalContent').innerHTML=html;
  mb.style.display='flex';
  if(closable){ mb.onclick=(e)=>{ if(e.target===mb) modalClose(); } } else mb.onclick=null;
}
function modalClose(){ document.getElementById('modalBack').style.display='none'; }

// ===== Settings =====
async function loadSettings(){
  try{ const doc=await db.collection('settings').doc('main').get();
    if(doc.exists) settingsCache={...settingsCache,...doc.data()};
    document.getElementById('workStart').value=settingsCache.workStart||'09:00';
    document.getElementById('workEnd').value=settingsCache.workEnd||'17:00';
  } catch(e){ console.error(e); }
}
function saveSettings(){
  settingsCache.workStart=document.getElementById('workStart').value;
  settingsCache.workEnd=document.getElementById('workEnd').value;
  db.collection('settings').doc('main').set(settingsCache).then(()=>alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'));
}

// ===== Employees =====
async function loadEmployees(){
  employeesCache=[]; const sel=document.getElementById('filterEmployee'); const rep=document.getElementById('reportEmp');
  sel.innerHTML='<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>'; rep.innerHTML='<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
  const snapshot=await db.collection('employees').orderBy('name').get();
  snapshot.forEach(doc=>{
    const e={id:doc.id,...doc.data()}; employeesCache.push(e);
    const opt=document.createElement('option'); opt.value=e.id; opt.textContent=`${e.id} - ${e.name}`;
    sel.appendChild(opt); rep.appendChild(opt.cloneNode(true));
  });
  renderEmployeesTable();
}

// ===== Attendance =====
function formatDateISOorString(d){
  try{ const dt=new Date(d); return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}` }
  catch(e){ return d; }
}
function calcWorkHours(checkin,checkout,dateISO){
  if(!checkin||!checkout||checkout==='-') return '-';
  const inParts=checkin.split(':').map(Number);
  const outParts=checkout.split(':').map(Number);
  const base=new Date(dateISO); base.setHours(inParts[0],inParts[1],0,0);
  const out=new Date(dateISO); out.setHours(outParts[0],outParts[1],0,0);
  const diffMs=out-base; if(isNaN(diffMs)||diffMs<0) return '-';
  const h=Math.floor(diffMs/3600000); const m=Math.floor((diffMs%3600000)/60000);
  return `${h}h ${m}m`;
}
async function loadAttendance(){
  attendanceCache=[]; const snap=await db.collection('attendance').orderBy('date','desc').limit(500).get();
  snap.forEach(doc=>attendanceCache.push({docId:doc.id,...doc.data()}));
  renderTable(); renderDashboard();
}

// ===== Dashboard =====
function renderDashboard(){
  const today=new Date(); const startOfToday=new Date(today.getFullYear(),today.getMonth(),today.getDate());
  const present=attendanceCache.filter(r=>{const d=new Date(r.date); return d>=startOfToday && d<new Date(startOfToday.getTime()+86400000) && r.checkin; }).length;
  const absent=employeesCache.length - present; document.getElementById('stat-present').innerText=present;
  document.getElementById('stat-absent').innerText=absent<0?0:absent; document.getElementById('stat-records').innerText=attendanceCache.length;
  // Chart last 7 days
  const last7=[], counts=[];
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(today.getDate()-i);
    const key=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    last7.push(`${d.getDate()}/${d.getMonth()+1}`);
    counts.push(attendanceCache.filter(r=>{ const rd=new Date(r.date); return rd.getFullYear()===d.getFullYear() && rd.getMonth()===d.getMonth() && rd.getDate()===d.getDate(); }).length);
  }
  const ctx=document.getElementById('chartDays').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  window.myChart=new Chart(ctx,{type:'bar',data:{labels:last7,datasets:[{label:'Ø³Ø¬Ù„Ø§Øª',data:counts,backgroundColor:'rgba(193,39,45,0.7)'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

// ===== Render Tables =====
function renderTable(){
  const tbl=document.getElementById('attendanceTable').querySelector('tbody'); tbl.innerHTML='';
  const fEmp=document.getElementById('filterEmployee').value;
  const fDate=document.getElementById('filterDate').value;
  attendanceCache.forEach((r,i)=>{
    if(fEmp!=='all' && r.employeeId!==fEmp) return;
    if(fDate && formatDateISOorString(r.date)!==fDate.split('-').reverse().join('/')) return;
    const emp=employeesCache.find(e=>e.id===r.employeeId);
    const row=document.createElement('tr');
    row.innerHTML=`<td>${i+1}</td><td>${emp?.name||'-'}</td><td>${formatDateISOorString(r.date)}</td><td>${r.checkin||'-'}</td><td>${r.checkout||'-'}</td><td>${calcWorkHours(r.checkin,r.checkout,r.date)}</td><td>${r.checkin?'Ø­Ø§Ø¶Ø±':'ØºØ§Ø¦Ø¨'}</td><td><button class="btn ghost" onclick="deleteAttendance('${r.docId}')">Ø­Ø°Ù</button></td>`;
    tbl.appendChild(row);
  });
}
function renderEmployeesTable(){
  const tbl=document.getElementById('employeesTable').querySelector('tbody'); tbl.innerHTML='';
  employeesCache.forEach((e,i)=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${i+1}</td><td>${e.name}</td><td>${e.role||'-'}</td><td><button class="btn ghost" onclick="deleteEmployee('${e.id}')">Ø­Ø°Ù</button></td>`;
    tbl.appendChild(row);
  });
}

// ===== Employee Modals =====
function openEmployeeModal(){
  const html=`<h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
    <div class="form-row"><input id="empName" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
    <div class="form-row"><input id="empRole" placeholder="Ø§Ù„Ø¯ÙˆØ±"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="saveEmployee()">Ø­ÙØ¸</button></div>`;
  showModal(html);
}
async function saveEmployee(){
  const name=document.getElementById('empName').value.trim();
  const role=document.getElementById('empRole').value.trim();
  if(!name){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
  const doc=await db.collection('employees').add({name,role}); employeesCache.push({id:doc.id,name,role});
  modalClose(); renderEmployeesTable(); renderDashboard();
}
async function deleteEmployee(id){
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return;
  await db.collection('employees').doc(id).delete();
  employeesCache=employeesCache.filter(e=>e.id!==id); renderEmployeesTable(); renderDashboard();
}

// ===== Attendance Modals =====
function openCheckModal(type){
  let html=`<h3>${type==='in'?'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±':'ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØµØ±Ø§Ù'}</h3>
  <div class="form-row"><select id="selEmployee">${employeesCache.map(e=>`<option value="${e.id}">${e.name}</option>`)}</select></div>
  <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="saveAttendance('${type}')">Ø­ÙØ¸</button></div>`;
  showModal(html);
}
async function saveAttendance(type){
  const empId=document.getElementById('selEmployee').value; const today=new Date().toISOString().split('T')[0];
  let query=db.collection('attendance').where('employeeId','==',empId).where('date','>=',today).where('date','<',today+'T23:59:59');
  const snap=await query.get();
  let record;
  if(snap.empty){ record={employeeId:empId,date:new Date().toISOString(),checkin:type==='in'?new Date().toTimeString().slice(0,5):'-',checkout:type==='out'?new Date().toTimeString().slice(0,5):'-'};
    const doc=await db.collection('attendance').add(record); record.docId=doc.id; attendanceCache.push(record);
  } else { record=snap.docs[0].data(); record.docId=snap.docs[0].id;
    if(type==='in'){ await db.collection('attendance').doc(record.docId).update({checkin:new Date().toTimeString().slice(0,5)}); record.checkin=new Date().toTimeString().slice(0,5);}
    if(type==='out'){ await db.collection('attendance').doc(record.docId).update({checkout:new Date().toTimeString().slice(0,5)}); record.checkout=new Date().toTimeString().slice(0,5);}
  }
  modalClose(); renderTable(); renderDashboard();
}
async function deleteAttendance(id){
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  await db.collection('attendance').doc(id).delete();
  attendanceCache=attendanceCache.filter(a=>a.docId!==id); renderTable(); renderDashboard();
}

// ===== Search & Filters =====
function applySearch(term){ term=term.toLowerCase(); const tbl=document.getElementById('attendanceTable').querySelector('tbody'); for(const r of tbl.rows){ r.style.display=r.cells[1].textContent.toLowerCase().includes(term)?'':'none'; } }
function clearFilters(){ document.getElementById('filterEmployee').value='all'; document.getElementById('filterDate').value=''; renderTable(); }

// ===== Export Excel =====
function exportExcel(){
  const wb=XLSX.utils.book_new(); const ws_data=[['Ø§Ù„Ø±Ù‚Ù…','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø¯Ø®ÙˆÙ„','Ø®Ø±ÙˆØ¬','Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„','Ø§Ù„Ø­Ø§Ù„Ø©']];
  document.querySelectorAll('#attendanceTable tbody tr').forEach((tr,i)=>{
    if(tr.style.display==='none') return;
    const tds=[...tr.cells].map(td=>td.textContent);
    ws_data.push(tds);
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb,ws,'Attendance'); XLSX.writeFile(wb,'attendance.xlsx');
}

// ===== Reports =====
function generateReport(){ exportExcel(); alert('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±!'); }
</script>

</body>
</html>
