<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام الحضور</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #f0f4f7, #d9e2ec);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
    margin: 0;
  }

  h1 {
    color: #333;
    margin-bottom: 20px;
  }

  #instruction {
    font-size: 1.3em;
    margin: 15px 0;
    padding: 10px 20px;
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .in-success {
    background-color: #d4edda;
    color: #155724;
    border: 2px solid #155724;
  }

  .in-exit {
    background-color: #fff3cd;
    color: #856404;
    border: 2px solid #856404;
  }

  .in-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 2px solid #721c24;
  }

  #result {
    font-size: 1.5em;
    margin-top: 10px;
    text-align: center;
    color: #222;
  }

  #qr-reader {
    width: 100%;
    max-width: 400px;
    margin: 20px auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<h1>نظام الحضور</h1>
<div id="instruction" class="in-success">امسح بطاقة QR</div>
<div id="result"></div>
<div id="qr-reader"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, where, orderBy, limit, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDVbS9U5qVC4DSk326d0ljW6ETGkyHVLUQ",
  authDomain: "ladg-attendance.firebaseapp.com",
  projectId: "ladg-attendance",
  storageBucket: "ladg-attendance.firebasestorage.app",
  messagingSenderId: "499991014945",
  appId: "1:499991014945:web:e4cd793de709191a157d60"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// قائمة المستخدمين
const users = {
  "123-456-7891": "رضا جمال",
  "67890": "زهراء سليمان"
};

const instructionEl = document.getElementById("instruction");
const resultEl = document.getElementById("result");

async function registerAttendance(decodedText) {
  let code = decodedText;
  try {
    const url = new URL(decodedText);
    code = url.searchParams.get("id") || decodedText;
  } catch(e){}

  if(!users[code]){
    instructionEl.innerText = "⚠️ كود غير معروف. امسح البطاقة التالية";
    instructionEl.className = "in-error";
    resultEl.innerText = code;
    return;
  }

  const name = users[code];
  const now = new Date();
  const date = now.toLocaleDateString("en-CA");
  const time = now.toLocaleTimeString();

  const q = query(
    collection(db, "attendance"),
    where("code", "==", code),
    where("date", "==", date),
    orderBy("timestamp","desc"),
    limit(1)
  );
  const qSnap = await getDocs(q);

  let status="دخول";
  let classStatus="in-success";
  if(!qSnap.empty && qSnap.docs[0].data().status==="دخول"){
    status="خروج";
    classStatus="in-exit";
  }

  await addDoc(collection(db, "attendance"), {
    code, name, date, time, status, timestamp: Date.now()
  });

  instructionEl.innerText=`✔️ تم تسجيل ${status}. امسح البطاقة التالية`;
  instructionEl.className = classStatus;
  resultEl.innerHTML=`${name}<br>${date} - ${time}`;
}

// تهيئة QR Scanner للعمل على iPhone وAndroid
const html5QrCode = new Html5Qrcode("qr-reader");

// خيارات قراءة QR
const config = { 
  fps: 15,         // سرعة الفحص
  qrbox: 300,      // حجم مربع القراءة
  experimentalFeatures: { useBarCodeDetectorIfSupported: true } // لتحسين الأداء على iOS
};

html5QrCode.start(
  { facingMode: "environment" }, // الكاميرا الخلفية
  config,
  decodedText => registerAttendance(decodedText),
  errorMessage => {
    // تجاهل الأخطاء الصغيرة
    console.log("QR scan error:", errorMessage);
  }
).catch(err => {
  console.error("فشل تشغيل الكاميرا:", err);
});
</script>

</body>
</html>
