<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Attendance</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:sans-serif; text-align:center; padding:20px; background:#f0f0f0; }
#reader { width:300px; margin:auto; }
#instruction { margin-bottom:15px; font-weight:bold; font-size:18px; color:#333; }
#result { background:#fff; padding:15px; border-radius:10px; box-shadow:0 0 8px #aaa; font-size:16px; min-height:50px; }
.in-success { color:green; }
.in-exit { color:blue; }
.in-error { color:red; }
</style>
</head>
<body>

<h2>نظام الحضور والانصراف QR</h2>
<div id="instruction">جاهز لمسح البطاقة...</div>
<div id="reader"></div>
<div id="result"></div>

<script>
// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyDVbS9U5qVC4DSk326d0ljW6ETGkyHVLUQ",
  authDomain: "ladg-attendance.firebaseapp.com",
  projectId: "ladg-attendance",
  storageBucket: "ladg-attendance.appspot.com",
  messagingSenderId: "499991014945",
  appId: "1:499991014945:web:e4cd793de709191a157d60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- قائمة المستخدمين ----------
const users = {
  "123-456-7907": "Mais Salloum",
  "123-456-7905": "Waad Al-Ahmad",
  "123-456-7902": "Jomaa Al-Mohammad",
  "123-456-7901": "Hadi Jaafar",
  "123-456-7899": "Mohammad Jaafar",
  "123-456-7904": "Anwar Nemer",
  "123-456-7903": "Mohsen Youssef",
  "123-456-7897": "Elsy Abdul Sater",
  "123-456-7898": "Ghadir Mostafa",
  "123-456-8965": "Jihad al ali",
  "123-456-8965": "Nida al ali",
  "123-456-8963": "Ali jaafar",
  "123-456-7891": "Rida Al-Jomaa",
  "123-456-7890": "Jackleen Jaafar",
  "123-456-7908": "Zahraa Zaiter"
};

// ---------- تشغيل الكاميرا ----------
const scanner = new Html5Qrcode("reader");
scanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  (decodedText) => processQR(decodedText),
  (error) => { /* minor errors ignored */ }
);

// ---------- معالجة QR ----------
async function processQR(code) {
  const instructionEl = document.getElementById("instruction");
  const resultEl = document.getElementById("result");

  if (!users[code]) {
    instructionEl.innerText = "⚠️ كود غير معروف. امسح البطاقة التالية";
    instructionEl.className = "in-error";
    resultEl.innerText = code;
    return;
  }

  const name = users[code];
  const now = new Date();
  const date = now.toLocaleDateString("en-CA");
  const time = now.toLocaleTimeString();

  // التحقق من آخر تسجيل لنفس اليوم
  const q = await db.collection("attendance")
    .where("code", "==", code)
    .where("date", "==", date)
    .orderBy("timestamp", "desc")
    .limit(1)
    .get();

  let status = "دخول";
  let classStatus = "in-success";
  if (!q.empty && q.docs[0].data().status === "دخول") {
    status = "خروج";
    classStatus = "in-exit";
  }

  // تسجيل الدخول/الخروج في Firebase
  await db.collection("attendance").add({
    code: code,
    name: name,
    date: date,
    time: time,
    status: status,
    timestamp: Date.now()
  });

  instructionEl.innerText = `✔️ تم تسجيل ${status}. امسح البطاقة التالية`;
  instructionEl.className = classStatus;
  resultEl.innerHTML = `${name}<br>${date} - ${time}`;
}
</script>

</body>
</html>
