<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“’ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</title>
<style>
body { font-family:"Cairo",sans-serif; background:#f4f4f4; margin:0; padding:20px; }
h2 { text-align:center; color:#C1272D; margin-bottom:20px; }
form { display:grid; gap:15px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-bottom:20px; }
form label { font-weight:bold; }
form input, form select, form textarea { width:95%; padding:8px; border:1px solid #ccc; border-radius:5px; }
form button { padding:10px; background:#C1272D; color:#fff; border:none; border-radius:5px; cursor:pointer; }
form button:hover { background:#a81f25; }
#search { margin-bottom:20px; padding:10px; width:94%; border-radius:5px; border:1px solid #ccc; }
.cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:15px; }
.card { background:#fff; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); position:relative; }
.card h3 { margin:0 0 10px 0; color:#C1272D; }
.card button { margin:2px; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
.card button.delete{ background:#e74c3c; color:#fff; }
.card button.edit{ background:#3498db; color:#fff; }
.card button.export{ background:#27ae60; color:#fff; position:absolute; top:10px; right:10px; }
#logout { padding:10px 20px; background:#444; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-bottom:20px; }
#logout:hover { background:#222; }
#itemField div { margin-bottom:5px; }
</style>
</head>
<body>

<div id="loginSection">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <form id="loginForm">
    <label>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="email" required>
    <label>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="password" id="password" required>
    <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button type="button" id="resetPassword">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
  </form>
</div>

<div id="appSection" style="display:none;">
  <button id="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  <h2>ğŸ“’ Ø³Ø¬Ù„ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</h2>
  <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§...">

  <form id="donationForm">
    <label>Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªØ¨Ø±Ø¹</label>
    <input type="text" id="invoiceNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©" required>

    <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ¨Ø±Ø¹</label>
    <select id="type" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
      <option value="Ù…ØµØ§Ø±ÙŠ">Ù…ØµØ§Ø±ÙŠ</option>
      <option value="Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
      <option value="Ù…Ù„Ø§Ø¨Ø³">Ù…Ù„Ø§Ø¨Ø³</option>
      <option value="Ø£Ø­Ø°ÙŠØ©">Ø£Ø­Ø°ÙŠØ©</option>
      <option value="Ø£Ø¯ÙˆÙŠØ©">Ø£Ø¯ÙˆÙŠØ©</option>
      <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
    </select>

    <div id="moneyField" style="display:none;">
      <label>ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="amount">
      <label>ğŸ’± Ø§Ù„Ø¹Ù…Ù„Ø©</label>
      <select id="currency">
        <option value="Ø¯ÙˆÙ„Ø§Ø±">Ø¯ÙˆÙ„Ø§Ø±</option>
        <option value="Ù„.Ù„">Ù„.Ù„</option>
      </select>
    </div>

    <div id="itemField" style="display:none;">
      <label>ğŸ“¦ Ø§Ù„Ø¹Ù†Ø§ØµØ±</label>
      <div id="itemsContainer"></div>
      <div style="display:flex; gap:5px; margin-top:5px; flex-wrap:wrap;">
        <input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±">
        <input type="number" id="itemQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="0.01" step="0.01">
        <select id="itemUnit">
          <option value="ÙƒÙŠÙ„Ùˆ">ÙƒÙŠÙ„Ùˆ</option>
          <option value="ØºØ±Ø§Ù…">ØºØ±Ø§Ù…</option>
          <option value="Ù„ØªØ±">Ù„ØªØ±</option>
          <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
        </select>
        <input type="number" id="itemWeight" placeholder="Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©" min="0.01" step="0.01">
        <button type="button" id="addItem">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
      </div>
    </div>

    <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¨Ø±Ø¹</label>
    <input type="text" id="name" required>
    <label>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
    <input type="text" id="address" required>
    <label>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="text" id="phone" required>
    <label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
    <textarea id="notes"></textarea>
    <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¨Ø±Ø¹</button>
  </form>

  <div class="cards" id="donationCards"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGiHaLE8lWuvJgVjDJjw0PXTjdBfTrzno",
  authDomain: "prizezone-app.firebaseapp.com",
  projectId: "prizezone-app",
  storageBucket: "prizezone-app.appspot.com",
  messagingSenderId: "244427738881",
  appId: "1:244427738881:web:4a666ce66f74f4994e5500"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginSection = document.getElementById('loginSection');
const appSection = document.getElementById('appSection');
const typeSelect = document.getElementById('type');
const moneyField = document.getElementById('moneyField');
const itemField = document.getElementById('itemField');
const itemsContainer = document.getElementById('itemsContainer');
const itemsList = [];

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚
onAuthStateChanged(auth, user => {
  if(user){ loginSection.style.display='none'; appSection.style.display='block'; renderCards(); }
  else { loginSection.style.display='block'; appSection.style.display='none'; }
});

// Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±
document.getElementById('addItem').addEventListener('click', ()=>{
  const name = document.getElementById('itemName').value.trim();
  const quantity = parseFloat(document.getElementById('itemQuantity').value);
  const unit = document.getElementById('itemUnit').value;
  const weight = parseFloat(document.getElementById('itemWeight').value);
  if(!name || !quantity || !unit || !weight){ alert('âš ï¸ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }

  const item = {name, quantity, unit, weight};
  itemsList.push(item);

  const div = document.createElement('div');
  div.textContent = `${name} - ${quantity} ${unit} - ${weight} ÙƒØº Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©`;
  itemsContainer.appendChild(div);

  document.getElementById('itemName').value='';
  document.getElementById('itemQuantity').value='';
  document.getElementById('itemWeight').value='';
});

// ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
typeSelect.addEventListener('change', ()=>{
  if(typeSelect.value==='Ù…ØµØ§Ø±ÙŠ'){ moneyField.style.display='block'; itemField.style.display='none'; itemsList.length=0; itemsContainer.innerHTML=''; }
  else if(typeSelect.value!==''){ moneyField.style.display='none'; itemField.style.display='block'; itemsList.length=0; itemsContainer.innerHTML=''; }
  else { moneyField.style.display='none'; itemField.style.display='none'; itemsList.length=0; itemsContainer.innerHTML=''; }
});

// Ø­ÙØ¸ Ø§Ù„ØªØ¨Ø±Ø¹
document.getElementById('donationForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const invoice = document.getElementById('invoiceNumber').value.trim();
  if(!invoice){ alert('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); return; }

  if(typeSelect.value==='Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©' && itemsList.length===0){ alert('âš ï¸ Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯'); return; }

  const donation = {
    invoiceNumber: invoice,
    type: typeSelect.value,
    name: document.getElementById('name').value,
    address: document.getElementById('address').value,
    phone: document.getElementById('phone').value,
    notes: document.getElementById('notes').value,
    date: new Date().toISOString()
  };
  if(typeSelect.value==='Ù…ØµØ§Ø±ÙŠ'){ donation.amount = document.getElementById('amount').value; donation.currency = document.getElementById('currency').value; }
  else { donation.items = [...itemsList]; }

  try {
    await addDoc(collection(db,"donations"), donation);
    e.target.reset();
    moneyField.style.display='none';
    itemField.style.display='none';
    itemsList.length=0;
    itemsContainer.innerHTML='';
  } catch(err){ alert(err.message); }
});

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª
function renderCards(filter=''){
  const container = document.getElementById('donationCards');
  const q = query(collection(db,"donations"), orderBy("date","desc"));
  onSnapshot(q, snapshot=>{
    container.innerHTML='';
    snapshot.forEach(docSnap=>{
      const donation = docSnap.data(); donation.id = docSnap.id;
      if(filter && !Object.values(donation).some(v=>v && JSON.stringify(v).toLowerCase().includes(filter.toLowerCase()))) return;
      const card = document.createElement('div'); card.className='card';
      let content = `<h3>ÙØ§ØªÙˆØ±Ø©: ${donation.invoiceNumber} - Ù†ÙˆØ¹ Ø§Ù„ØªØ¨Ø±Ø¹: ${donation.type}</h3>`;
      if(donation.type==='Ù…ØµØ§Ø±ÙŠ'){ content += `<p>ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº: ${donation.amount} ${donation.currency}</p>`; }
      else{
        content += `<p>ğŸ“¦ Ø§Ù„Ø¹Ù†Ø§ØµØ±:</p>`;
        let totalWeight = 0;
        donation.items.forEach(item=>{
          content += `<p>â€¢ ${item.name} - ${item.quantity} ${item.unit} - ${item.weight} ÙƒØº Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©</p>`;
          totalWeight += item.quantity*item.weight;
        });
        content += `<p>âš–ï¸ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalWeight.toFixed(2)} ÙƒØº</p>`;
      }
      content += `<p>ğŸ‘¤ Ø§Ù„Ù…ØªØ¨Ø±Ø¹: ${donation.name}</p>`;
      content += `<p>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${donation.address}</p>`;
      content += `<p>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${donation.phone}</p>`;
      content += `<p>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${donation.notes}</p>`;
      content += `<p>â° Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(donation.date).toLocaleString()}</p>`;
      content += `<button class="delete" onclick="deleteDonation('${donation.id}')">ğŸ—‘ Ø­Ø°Ù</button>`;
      container.appendChild(card);
    });
  });
}

// Ø­Ø°Ù Ø§Ù„ØªØ¨Ø±Ø¹
window.deleteDonation = async function(id){
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¨Ø±Ø¹ØŸ')){
    try { await deleteDoc(doc(db,"donations",id)); } catch(err){ alert(err.message); }
  }
}

// Ø§Ù„Ø¨Ø­Ø«
document.getElementById('search').addEventListener('input', function(){ renderCards(this.value); });
</script>
</body>
</html>
