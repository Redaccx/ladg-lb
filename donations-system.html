<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📒Donations system </title>
<style>
body { font-family:"Cairo",sans-serif; background:#f4f4f4; margin:0; padding:20px; }
h2 { text-align:center; color:#C1272D; margin-bottom:20px; }
form { display:grid; gap:15px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-bottom:20px; }

#loginSection form {
  width: 90%;
  max-width: 400px; 
  margin: 20px auto; 
  padding: 20px;
}
form label { font-weight:bold; }
form input, form select, form textarea { width:95%; padding:8px; border:1px solid #ccc; border-radius:5px; }
form button { padding:10px;background:#C1272D;color:#fff; border:none; border-radius:5px; cursor:pointer; }
form button:hover { background:#a81f25; }

/* فقط لأجهزة اللابتوب والشاشات الكبيرة */
@media screen and (min-width: 1024px) {
  #donationForm {
    width: 1000px;       /* حجم مناسب على اللابتوب */
    margin: 30px auto;  /* يركّز النموذج بالوسط */
    padding: 25px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
    border-radius: 10px;
  }
}
#search { margin-bottom:20px; padding:10px; width:94%; border-radius:5px; border:1px solid #ccc; text-align: center; }
.cards { text-align: center; display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:40px; }
.card { background:#fff; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); position:relative; }
.card h3 { margin:0 0 10px 0; color:#C1272D; }
.card button { padding:7px 10px; border:none; border-radius:5px; cursor:pointer; }
.card button.delete { background:#e74c3c; color:#fff; }
.card button.edit { background:#3498db; color:#fff; }
.card button.viewItems { background:#8e44ad; color:#fff; margin-top:5px; }
#logout { padding:10px 20px; background:#444; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-bottom:20px; }
#logout:hover { background:#222; }
#itemField div { margin-bottom:5px; }
.password-container { position:relative; }
.password-container button { position:absolute; left:5px; top:50%; transform:translateY(-50%); padding:5px; cursor:pointer; background:none; border:none; font-size:1.2em; }
#exportExcelBtn, { text-align:center;padding:10px; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-bottom:20px; margin-right:5px; }
#exportExcelBtn { background:#27ae60; }
#exportExcelBtn:hover { background:#1e8449; }
#exportWordBtn { background:#f39c12; }
#exportWordBtn:hover { background:#d68910; }
.items-list { display:none; margin-top:10px; border-top:1px dashed #ccc; padding-top:5px; }
.item-entry { display:flex; justify-content:space-between; margin-bottom:5px; }
.item-entry button { margin-left:5px; padding:2px 5px; font-size:12px; }
.card-buttons { display:flex; gap:10px; margin-top:10px; }
#loginSection, #appSection { display:none; }
#loading {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: #ffffff;
  display:flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index:1000;
  font-family:"Cairo", sans-serif;
  color:#C1272D;
}
#loading p { margin-top:20px; font-size:18px; letter-spacing:1px; font-weight:600; }
.loader { display: flex; gap:15px; }
.loader div { width: 20px; height: 20px; border-radius: 50%; background: #C1272D; box-shadow: 0 0 10px #C1272D, 0 0 20px #e74c3c, 0 0 30px #ff6f61; animation: bounce 0.8s infinite alternate ease-in-out, glow 1.2s infinite alternate; }
.loader div:nth-child(2) { animation-delay: 0.2s; background:#e74c3c; box-shadow: 0 0 10px #e74c3c, 0 0 20px #ff6f61, 0 0 30px #C1272D;}
.loader div:nth-child(3) { animation-delay: 0.4s; background:#ff6f61; box-shadow: 0 0 10px #ff6f61, 0 0 20px #C1272D, 0 0 30px #e74c3c;}
@keyframes bounce { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-25px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
@keyframes glow { 0% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; } 50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; } 100% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; } }
</style>
</head>
<body>

<div id="loading">
  <div class="loader"><div></div><div></div><div></div></div>
  <p>...Loading Database</p>
</div>

<div id="loginSection">
  <h2>تسجيل الدخول</h2>
  <form id="loginForm">
    <label>📧 البريد الإلكتروني</label>
    <input type="email" id="email" required>
    <label>🔑 كلمة المرور</label>
    <div class="password-container">
      <input type="password" id="password" required>
      <button type="button" id="togglePassword">👁️</button>
    </div>
    <button type="submit">تسجيل الدخول</button>
    <button type="button" id="resetPassword">نسيت كلمة المرور؟</button>
  </form>
</div>

<div id="appSection">

  <h2>Donations Records📒</h2>


  

  <form id="donationForm">
    <label>رقم فاتورة التبرع</label>
    <input type="text" id="invoiceNumber" required>
    <label>نوع التبرع</label>
    <select id="type" required>
      <option value="">اختر النوع</option>
      <option value="مالي">مالي</option>
      <option value="مواد غذائية">مواد غذائية</option>
      <option value="ملابس">ملابس</option>
      <option value="أحذية">أحذية</option>
      <option value="أدوية">أدوية</option>
      <option value="نوع آخر">نوع آخر</option>
    </select>

    <div id="moneyField" style="display:none;">
      <label>💵 المبلغ</label>
      <input type="number" id="amount" min="0.01" step="0.01">
      <label>💱 العملة</label>
      <select id="currency">
        <option value="دولار">دولار</option>
        <option value="ل.ل">ل.ل</option>
      </select>
    </div>

    <div id="itemField" style="display:none;">
      <label>📦 العناصر</label>
      <div id="itemsContainer"></div>
      <div style="display:flex; gap:5px; margin-top:5px; flex-wrap:wrap;">
        <input type="text" id="itemName" placeholder="اسم العنصر">
        <input type="number" id="itemQuantity" placeholder="الكمية" min="0.01" step="0.01">
        <input type="number" id="itemWeight" placeholder="الوزن" min="0.01" step="0.01">
        <select id="itemUnit">
          <option value="كيلو">كيلو</option>
          <option value="غرام">غرام</option>
          <option value="لتر">لتر</option>
          <option value="قطعة">قطعة</option>
        </select>
        <button type="button" id="addItem">➕ إضافة العنصر</button>
      </div>
    </div>

    <label>👤 اسم المتبرع</label>
    <input type="text" id="name" required>
    <label>📍 العنوان</label>
    <input type="text" id="address" required>
    <label>📞 الهاتف</label>
    <input type="text" id="phone" required>
    <label>📝 ملاحظات</label>
    <textarea id="notes"></textarea>
    <button type="submit" id="submitDonationBtn">➕ إضافة التبرع</button>
    
    <button id="exportExcelBtn">💾 Export Excel</button>
    
<button id="logout">🚪Logout</button>    
    <input type="text" id="search" placeholder="ابحث هنا...">
  </form>
  
<div class="cards" id="donationCards"></div>



</div>

<!-- XLSX library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- docx library for Word -->
<script type="module">
import { Document, Packer, Paragraph, TextRun } from "https://cdn.jsdelivr.net/npm/docx@7.4.1/build/index.js";
window.exportToWord = async function(){
  const container = document.getElementById('donationCards');
  const cards = container.querySelectorAll('.card');
  const doc = new Document();
  cards.forEach(card => {
    const paras = [];
    card.querySelectorAll('h3, p').forEach(el=>{
      paras.push(new Paragraph({children:[new TextRun(el.innerText)]}));
    });
    doc.addSection({children: paras});
  });
  const blob = await Packer.toBlob(doc);
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "donations.docx";
  a.click();
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, query, orderBy, onSnapshot, updateDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = { apiKey:"AIzaSyBGiHaLE8lWuvJgVjDJjw0PXTjdBfTrzno", authDomain:"prizezone-app.firebaseapp.com", projectId:"prizezone-app", storageBucket:"prizezone-app.appspot.com", messagingSenderId:"244427738881", appId:"1:244427738881:web:4a666ce66f74f4994e5500" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginSection = document.getElementById('loginSection');
const appSection = document.getElementById('appSection');
const loading = document.getElementById('loading');
const typeSelect = document.getElementById('type');
const moneyField = document.getElementById('moneyField');
const itemField = document.getElementById('itemField');
const itemsContainer = document.getElementById('itemsContainer');
const submitDonationBtn = document.getElementById('submitDonationBtn');
let itemsList = [];
let editingDonationId = null;

// Toggle password
document.getElementById('togglePassword').addEventListener('click', ()=>{
  const pass=document.getElementById('password');
  pass.type = pass.type==='password' ? 'text':'password';
});

// Auth state
onAuthStateChanged(auth, user=>{
  loading.style.display = 'flex';
  if(user){
    loginSection.style.display='none';
    appSection.style.display='block';
    renderCards().then(()=>{ loading.style.display='none'; });
  } else {
    loginSection.style.display='block';
    appSection.style.display='none';
    loading.style.display='none';
  }
});

// Login
document.getElementById('loginForm').addEventListener('submit', async e=>{
  e.preventDefault();
  try{ 
    loading.style.display='flex';
    await signInWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value);
    e.target.reset();
  } catch(err){ alert(err.message); loading.style.display='none'; }
});

// Reset password
document.getElementById('resetPassword').addEventListener('click', async ()=>{
  const email=document.getElementById('email').value;
  if(email){ try{ await sendPasswordResetEmail(auth,email); alert('📩 تم إرسال رابط إعادة التعيين'); } catch(err){ alert(err.message); } }
  else alert('⚠️ أدخل البريد الإلكتروني أولاً');
});

// Logout
document.getElementById('logout').addEventListener('click', ()=>signOut(auth));

// Type change
typeSelect.addEventListener('change', ()=>{
  if(typeSelect.value==='مالي'){ moneyField.style.display='block'; itemField.style.display='none'; itemsList=[]; itemsContainer.innerHTML=''; }
  else if(typeSelect.value!==''){ moneyField.style.display='none'; itemField.style.display='block'; itemsList=[]; itemsContainer.innerHTML=''; }
  else{ moneyField.style.display='none'; itemField.style.display='none'; itemsList=[]; itemsContainer.innerHTML=''; }
});

// Add temp item
document.getElementById('addItem').addEventListener('click', ()=>{
  const name=document.getElementById('itemName').value.trim();
  const quantity=Number(document.getElementById('itemQuantity').value);
  const weight=Number(document.getElementById('itemWeight').value);
  const unit=document.getElementById('itemUnit').value;
  if(!name||isNaN(quantity)||isNaN(weight)||!unit){ alert('⚠️ املأ جميع الحقول بشكل صحيح'); return; }
  itemsList.push({name,quantity,weight,unit});
  renderTempItems();
  document.getElementById('itemName').value=''; document.getElementById('itemQuantity').value=''; document.getElementById('itemWeight').value='';
});

function renderTempItems(){
  itemsContainer.innerHTML='';
  itemsList.forEach((item,i)=>{
    const div=document.createElement('div'); div.className='item-entry';
    div.innerHTML=`${item.name} - ${item.quantity} ${item.unit} - وزن: ${item.weight} كغ
      <button onclick="editTempItem(${i})">✏️</button>
      <button onclick="deleteTempItem(${i})">❌</button>`;
    itemsContainer.appendChild(div);
  });
}
window.editTempItem = function(i){
  const item=itemsList[i];
  document.getElementById('itemName').value=item.name;
  document.getElementById('itemQuantity').value=item.quantity;
  document.getElementById('itemWeight').value=item.weight;
  document.getElementById('itemUnit').value=item.unit;
  itemsList.splice(i,1);
  renderTempItems();
}
window.deleteTempItem = function(i){ itemsList.splice(i,1); renderTempItems(); }

// Submit donation
document.getElementById('donationForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const donationData={
    invoice: document.getElementById('invoiceNumber').value,
    type: typeSelect.value,
    name: document.getElementById('name').value,
    address: document.getElementById('address').value,
    phone: document.getElementById('phone').value,
    notes: document.getElementById('notes').value,
    date: new Date().toISOString()
  };
  if(typeSelect.value==='مالي'){ donationData.amount=document.getElementById('amount').value; donationData.currency=document.getElementById('currency').value; }
  else{ donationData.items=[...itemsList]; }

  try{
    loading.style.display='flex';
    if(editingDonationId){
      await updateDoc(doc(db,'donations',editingDonationId), donationData);
      editingDonationId = null;
      submitDonationBtn.textContent = '➕ إضافة التبرع';
      alert('✅ تم حفظ التعديلات بنجاح');
    } else {
      await addDoc(collection(db,"donations"), donationData);
    }
    e.target.reset(); moneyField.style.display='none'; itemField.style.display='none'; itemsList=[]; itemsContainer.innerHTML='';
    loading.style.display='none';
  } catch(err){ alert(err.message); loading.style.display='none'; }
});

// Render cards
async function renderCards(filter=''){
  const container=document.getElementById('donationCards');
  loading.style.display='flex';
  const q=query(collection(db,"donations"), orderBy("date","desc"));
  onSnapshot(q,snapshot=>{
    container.innerHTML='';
    snapshot.forEach(docSnap=>{
      const donation=docSnap.data(); donation.id=docSnap.id;
      if(filter && !Object.values(donation).some(v=>v && JSON.stringify(v).toLowerCase().includes(filter.toLowerCase()))) return;
      const card=document.createElement('div'); card.className='card';
      let content=`<h3>التبرع: ${donation.type}</h3><p>رقم فاتورة التبرع: ${donation.invoice}</p>`;
      if(donation.type==='مالي'){ content += `<p>💵 المبلغ: ${donation.amount} ${donation.currency}</p>`; }
      card.innerHTML=content;

      if(donation.items){
        const btn=document.createElement('button'); btn.textContent='👁️ عرض العناصر'; btn.className='viewItems';
        const itemsDiv=document.createElement('div'); itemsDiv.className='items-list';
        donation.items.forEach((item,i)=>{
          const div=document.createElement('div'); div.className='item-entry';
          div.innerHTML=`${item.name} - ${item.quantity} ${item.unit} - وزن: ${item.weight} كغ
            <button onclick="editExistingItem('${donation.id}',${i})">✏️</button>
            <button onclick="deleteExistingItem('${donation.id}',${i})">❌</button>`;
          itemsDiv.appendChild(div);
        });
        btn.addEventListener('click', ()=>{ itemsDiv.style.display=itemsDiv.style.display==='none'?'block':'none'; });
        card.appendChild(btn); card.appendChild(itemsDiv);
      }

      const infoDiv=document.createElement('div');
      infoDiv.innerHTML=`<p>👤 المتبرع: ${donation.name}</p><p>📍 العنوان: ${donation.address}</p><p>📞 الهاتف: ${donation.phone}</p><p>📝 ملاحظات: ${donation.notes}</p><p>⏰ التاريخ: ${new Date(donation.date).toLocaleString()}</p>`;
      card.appendChild(infoDiv);

      const editBtn=document.createElement('button'); editBtn.className='edit'; editBtn.textContent='✏️ تعديل';
      editBtn.addEventListener('click', ()=>{
        editingDonationId = donation.id;
        typeSelect.value = donation.type; typeSelect.dispatchEvent(new Event('change'));
        document.getElementById('invoiceNumber').value = donation.invoice;
        document.getElementById('name').value = donation.name;
        document.getElementById('address').value = donation.address;
        document.getElementById('phone').value = donation.phone;
        document.getElementById('notes').value = donation.notes;
        if(donation.type==='مالي'){
          document.getElementById('amount').value = donation.amount;
          document.getElementById('currency').value = donation.currency;
        } else {
          itemsList = donation.items || [];
          renderTempItems();
        }
        submitDonationBtn.textContent = '💾 حفظ التعديلات';
      });

      const deleteBtn=document.createElement('button'); deleteBtn.className='delete'; deleteBtn.textContent='🗑 حذف';
      deleteBtn.addEventListener('click', ()=>deleteDonation(donation.id));

      const btnContainer = document.createElement('div');
      btnContainer.className = 'card-buttons';
      btnContainer.appendChild(editBtn);
      btnContainer.appendChild(deleteBtn);
      card.appendChild(btnContainer);

      container.appendChild(card);
    });
    loading.style.display='none';
  });
}

// Delete donation
async function deleteDonation(id){
  if(confirm('هل أنت متأكد من حذف هذا التبرع؟')){
    try{ await deleteDoc(doc(db,"donations",id)); }
    catch(err){ alert(err.message); }
  }
}

// Search filter
document.getElementById('search').addEventListener('input', e=>{ renderCards(e.target.value); });

// Edit/delete existing items
window.editExistingItem=async function(donationId,index){
  const docRef = doc(db,"donations",donationId);
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()){
    const donation = docSnap.data();
    const item = donation.items[index];
    document.getElementById('itemName').value=item.name;
    document.getElementById('itemQuantity').value=item.quantity;
    document.getElementById('itemWeight').value=item.weight;
    document.getElementById('itemUnit').value=item.unit;
    itemsList=[item];
    const itemsArr = donation.items.filter((_,i)=>i!==index);
    await updateDoc(docRef,{items:itemsArr});
  }
}
window.deleteExistingItem=async function(donationId,index){
  if(confirm('هل أنت متأكد من حذف هذا العنصر؟')){
    const docRef = doc(db,"donations",donationId);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const donation = docSnap.data();
      const itemsArr = donation.items.filter((_,i)=>i!==index);
      await updateDoc(docRef,{items:itemsArr});
    }
  }
}

// Export Excel
document.getElementById('exportExcelBtn').addEventListener('click', async ()=>{
  const snapshot = await getDocs(collection(db,'donations'));
  const data = snapshot.docs.map(d=>{
    const dd = d.data();
    return {
      invoice: dd.invoice,
      name: dd.name,
      phone: dd.phone,
      address: dd.address,
      notes: dd.notes,
      type: dd.type,
      amount: dd.amount || '',
      currency: dd.currency || '',
      items: dd.items ? dd.items.map(i=>`${i.name}(${i.quantity} ${i.unit}, وزن:${i.weight} كغ)`).join('; ') : '',
      date: new Date(dd.date).toLocaleString()
    };
  });
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Donations");
  XLSX.writeFile(wb, "donations.xlsx");
});



</script>
</body>
</html>
