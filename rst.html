<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS مطعم</title>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.header{background:#111;color:#fff;padding:15px;display:flex;justify-content:space-between}
.container{display:flex;height:90vh}
.products{width:60%;padding:15px;overflow:auto}
.cart{width:40%;background:#fff;padding:15px;display:flex;flex-direction:column;border-left:2px solid #ddd}
.categories button{
  margin:4px;padding:10px 15px;border:none;border-radius:6px;
  background:#ff9800;color:#fff;font-weight:bold;cursor:pointer
}
.product{
  background:#4CAF50;color:#fff;padding:15px;border-radius:8px;
  text-align:center;cursor:pointer;margin:5px;width:30%;display:inline-block
}
.cart-items{flex:1;overflow:auto}
button{padding:8px;border:none;border-radius:5px;cursor:pointer}
.save{background:#2196F3;color:#fff}
.clear{background:#e53935;color:#fff}
.extra{background:#607d8b;color:#fff}
.report{background:#ff9800;color:#fff}

#invoice{display:none}

@media print{
  body *{visibility:hidden}
  #invoice{
    visibility:visible;
    display:block !important;
    position:absolute;
    left:0;
    top:0;
    width:58mm;
    font-size:12px;
  }
}
</style>
</head>

<body>

<div class="header">
  <div>POS SYSTEM</div>
  <div>
    <button class="report" onclick="toggleDailyReport()">تقرير اليوم</button>
  </div>
</div>

<div id="dailyReport" style="display:none;background:#fff;padding:10px;border-bottom:2px solid #ddd;max-height:300px;overflow:auto"></div>

<div class="container">

<div class="products">
<h3>الفئات</h3>
<div id="categories"></div>

<input type="text" id="newCategory" placeholder="قسم جديد">
<button onclick="addCategory()">إضافة قسم</button>

<hr>

<h3>إضافة منتج</h3>
<input type="text" id="newName" placeholder="اسم المنتج">
<input type="number" id="newPrice" placeholder="السعر بالدولار">
<select id="categorySelect"></select>
<button onclick="addProduct()">إضافة</button>

<button class="extra" onclick="addExtra()">اكسترا</button>

<hr>
<div id="productGrid"></div>
</div>

<div class="cart">
<h3>السلة</h3>
<div class="cart-items" id="cartItems"></div>

<label>ضريبة %</label>
<input type="number" id="tax" value="0">

<label>خصم</label>
<input type="number" id="discount" value="0">

<div id="total"></div>

<button class="save" onclick="saveOrder()">طباعة فاتورة</button>
<button class="clear" onclick="clearCart()">مسح</button>
</div>

</div>

<div id="invoice"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey: "AIzaSyBQBGGtON-RNk4qH2Pws3RBBBE3cH3J4PU",
  authDomain: "store-app-d05fa.firebaseapp.com",
  projectId: "store-app-d05fa",
  storageBucket: "store-app-d05fa.firebasestorage.app",
  messagingSenderId: "257385912042",
  appId: "1:257385912042:web:bc30397b745340e31e2993"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let cart=[];
const USD_TO_LBP=89000;

// تحميل الفئات
async function loadCategories(){
  const snap=await db.collection("categories").get();
  categories.innerHTML="";
  categorySelect.innerHTML="";
  let first=null;

  snap.forEach(doc=>{
    const cat=doc.data().name;
    if(!first) first=cat;
    categories.innerHTML+=`<button onclick="showProducts('${cat}')">${cat}</button>`;
    categorySelect.innerHTML+=`<option value="${cat}">${cat}</option>`;
  });

  if(first) showProducts(first);
}
loadCategories();

async function addCategory(){
  if(!newCategory.value)return;
  await db.collection("categories").add({name:newCategory.value});
  newCategory.value="";
  loadCategories();
}

async function addProduct(){
  const name=newName.value;
  const price=parseFloat(newPrice.value);
  const category=categorySelect.value;
  if(!name||!price)return;
  await db.collection("products").add({name,price,category});
  newName.value="";newPrice.value="";
  showProducts(category);
}

async function showProducts(cat){
  const snap=await db.collection("products")
  .where("category","==",cat).get();
  productGrid.innerHTML="";
  snap.forEach(doc=>{
    const p=doc.data();
    productGrid.innerHTML+=`
    <div class="product" onclick="addToCart('${p.name}',${p.price})">
      ${p.name}<br>
      ${p.price}$<br>
      ${(p.price*USD_TO_LBP).toLocaleString()} ل.ل
    </div>`;
  });
}

// السلة
function addToCart(name,price){
  let item=cart.find(i=>i.name===name);
  if(item){item.qty++;item.total=item.qty*item.price}
  else{cart.push({name,price,qty:1,total:price})}
  renderCart();
}

function renderCart(){
  cartItems.innerHTML="";
  let subtotal=0;
  cart.forEach((i,index)=>{
    subtotal+=i.total;
    cartItems.innerHTML+=`
    ${i.name} ×${i.qty} = ${i.total.toFixed(2)}$
    <button onclick="removeItem(${index})">X</button><br>`;
  });

  const tax=parseFloat(tax.value)||0;
  const discount=parseFloat(discount.value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;

  total.innerHTML=`
  <hr>
  الإجمالي: ${totalUSD.toFixed(2)}$<br>
  ${(totalLBP).toLocaleString()} ل.ل
  `;
}

function removeItem(i){cart.splice(i,1);renderCart()}
function clearCart(){cart=[];renderCart()}

// اكسترا
function addExtra(){
  const name=prompt("اسم المنتج");
  const weight=parseFloat(prompt("الوزن"));
  const price=parseFloat(prompt("السعر الإجمالي"));
  if(!name||!weight||!price)return;
  cart.push({name,price,qty:weight,total:price});
  renderCart();
}

// رقم طلب متسلسل
async function getOrderNumber(){
  const ref=db.collection("counters").doc("order");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let num=1;
    if(doc.exists)num=doc.data().num+1;
    t.set(ref,{num});
    return num;
  });
}

// حفظ + طباعة
async function saveOrder(){
  if(cart.length==0)return alert("السلة فارغة");

  let subtotal=cart.reduce((s,i)=>s+i.total,0);
  let taxVal=parseFloat(tax.value)||0;
  let discountVal=parseFloat(discount.value)||0;
  let totalUSD=subtotal+(subtotal*taxVal/100)-discountVal;
  let totalLBP=totalUSD*USD_TO_LBP;
  let orderNum=await getOrderNumber();
  let today=new Date().toISOString().split("T")[0];

  await db.collection("sales").add({
    orderNum,items:cart,totalUSD,totalLBP,date:today
  });

  printInvoice(orderNum,subtotal,totalUSD,totalLBP);

  invoice.style.display="block";
  setTimeout(()=>{
    window.print();
    invoice.style.display="none";
  },200);

  clearCart();
}

function printInvoice(orderNum,subtotal,totalUSD,totalLBP){
  let html=`
  <div style="font-family:monospace;text-align:center;font-size:12px;width:58mm">
  <strong>مطعم</strong><br>
  رقم الطلب: ${orderNum}<hr>
  `;
  cart.forEach(i=>{
    html+=`${i.name} ×${i.qty}<br>${i.total.toFixed(2)}$<br>`;
  });
  html+=`
  <hr>
  الإجمالي: ${totalUSD.toFixed(2)}$<br>
  ${(totalLBP).toLocaleString()} ل.ل
  <hr>شكراً لزيارتكم
  </div>`;
  invoice.innerHTML=html;
}

// تقرير اليوم
async function toggleDailyReport(){
  let today=new Date().toISOString().split("T")[0];
  let snap=await db.collection("sales")
  .where("date","==",today).get();

  dailyReport.innerHTML="";
  snap.forEach(doc=>{
    let d=doc.data();
    dailyReport.innerHTML+=`
    طلب ${d.orderNum} - ${d.totalUSD}$ 
    <button onclick="deleteSale('${doc.id}')">حذف</button><br>`;
  });

  dailyReport.style.display=
  dailyReport.style.display=="block"?"none":"block";
}

async function deleteSale(id){
  await db.collection("sales").doc(id).delete();
  toggleDailyReport();
}
</script>

</body>
</html>
