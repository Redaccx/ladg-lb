<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS مطعم نهائي</title>
<style>
body{margin:0;font-family:Arial;background:#f4f4f4;}
.header{background:#111;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.container{display:flex;height:90vh;}
.products{width:60%;padding:10px;}
.categories{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.categories button{padding:8px;background:#ff9800;border:none;color:white;cursor:pointer;}
.categories button.active{opacity:0.6;} 
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.product{background:#4CAF50;color:white;padding:10px;text-align:center;border-radius:8px;cursor:pointer;}
.cart{width:40%;background:white;padding:10px;border-left:2px solid #ddd;display:flex;flex-direction:column;}
.cart-items{flex:1;overflow:auto;}
.total{font-weight:bold;margin-top:10px;}
button{padding:6px;margin-top:5px;border:none;color:white;cursor:pointer;}
.save{background:#2196F3;}
.clear{background:#e53935;}
.logout{background:#e53935;}
.report{background:#ff9800;}
.extra{background:#607d8b;}
input{padding:5px;margin:3px 0;width:100%;}
.login-box{max-width:320px;margin:100px auto;background:white;padding:20px;border-radius:10px;text-align:center;}
#invoice,#dailyReport{display:none;}
@media print{
  body *{visibility:hidden;}
  #invoice,#dailyReport{visibility:visible;position:absolute;left:0;top:0;width:58mm;font-size:12px;}
}
</style>
</head>

<body>

<!-- تسجيل دخول -->
<div id="loginPage" class="login-box">
<h3>تسجيل دخول</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">دخول</button>
</div>

<!-- التطبيق بعد تسجيل الدخول -->
<div id="app" style="display:none;">

<!-- الهيدر -->
<div class="header">
  <div id="userInfo"></div>
  <div>
    <button class="report" onclick="toggleDailyReport()">تقرير اليوم</button>
    <button class="logout" onclick="logout()">خروج</button>
  </div>
</div>

<!-- التقرير اليومي -->
<div id="dailyReport" style="display:none; padding:10px; background:white; border:1px solid #ddd; max-height:300px; overflow:auto;"></div>

<div class="container">

<!-- قسم المنتجات -->
<div class="products">
<h3>الفئات</h3>
<div class="categories" id="categories"></div>

<h4>إضافة قسم جديد</h4>
<input type="text" id="newCategory" placeholder="اسم القسم">
<button onclick="addCategory()" style="background:#ff9800;">إضافة قسم</button>
<hr>

<h3>المنتجات</h3>
<input type="text" id="newName" placeholder="اسم المنتج">
<input type="number" id="newPrice" placeholder="السعر بالدولار">
<select id="categorySelect"></select>
<button onclick="addProduct()" style="background:#ff9800;">إضافة منتج</button>
<br><br>
<button class="extra" onclick="addExtra()">اكسترا</button>
<hr>

<div class="grid" id="productGrid"></div>
</div>

<!-- السلة -->
<div class="cart">
<h3>الطلب</h3>
<div class="cart-items" id="cartItems"></div>

<label>ضريبة %</label>
<input type="number" id="tax" value="0">

<label>خصم</label>
<input type="number" id="discount" value="0">

<div class="total" id="total">المجموع: 0</div>

<button class="save" onclick="saveOrder()">طباعة فاتورة</button>
<button class="clear" onclick="clearCart()">مسح</button>
</div>
</div>
</div>

<!-- الفاتورة للطباعة -->
<div id="invoice"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig={
  apiKey: "AIzaSyBQBGGtON-RNk4qH2Pws3RBBBE3cH3J4PU",
  authDomain: "store-app-d05fa.firebaseapp.com",
  projectId: "store-app-d05fa",
  storageBucket: "store-app-d05fa.firebasestorage.app",
  messagingSenderId: "257385912042",
  appId: "1:257385912042:web:bc30397b745340e31e2993"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let cart=[];
const USD_TO_LBP=89000;

// تسجيل دخول
async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  let userCred;
  try{userCred=await auth.signInWithEmailAndPassword(email,password);}
  catch{userCred=await auth.createUserWithEmailAndPassword(email,password);}
  currentUser=userCred.user;
  document.getElementById("userInfo").innerText=currentUser.email+" | كاشير";
  loginPage.style.display="none";
  app.style.display="block";
  loadCategories();
  loadProducts();
}

// تسجيل خروج
function logout(){auth.signOut(); location.reload();}

// أقسام
async function loadCategories(){
  const div=document.getElementById("categories");
  const select=document.getElementById("categorySelect");
  div.innerHTML="";
  select.innerHTML="";

  // زر الكل
  const btnAll = document.createElement("button");
  btnAll.textContent = "الكل";
  btnAll.style.background="#333";
  btnAll.style.color="white";
  btnAll.addEventListener("click", ()=>showProducts('all', btnAll));
  div.appendChild(btnAll);

  const snap=await db.collection("categories").get();
  snap.forEach(doc=>{
    const cat=doc.data().name;

    const btnCat = document.createElement("button");
    btnCat.textContent = cat;
    btnCat.addEventListener("click", ()=>showProducts(cat, btnCat));
    div.appendChild(btnCat);

    const btnEdit = document.createElement("button");
    btnEdit.textContent = "✏";
    btnEdit.addEventListener("click", ()=>editCategory(doc.id));
    div.appendChild(btnEdit);

    // إضافة الخيار للقائمة المنسدلة
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}

async function addCategory(){
  const name=document.getElementById("newCategory").value.trim();
  if(!name) return alert("ادخل اسم القسم");
  await db.collection("categories").add({name});
  document.getElementById("newCategory").value="";
  loadCategories();
}
async function editCategory(id){
  const newName=prompt("اسم جديد للقسم:");
  if(!newName) return;
  await db.collection("categories").doc(id).update({name:newName});
  loadCategories();
}

// المنتجات
async function loadProducts(){
  const grid=document.getElementById("productGrid");
  grid.innerHTML="";
  const snap=await db.collection("products").get();
  snap.forEach(doc=>{
    const p=doc.data();
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`${p.name} - ${p.category}<br>${p.price}$ (${(p.price*USD_TO_LBP).toLocaleString()} ل.ل)
      <br><button onclick="deleteProduct('${doc.id}')"
      style="background:red;">X</button>`;
    div.onclick=function(e){if(e.target.tagName==="BUTTON") return; addToCart(p.name,p.price);}
    grid.appendChild(div);
  });
}

async function addProduct(){
  const name=document.getElementById("newName").value.trim();
  const price=parseFloat(document.getElementById("newPrice").value);
  const category=document.getElementById("categorySelect").value;
  if(!name || !price || !category) return alert("املأ البيانات");
  await db.collection("products").add({name,price,category});
  document.getElementById("newName").value="";
  document.getElementById("newPrice").value="";
  loadProducts();
}

async function deleteProduct(id){await db.collection("products").doc(id).delete(); loadProducts();}

async function showProducts(cat, button){
  document.querySelectorAll(".categories button").forEach(b=>b.classList.remove("active"));
  if(button) button.classList.add("active");

  const grid=document.getElementById("productGrid");
  grid.innerHTML="";
  let snap;
  if(cat==='all'){ snap=await db.collection("products").get(); }
  else{ snap=await db.collection("products").where("category","==",cat).get(); }
  snap.forEach(doc=>{
    const p=doc.data();
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`${p.name} - ${p.category}<br>${p.price}$ (${(p.price*USD_TO_LBP).toLocaleString()} ل.ل)
      <br><button onclick="deleteProduct('${doc.id}')" style="background:red;">X</button>`;
    div.onclick=function(e){if(e.target.tagName==="BUTTON") return; addToCart(p.name,p.price);}
    grid.appendChild(div);
  });
}

// السلة
function addToCart(name,price){
  let existing=cart.find(i=>i.name===name);
  if(existing){existing.qty+=1; existing.total=existing.price*existing.qty;}
  else{cart.push({name,price,qty:1,total:price});}
  renderCart();
}
function renderCart(){
  const div=document.getElementById("cartItems");
  div.innerHTML="";
  let subtotal=0;
  cart.forEach((item,i)=>{
    subtotal+=item.total;
    div.innerHTML+=`${item.name} × ${item.qty} = ${item.total.toFixed(2)}$ (${(item.total*USD_TO_LBP).toLocaleString()} ل.ل)
      <button onclick="removeItem(${i})">❌</button><br>`;
  });
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;
  document.getElementById("total").innerText=`المجموع: ${totalUSD.toFixed(2)}$ (${totalLBP.toLocaleString()} ل.ل)`;
}
function removeItem(i){cart.splice(i,1); renderCart();}
function clearCart(){cart=[]; renderCart();}

// زر اكسترا
function addExtra(){
  const name=prompt("اسم المنتج:");
  const weight=parseFloat(prompt("أدخل الوزن بالكيلو:"));
  const price=parseFloat(prompt("أدخل السعر الإجمالي لهذا الوزن:"));
  if(!name || !weight || !price) return;
  cart.push({name, price, qty: weight, total: price});
  renderCart();
}

// فاتورة وحفظ
async function getNextNumber(){
  const ref=db.collection("counters").doc("orderCounter");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let num=1;
    if(doc.exists) num=doc.data().current+1;
    t.set(ref,{current:num});
    return num;
  });
}

async function saveOrder(){
  if(cart.length===0) return alert("السلة فارغة");
  const number=await getNextNumber();
  const subtotal=cart.reduce((s,i)=>s+i.total,0);
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;

  const now=new Date();
  const dateStr=now.toISOString().split('T')[0];

  await db.collection("sales").add({
    orderNumber:number,
    user:currentUser.email,
    items:cart,
    subtotal,
    tax,
    discount,
    totalUSD,
    totalLBP,
    date:dateStr,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP);
  window.print();
  clearCart();
}

function generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP){
  const now=new Date();
  const dateStr=now.toLocaleString("ar-EG",{hour12:false});
  let html=`<div style="font-family:monospace;width:58mm;font-size:12px;text-align:center;">
  <h3>مطعم السندويشات</h3>
  <p>رقم الطلب: ${number}</p>
  <p>التاريخ: ${dateStr}</p>
  <p>الكاشير: ${currentUser.email}</p>
  <hr>`;
  cart.forEach(item=>{
    const lbp=(item.total*USD_TO_LBP).toLocaleString();
    html+=`<p>${item.name} × ${item.qty} = ${item.total.toFixed(2)}$ (${lbp} ل.ل)</p>`;
  });
  html+=`<hr>
  <p>Subtotal: ${subtotal.toFixed(2)}$ (${(subtotal*USD_TO_LBP).toLocaleString()} ل.ل)</p>
  <p>Tax: ${tax}%</p>
  <p>Discount: ${discount}</p>
  <p><strong>Total: ${totalUSD.toFixed(2)}$ (${totalLBP.toLocaleString()} ل.ل)</strong></p>
  <hr>
  <p>شكراً لزيارتكم</p>
  </div>`;
  invoice.innerHTML=html;
}

// تقرير اليوم
async function toggleDailyReport(){
  const div=document.getElementById("dailyReport");
  if(div.style.display==="block"){ div.style.display="none"; return; }
  const today = new Date().toISOString().split('T')[0];
  const snap = await db.collection("sales").where("date","==",today).get();
  if(snap.empty){ div.innerHTML="<p>لا توجد طلبات اليوم</p>"; div.style.display="block"; return; }
  div.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    let html=`<div style="border-bottom:1px dashed #000;margin-bottom:5px;padding:5px;">
      <p>طلب #${d.orderNumber} | ${d.user}</p>
      ${d.items.map(item=>`<p>${item.name} × ${item.qty} = ${item.total.toFixed(2)}$ (${(item.total*USD_TO_LBP).toLocaleString()} ل.ل)</p>`).join('')}
      <p><strong>إجمالي الطلب: ${d.totalUSD.toFixed(2)}$ (${d.totalLBP.toLocaleString()} ل.ل)</strong></p>
      <button onclick="printSale('${doc.id}')" style="background:#2196F3;color:white;padding:3px;margin:2px;">طباعة</button>
      <button onclick="deleteSale('${doc.id}')" style="background:red;color:white;padding:3px;margin:2px;">حذف</button>
    </div>`;
    div.innerHTML+=html;
  });
  div.style.display="block";
}

async function printSale(id){
  const doc=await db.collection("sales").doc(id).get();
  if(!doc.exists) return alert("الطلب غير موجود");
  const d=doc.data();
  let html=`<div style="font-family:monospace;width:58mm;font-size:12px;text-align:center;">
  <h3>مطعم السندويشات</h3>
  <p>رقم الطلب: ${d.orderNumber}</p>
  <p>الكاشير: ${d.user}</p>
  <hr>`;
  d.items.forEach(item=>{
    const lbp=(item.total*USD_TO_LBP).toLocaleString();
    html+=`<p>${item.name} × ${item.qty} = ${item.total.toFixed(2)}$ (${lbp} ل.ل)</p>`;
  });
  html+=`<hr><p><strong>الإجمالي: ${d.totalUSD.toFixed(2)}$ (${d.totalLBP.toLocaleString()} ل.ل)</strong></p><hr><p>شكراً لتعاونكم</p></div>`;
  const inv=document.getElementById("invoice");
  inv.innerHTML=html;
  inv.style.display="block";
  window.print();
  inv.style.display="none";
}

async function deleteSale(id){
  if(confirm("هل تريد حذف هذا الطلب؟")){
    await db.collection("sales").doc(id).delete();
    alert("تم حذف الطلب");
    toggleDailyReport();
  }
}
</script>
</body>
</html>
