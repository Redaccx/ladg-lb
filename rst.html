<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Advanced</title>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;}
.header{background:#111;color:white;padding:15px;display:flex;justify-content:space-between;}
.container{display:flex;height:90vh;}
.products{width:60%;padding:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.product{background:#4CAF50;color:white;padding:15px;text-align:center;border-radius:8px;cursor:pointer;}
.cart{width:40%;background:white;padding:10px;border-left:2px solid #ddd;display:flex;flex-direction:column;}
.cart-items{flex:1;overflow:auto;}
.total{font-weight:bold;margin-top:10px;}
button{padding:8px;margin-top:5px;border:none;color:white;cursor:pointer;}
.save{background:#2196F3;}
.clear{background:#e53935;}
.report{background:#ff9800;}
.logout{background:#e53935;}
input{padding:6px;margin-top:5px;width:100%;}
.login-box{max-width:320px;margin:100px auto;background:white;padding:20px;border-radius:10px;text-align:center;}
@media print{
  body *{visibility:hidden;}
  #invoice{visibility:visible;position:absolute;left:0;top:0;width:100%;}
}
</style>
</head>

<body>

<div id="loginPage" class="login-box">
<h3>تسجيل دخول</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">دخول</button>
</div>

<div id="app" style="display:none;">
<div class="header">
<div id="userInfo"></div>
<div>
<button class="report" onclick="dailyReport()">تقرير اليوم</button>
<button class="logout" onclick="logout()">خروج</button>
</div>
</div>

<div class="container">
<div class="products">
<h3>المنتجات</h3>
<div class="grid" id="productGrid"></div>
</div>

<div class="cart">
<h3>الطلب</h3>
<div class="cart-items" id="cartItems"></div>

<label>ضريبة %</label>
<input type="number" id="tax" value="0">

<label>خصم</label>
<input type="number" id="discount" value="0">

<div class="total" id="total">المجموع: 0</div>

<button class="save" onclick="saveOrder()">حفظ + طباعة</button>
<button class="clear" onclick="clearCart()">مسح</button>
</div>
</div>
</div>

<div id="invoice"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey: "AIzaSyBQBGGtON-RNk4qH2Pws3RBBBE3cH3J4PU",
  authDomain: "store-app-d05fa.firebaseapp.com",
  projectId: "store-app-d05fa",
  storageBucket: "store-app-d05fa.firebasestorage.app",
  messagingSenderId: "257385912042",
  appId: "1:257385912042:web:bc30397b745340e31e2993"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let cart=[];

// تسجيل دخول
async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();

  let userCred;
  try{
    userCred=await auth.signInWithEmailAndPassword(email,password);
  }catch{
    userCred=await auth.createUserWithEmailAndPassword(email,password);
  }

  currentUser=userCred.user;

  document.getElementById("userInfo").innerText=currentUser.email+" | cashier";
  loginPage.style.display="none";
  app.style.display="block";

  loadProducts();
}

function logout(){
  auth.signOut();
  location.reload();
}

// تحميل المنتجات
async function loadProducts(){
  const grid=document.getElementById("productGrid");
  grid.innerHTML="";
  const snap=await db.collection("products").get();
  snap.forEach(doc=>{
    const p=doc.data();
    grid.innerHTML+=`
      <div class="product" onclick="addToCart('${p.name}',${p.price})">
      ${p.name}<br>${p.price}
      </div>`;
  });
}

function addToCart(name,price){
  cart.push({name,price});
  renderCart();
}

function renderCart(){
  let subtotal=cart.reduce((s,i)=>s+i.price,0);
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;

  let total=subtotal+(subtotal*tax/100)-discount;

  cartItems.innerHTML="";
  cart.forEach((item,i)=>{
    cartItems.innerHTML+=`${item.name} - ${item.price}
    <button onclick="removeItem(${i})">❌</button><br>`;
  });

  totalDiv.innerText="المجموع: "+total.toFixed(2);
}

function removeItem(i){
  cart.splice(i,1);
  renderCart();
}

function clearCart(){
  cart=[];
  renderCart();
}

// رقم فاتورة
async function getNextNumber(){
  const ref=db.collection("counters").doc("orderCounter");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let num=1;
    if(doc.exists) num=doc.data().current+1;
    t.set(ref,{current:num});
    return num;
  });
}

// حفظ + طباعة
async function saveOrder(){
  if(cart.length===0) return alert("السلة فارغة");

  const number=await getNextNumber();

  const subtotal=cart.reduce((s,i)=>s+i.price,0);
  const tax=parseFloat(taxInput.value)||0;
  const discount=parseFloat(discountInput.value)||0;
  const total=subtotal+(subtotal*tax/100)-discount;

  await db.collection("sales").add({
    orderNumber:number,
    user:currentUser.email,
    items:cart,
    subtotal,
    tax,
    discount,
    total,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  generateInvoice(number,subtotal,tax,discount,total);
  window.print();
  clearCart();
}

// توليد فاتورة
function generateInvoice(number,subtotal,tax,discount,total){
  invoice.innerHTML=`
  <h3>فاتورة رقم ${number}</h3>
  ${cart.map(i=>i.name+" - "+i.price).join("<br>")}
  <hr>
  Subtotal: ${subtotal}<br>
  Tax: ${tax}%<br>
  Discount: ${discount}<br>
  Total: ${total.toFixed(2)}
  `;
}

// تقرير يومي
async function dailyReport(){
  const today=new Date();
  today.setHours(0,0,0,0);

  const snap=await db.collection("sales")
    .where("createdAt",">=",today)
    .get();

  let total=0,count=0;
  snap.forEach(doc=>{
    total+=doc.data().total;
    count++;
  });

  alert("عدد الطلبات اليوم: "+count+"\nإجمالي المبيعات: "+total);
}
</script>

</body>
</html>
