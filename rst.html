<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant POS Pro</title>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;}
.header{background:#111;color:white;padding:15px;font-size:18px;display:flex;justify-content:space-between;align-items:center;}
.container{display:flex;height:90vh;}
.products{width:65%;padding:10px;}
.categories{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;}
.categories button{padding:10px;background:#ff9800;border:none;color:white;cursor:pointer;font-weight:bold;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.product-box{background:#4CAF50;color:white;padding:10px;text-align:center;border-radius:8px;}
.product-box button{margin-top:5px;padding:5px;font-size:12px;border:none;cursor:pointer;}
.edit-btn{background:#607d8b;color:white;}
.delete-btn{background:#e53935;color:white;}
.product-btn{width:100%;padding:10px;background:transparent;border:none;color:white;font-size:14px;cursor:pointer;}
.cart{width:35%;background:white;padding:10px;border-left:2px solid #ddd;display:flex;flex-direction:column;}
.cart-items{flex:1;overflow:auto;font-size:14px;}
.total{font-weight:bold;margin-top:5px;}
button{padding:8px;margin-top:5px;border:none;color:white;cursor:pointer;}
.print{background:#2196F3;}
.clear{background:#e53935;}
.report{background:#9c27b0;}
.shift{background:#ff5722;}
.logout{background:#e53935;}
.login-box{max-width:300px;margin:100px auto;background:white;padding:20px;border-radius:10px;text-align:center;}
input,select{padding:5px;margin:5px 0;width:100%;}
@media print{
body *{visibility:hidden;}
#invoice,#invoice *{visibility:visible;}
#invoice{position:absolute;left:0;top:0;width:58mm;font-size:12px;}
}
</style>
</head>

<body>

<div id="loginPage" class="login-box">
<h3>تسجيل دخول الكاشير</h3>
<input type="text" id="cashierName" placeholder="اسم الكاشير">
<button onclick="login()">دخول</button>
</div>

<div id="posSystem" style="display:none;">
<div class="header">
<div id="cashierDisplay"></div>
<button class="logout" onclick="logout()">تسجيل خروج</button>
</div>

<div class="container">

<div class="products">
<div class="categories" id="categories"></div>
<div class="grid" id="productGrid"></div>
</div>

<div class="cart">
<h3>الطلب</h3>
<div class="cart-items" id="cartItems"></div>
<div class="total" id="total">المجموع: 0</div>

<select id="paymentMethod">
<option>كاش</option>
<option>فيزا</option>
</select>

<button class="print" onclick="printInvoice()">طباعة</button>
<button class="clear" onclick="clearCart()">مسح</button>
<button class="report" onclick="dailyReport()">تقرير اليوم</button>
<button class="shift" onclick="closeShift()">إغلاق شيفت</button>
</div>

</div>
</div>

<div id="invoice" style="display:none;"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let products = {};
let currentCategory = "";
let cart = [];
let cashier = "";
let role = "";
let shiftStart;

async function login(){
  const name = document.getElementById("cashierName").value;
  const pin = prompt("ادخل PIN:");
  if(!name || !pin) return alert("ادخل البيانات");

  const snap = await db.collection("cashiers")
    .where("name","==",name)
    .where("pin","==",pin)
    .get();

  if(snap.empty) return alert("بيانات غير صحيحة");

  const data = snap.docs[0].data();
  cashier = data.name;
  role = data.role;
  shiftStart = new Date();

  document.getElementById("cashierDisplay").innerText =
    "الموظف: "+cashier+" | الصلاحية: "+role;

  document.getElementById("loginPage").style.display="none";
  document.getElementById("posSystem").style.display="block";

  await loadCategories();
  await loadProducts();
}

function logout(){
  cashier="";
  cart=[];
  document.getElementById("posSystem").style.display="none";
  document.getElementById("loginPage").style.display="block";
}

async function loadCategories(){
  const div=document.getElementById("categories");
  div.innerHTML="";
  const snap=await db.collection("categories").get();
  snap.forEach(doc=>{
    const cat=doc.data().name;
    div.innerHTML+=`<button onclick="showProducts('${cat}')">${cat}</button>`;
  });
  if(role==="manager"){
    div.innerHTML+=`<button onclick="addCategory()">➕ فئة</button>`;
  }
}

async function loadProducts(){
  products={};
  const snap=await db.collection("products").get();
  snap.forEach(doc=>{
    const d=doc.data();
    if(!products[d.category]) products[d.category]=[];
    products[d.category].push({id:doc.id,name:d.name,price:d.price});
  });
}

function showProducts(cat){
  currentCategory=cat;
  const grid=document.getElementById("productGrid");
  grid.innerHTML="";
  if(!products[cat]) return;
  products[cat].forEach((p,i)=>{
    grid.innerHTML+=`
    <div class="product-box">
      <button class="product-btn" onclick="addToCart(${i})">${p.name}<br>${p.price}</button>
      ${role==="manager"?
      `<button class="edit-btn" onclick="editProduct(${i})">تعديل</button>
       <button class="delete-btn" onclick="deleteProduct(${i})">حذف</button>`:""}
    </div>`;
  });
}

async function addCategory(){
  let name=prompt("اسم الفئة:");
  if(!name) return;
  await db.collection("categories").add({name});
  await loadCategories();
}

async function editProduct(i){
  let p=products[currentCategory][i];
  let name=prompt("اسم:",p.name);
  let price=parseFloat(prompt("سعر:",p.price));
  if(!name||isNaN(price))return;
  await db.collection("products").doc(p.id).update({name,price});
  await loadProducts();
  showProducts(currentCategory);
}

async function deleteProduct(i){
  let p=products[currentCategory][i];
  await db.collection("products").doc(p.id).delete();
  await loadProducts();
  showProducts(currentCategory);
}

function addToCart(i){
  let p=products[currentCategory][i];
  cart.push({name:p.name,qty:1,price:p.price,total:p.price});
  renderCart();
}

function renderCart(){
  let div=document.getElementById("cartItems");
  div.innerHTML="";
  let total=0;
  cart.forEach((item,i)=>{
    div.innerHTML+=`${item.name} = ${item.total} <button onclick="removeItem(${i})">❌</button><br>`;
    total+=item.total;
  });
  document.getElementById("total").innerText="المجموع: "+total;
}

function removeItem(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; renderCart(); }

function generateCode(){
  return Math.random().toString(36).substring(2,6).toUpperCase();
}

async function printInvoice(){
  if(cart.length===0) return alert("لا يوجد طلب");
  let total=0;
  let payment=document.getElementById("paymentMethod").value;
  let code=generateCode();

  let counterRef=db.collection("counters").doc("orders");
  let snap=await counterRef.get();
  let orderNumber=1;
  if(snap.exists) orderNumber=snap.data().lastOrder+1;
  await counterRef.set({lastOrder:orderNumber});

  let html=`<div style="text-align:center">
  <h3>مطعم السندويشات</h3>
  <p>رقم الطلب: ${orderNumber}</p>
  <p>الكاشير: ${cashier}</p><hr>`;
  cart.forEach(item=>{html+=`<p>${item.name} = ${item.total}</p>`; total+=item.total;});
  html+=`<hr><h4>الإجمالي: ${total}</h4><p>${payment}</p></div>`;
  document.getElementById("invoice").innerHTML=html;
  document.getElementById("invoice").style.display="block";

  await db.collection("sales").add({
    cashier,role,orderNumber,total,payment,items:cart,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  window.print();
  clearCart();
}

async function dailyReport(){
  const today=new Date(); today.setHours(0,0,0,0);
  const snap=await db.collection("sales")
    .where("timestamp",">=",today).get();
  let total=0;
  snap.forEach(doc=> total+=doc.data().total);
  alert("إجمالي اليوم: "+total);
}

async function closeShift(){
  const snap=await db.collection("sales")
    .where("cashier","==",cashier)
    .where("timestamp",">=",shiftStart).get();
  let total=0;
  snap.forEach(doc=> total+=doc.data().total);
  alert("إغلاق الشيفت\nالإجمالي: "+total);
}
</script>

</body>
</html>
