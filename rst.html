<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS مطعم نهائي</title>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;}
.header{background:#111;color:white;padding:15px;display:flex;justify-content:space-between;}
.container{display:flex;height:90vh;}
.products{width:60%;padding:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.product{background:#4CAF50;color:white;padding:15px;text-align:center;border-radius:8px;cursor:pointer;}
.cart{width:40%;background:white;padding:10px;border-left:2px solid #ddd;display:flex;flex-direction:column;}
.cart-items{flex:1;overflow:auto;}
.total{font-weight:bold;margin-top:10px;}
button{padding:8px;margin-top:5px;border:none;color:white;cursor:pointer;}
.save{background:#2196F3;}
.clear{background:#e53935;}
.logout{background:#e53935;}
.report{background:#ff9800;}
input{padding:6px;margin-top:5px;width:100%;}
.login-box{max-width:320px;margin:100px auto;background:white;padding:20px;border-radius:10px;text-align:center;}
@media print{
  body *{visibility:hidden;}
  #invoice{visibility:visible;position:absolute;left:0;top:0;width:58mm;font-size:12px;}
}
</style>
</head>

<body>

<div id="loginPage" class="login-box">
<h3>تسجيل دخول</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">دخول</button>
</div>

<div id="app" style="display:none;">
<div class="header">
<div id="userInfo"></div>
<div>
<button class="logout" onclick="logout()">خروج</button>
</div>
</div>

<div class="container">
<div class="products">
<h3>المنتجات</h3>

<h4>إضافة منتج جديد</h4>
<input type="text" id="newName" placeholder="اسم المنتج">
<input type="number" id="newPrice" placeholder="السعر بالدولار">
<button onclick="addProduct()" style="background:#ff9800;">إضافة</button>
<hr>

<div class="grid" id="productGrid"></div>
</div>

<div class="cart">
<h3>الطلب</h3>
<div class="cart-items" id="cartItems"></div>

<label>ضريبة %</label>
<input type="number" id="tax" value="0">

<label>خصم</label>
<input type="number" id="discount" value="0">

<div class="total" id="total">المجموع: 0</div>

<button class="save" onclick="saveOrder()">طباعة فاتورة</button>
<button class="clear" onclick="clearCart()">مسح</button>
</div>
</div>
</div>

<div id="invoice"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// config Firebase
const firebaseConfig={
  apiKey: "AIzaSyBQBGGtON-RNk4qH2Pws3RBBBE3cH3J4PU",
  authDomain: "store-app-d05fa.firebaseapp.com",
  projectId: "store-app-d05fa",
  storageBucket: "store-app-d05fa.firebasestorage.app",
  messagingSenderId: "257385912042",
  appId: "1:257385912042:web:bc30397b745340e31e2993"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let cart=[];

// تحويل الدولار لليرة
const USD_TO_LBP = 89000;

// تسجيل دخول
async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();

  let userCred;
  try{
    userCred=await auth.signInWithEmailAndPassword(email,password);
  }catch{
    userCred=await auth.createUserWithEmailAndPassword(email,password);
  }

  currentUser=userCred.user;
  document.getElementById("userInfo").innerText=currentUser.email+" | كاشير";
  loginPage.style.display="none";
  app.style.display="block";

  loadProducts();
}

function logout(){
  auth.signOut();
  location.reload();
}

// تحميل المنتجات
async function loadProducts(){
  const grid=document.getElementById("productGrid");
  grid.innerHTML="";
  const snap=await db.collection("products").get();

  snap.forEach(doc=>{
    const p=doc.data();
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`
      ${p.name}<br>${p.price}$ (${(p.price*USD_TO_LBP).toLocaleString()} ل.ل)
      <br><button onclick="deleteProduct('${doc.id}')" style="background:red;">X</button>
    `;
    div.onclick=function(e){
      if(e.target.tagName==="BUTTON") return;
      addToCart(p.name,p.price);
    };
    grid.appendChild(div);
  });
}

// إضافة منتج
async function addProduct(){
  const name=document.getElementById("newName").value.trim();
  const price=parseFloat(document.getElementById("newPrice").value);
  if(!name || !price) return alert("املأ البيانات");
  await db.collection("products").add({name, price});
  document.getElementById("newName").value="";
  document.getElementById("newPrice").value="";
  loadProducts();
}

// حذف منتج
async function deleteProduct(id){
  await db.collection("products").doc(id).delete();
  loadProducts();
}

// إضافة للسلة
function addToCart(name,price){
  cart.push({name,price});
  renderCart();
}

// عرض السلة (يعرض الأسعار بالدولار والليرة)
function renderCart(){
  const div=document.getElementById("cartItems");
  div.innerHTML="";
  cart.forEach((item,i)=>{
    div.innerHTML+=`${item.name} - ${item.price}$ (${(item.price*USD_TO_LBP).toLocaleString()} ل.ل)
    <button onclick="removeItem(${i})">❌</button><br>`;
  });

  totalDiv.innerText="المجموع: عند الطباعة فقط";
}

function removeItem(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; renderCart(); }

// رقم فاتورة متسلسل
async function getNextNumber(){
  const ref=db.collection("counters").doc("orderCounter");
  return db.runTransaction(async t=>{
    const doc=await t.get(ref);
    let num=1;
    if(doc.exists) num=doc.data().current+1;
    t.set(ref,{current:num});
    return num;
  });
}

// طباعة فاتورة + حفظ
async function saveOrder(){
  if(cart.length===0) return alert("السلة فارغة");

  const number=await getNextNumber();
  const subtotal=cart.reduce((s,i)=>s+i.price,0);
  const tax=parseFloat(document.getElementById("tax").value)||0;
  const discount=parseFloat(document.getElementById("discount").value)||0;
  const totalUSD=subtotal+(subtotal*tax/100)-discount;
  const totalLBP=totalUSD*USD_TO_LBP;

  // حفظ في Firestore
  await db.collection("sales").add({
    orderNumber:number,
    user:currentUser.email,
    items:cart,
    subtotal,
    tax,
    discount,
    totalUSD,
    totalLBP,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP);
  window.print();
  clearCart();
}

// توليد فاتورة للطباعة الحرارية
function generateInvoice(number,subtotal,tax,discount,totalUSD,totalLBP){
  const now=new Date();
  const dateStr=now.toLocaleString("ar-EG",{hour12:false});

  let html=`
  <div style="font-family:monospace;width:58mm;font-size:12px;text-align:center;">
    <h3>مطعم السندويشات</h3>
    <p>رقم الطلب: ${number}</p>
    <p>التاريخ: ${dateStr}</p>
    <p>الكاشير: ${currentUser.email}</p>
    <hr>
  `;

  cart.forEach(item=>{
    const lbp=(item.price*USD_TO_LBP).toLocaleString();
    html+=`<p>${item.name} - ${item.price}$ (${lbp} ل.ل)</p>`;
  });

  html+=`
    <hr>
    <p>Subtotal: ${subtotal.toFixed(2)}$ (${(subtotal*USD_TO_LBP).toLocaleString()} ل.ل)</p>
    <p>Tax: ${tax}%</p>
    <p>Discount: ${discount}</p>
    <p><strong>Total: ${totalUSD.toFixed(2)}$ (${totalLBP.toLocaleString()} ل.ل)</strong></p>
    <hr>
    <p>شكراً لزيارتكم</p>
  </div>
  `;

  invoice.innerHTML=html;
}
</script>

</body>
</html>
