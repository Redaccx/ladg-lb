<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart CV Analyzer - Realistic Version</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; color: #333; padding: 15px; margin:0;}
.container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius:10px;}
h1 { color: #1e88e5; text-align:center; margin-bottom:20px;}
input[type=file] { margin-bottom: 15px; width:100%; padding:8px; font-size:1em; }
button { padding: 10px 15px; background: #1e88e5; color: #fff; border: none; cursor: pointer; border-radius: 5px; margin-bottom: 10px; display:inline-block; }
button:disabled { background: #999; cursor: not-allowed; }
.cards { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top:20px;}
.card { background: #e0f7fa; padding:15px; border-radius:10px; flex: 1 1 300px; box-shadow:0 0 8px rgba(0,0,0,0.1);}
.card h3 { margin: 0 0 10px 0; color: #1e88e5;}
.phone { font-weight:bold; color:#0d47a1; margin-top:5px; }
.status { font-weight:bold; margin-top:10px; }
.status.accept { color:green; }
.status.reject { color:red; }
.strongSkill { font-weight:bold; color:#1565c0; }
.specialty { font-weight:bold; margin-top:5px; color:#004d40; }
.score { font-weight:bold; margin-top:5px; color:#ff6f00; }
@media(max-width:600px){.cards{flex-direction:column;align-items:center;}}
</style>
</head>
<body>

<div class="container">
<h1>Smart CV Analyzer - Realistic Version</h1>
<p>Upload CV PDFs. System will detect the best specialty, give a realistic score 1-10, and accept/reject each CV.</p>

<input type="file" id="pdfFiles" accept="application/pdf" multiple>
<button id="analyzeBtn" onclick="analyzeBatch()">Analyze CVs</button>
<button id="downloadExcel" style="display:none;" onclick="downloadExcel()">Download Excel</button>

<div class="cards" id="resultsCards"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// قاعدة بيانات موسعة لكل الاختصاصات مع المهارات الأساسية (يمكن توسيعها لاحقاً)
const specialties = {
    "IT / Software Development": ["html","css","javascript","python","java","c++","c#","sql","react","nodejs","git","apis","cloud","devops"],
    "Web & Mobile Development": ["html","css","javascript","react","angular","vue","flutter","kotlin","swift","ux","ui"],
    "Data Science & Analytics": ["python","r","sql","excel","statistics","machine learning","tableau","powerbi","big data","data visualization"],
    "AI / Machine Learning": ["python","tensorflow","pytorch","deep learning","neural networks","data analysis"],
    "Cybersecurity": ["network security","ethical hacking","penetration testing","firewall","encryption","risk assessment"],
    "Cloud Computing / DevOps": ["aws","azure","gcp","docker","kubernetes","ci/cd","infrastructure"],
    "Project Management": ["project planning","risk management","budgeting","team leadership","agile","scrum","jira"],
    "Human Resources / HR": ["recruitment","employee relations","training","hr policies","payroll","performance management"],
    "Finance / Accounting": ["accounting","finance","excel","tax","budgeting","auditing","reporting","sap","quickbooks"],
    "Marketing / Digital Marketing": ["seo","sem","social media","content marketing","ads","google analytics","strategy"],
    "Sales / Customer Service": ["communication","negotiation","crm","customer support","problem solving","lead generation"],
    "Graphic Design / UI-UX": ["photoshop","illustrator","figma","sketch","indesign","creativity","branding","ux research"],
    "Mechanical / Electrical / Civil Engineering": ["cad","autocad","solidworks","matlab","engineering design","project management"],
    "Healthcare / Medical": ["patient care","medical knowledge","diagnostics","lab work","nursing skills"],
    "Education / Teaching": ["lesson planning","classroom management","curriculum development","communication"],
    "Law / Legal": ["legal research","contract drafting","compliance","litigation","communication"],
    "Research / Science": ["data analysis","laboratory","report writing","experiment design","critical thinking"],
    "Environment / Sustainability / Agriculture": ["environmental science","sustainability","agriculture","data analysis"],
    "Arts / Media / Entertainment": ["video editing","photography","sound editing","social media","creativity"],
    "Content Writing / Copywriting": ["writing","editing","blogging","seo","storytelling","social media"],
    "Video Production / Animation": ["premiere","after effects","final cut","storyboarding","motion graphics"],
    "Social Media Management": ["content creation","analytics","instagram","facebook","twitter","scheduling tools"],
    "Product Management": ["product roadmap","market research","agile","scrum","user stories","strategy"],
    "Event Management": ["planning","coordination","communication","budgeting","marketing","vendor management"],
    "QA / Testing / Compliance": ["manual testing","automation testing","bug tracking","regulatory compliance","iso standards"],
    "Psychology / Counseling / Social Work": ["counseling","therapy","case study","communication","research","assessment"],
    "Sports / Fitness / Coaching": ["physical training","coaching","fitness planning","motivation","team management"],
    "Public Relations / Communications": ["media relations","writing","public speaking","branding","social media","strategy"],
    "Energy / Renewable Energy": ["solar","wind","electrical systems","energy analysis","sustainability"],
    "E-commerce / Online Business": ["shopify","seo","digital marketing","analytics","customer service","product management"],
    "Entrepreneurship / Startups": ["business planning","fundraising","marketing","strategy","leadership","innovation"],
    "Translation / Interpretation / Languages": ["multilingual","translation","proofreading","cultural knowledge","interpretation"],
    "Veterinary / Animal Care": ["animal health","surgery","diagnostics","veterinary science","care management"],
    "Robotics / Automation": ["plc","arduino","robotics","python","sensors","automation systems"],
    "Aerospace / Space Science": ["aerodynamics","space systems","research","navigation","technical reporting"],
    "Journalism / Reporting": ["writing","research","interviewing","editing","investigative reporting"]
};

// مصفوفة لتخزين نتائج التحليل
let results = [];

// معالجة عدة ملفات CV
async function analyzeBatch() {
    const filesInput = document.getElementById('pdfFiles');
    const resultsCards = document.getElementById('resultsCards');
    const downloadBtn = document.getElementById('downloadExcel');
    const analyzeBtn = document.getElementById('analyzeBtn');
    resultsCards.innerHTML = "Processing PDFs, please wait... ⏳";
    downloadBtn.style.display = "none";
    analyzeBtn.disabled = true;

    if(filesInput.files.length === 0){
        alert("Please select at least one PDF file.");
        analyzeBtn.disabled = false;
        return;
    }

    results = [];
    for (let file of filesInput.files) {
        const text = await extractTextFromPDF(file);
        const info = extractInfo(text);
        const skillData = analyzeSkills(text, info.experience);
        const strongSkill = getStrongestSkillAI(skillData.skillsList, info.experience);
        const detectedSpecialty = detectSpecialty(skillData.skillsList);
        const statusScore = evaluateCVAI(skillData.skillsList, info, specialties[detectedSpecialty]);

        results.push({ 
            name: info.name || file.name, 
            phone: info.phone, 
            strongSkill, 
            specialty: detectedSpecialty, 
            status: statusScore.status, 
            reason: statusScore.reason, 
            score: statusScore.score,
            skillsList: skillData.skillsList,
            experience: info.experience,
            education: info.education,
            email: info.email
        });
    }

    displayResults();
}

// عرض النتائج على الصفحة
function displayResults(){
    const resultsCards = document.getElementById('resultsCards');
    resultsCards.innerHTML = "";
    results.sort((a,b)=>b.score-a.score);

    let cardsHTML = "";
    results.forEach(res=>{
        cardsHTML += `
        <div class="card">
            <h3>${res.name}</h3>
            ${res.phone?`<p class="phone">Phone: ${res.phone}</p>`:''}
            <p class="specialty">Detected Specialty: ${res.specialty}</p>
            <p>Strongest Skill: <span class="strongSkill">${res.strongSkill}</span></p>
            <p class="status ${res.status?'accept':'reject'}">Status: ${res.status?"Accepted ✅":"Rejected ❌"}</p>
            <p class="score">Smart Score: ${res.score}/10</p>
            ${res.reason?`<p>Reason: ${res.reason}</p>`:''}
        </div>`;
    });

    resultsCards.innerHTML = cardsHTML;
    document.getElementById('downloadExcel').style.display = "inline-block";
    document.getElementById('analyzeBtn').disabled = false;
}

// استخراج نص PDF + OCR عند الحاجة
async function extractTextFromPDF(file){
    const fileReader = new FileReader();
    return new Promise((resolve)=>{
        fileReader.onload = async function(){
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";

            for(let i=1;i<=pdf.numPages;i++){
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let pageText = textContent.items.map(item=>item.str).join(" ").trim();

                if(pageText.length<10){
                    const viewport = page.getViewport({scale:2});
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({canvasContext:context, viewport:viewport}).promise;
                    const {data:{text}} = await Tesseract.recognize(canvas,'eng');
                    pageText = text;
                }
                fullText += pageText + " ";
            }
            resolve(fullText.toLowerCase());
        };
        fileReader.readAsArrayBuffer(file);
    });
}

// استخراج معلومات أساسية
function extractInfo(text){
    const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
    const phoneMatch = text.match(/(\+?\d{1,4}[\s-]?)?(\(?\d{2,4}\)?[\s-]?)?[\d\s-]{5,15}/);

    let experience=[], education=[];
    const lines = text.split(/\r?\n/);
    let name = '';
    lines.forEach(line=>{
        line = line.trim();
        if(!name && line.length>2 && /^[a-zA-Z ]+$/.test(line)) name = line;
        if(/(company|position|worked at|experience|role|internship)/i.test(line)) experience.push(line);
        if(/(university|institute|bachelor|master|degree|diploma)/i.test(line)) education.push(line);
    });

    return { email: emailMatch?emailMatch[0]:'', phone: phoneMatch?phoneMatch[0]:'', experience, education, name };
}

// تحليل المهارات + وزن أكبر للخبرة
function analyzeSkills(text, experience){
    let skillsList = [];
    const allSkills = [].concat(...Object.values(specialties));
    allSkills.forEach(skill=>{
        if(text.includes(skill.toLowerCase())){
            skillsList.push(skill);
        }
    });
    experience.forEach(exp=>{
        allSkills.forEach(skill=>{
            if(exp.toLowerCase().includes(skill.toLowerCase()) && !skillsList.includes(skill)){
                skillsList.push(skill);
            }
        });
    });
    return {skillsList};
}

// اكتشاف أقوى مهارة
function getStrongestSkillAI(skillsList){
    if(skillsList.length===0) return "Not Detected";
    return skillsList[0];
}

// اكتشاف الاختصاص الأفضل
function detectSpecialty(skillsList){
    let maxMatches=0, bestMatch="General";
    for(let spec in specialties){
        const reqSkills = specialties[spec];
        let matches = reqSkills.filter(s=>skillsList.includes(s.toLowerCase())).length;
        if(matches>maxMatches){
            maxMatches = matches;
            bestMatch = spec;
        }
    }
    return bestMatch;
}

// تقييم CV ذكي + score 1-10 حسب الاختصاص
function evaluateCVAI(skillsList, info, requiredSkills){
    let missingSkills = [];
    requiredSkills.forEach(skill=>{
        if(!skillsList.includes(skill.toLowerCase())){
            missingSkills.push(skill);
        }
    });

    let score = 5; 
    if(info.experience.length>0) score += 2;
    if(info.education.length>0) score += 1;
    let matchedSkills = requiredSkills.filter(s=>skillsList.includes(s.toLowerCase())).length;
    score += matchedSkills * 1.5;
    if(score>10) score=10;
    if(score<1) score=1;

    if(missingSkills.length>3){
        return {status:false, reason:"Missing essential skills: "+missingSkills.join(", "), score};
    }
    if(info.experience.length===0){
        return {status:false, reason:"No experience listed", score};
    }

    return {status:true, reason:"All essential requirements met", score};
}

// تصدير Excel مفصل
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws_data=[["CV Name","Email","Phone","Experience","Education","Skills","Detected Specialty","Status","Reason","Smart Score"]];
    results.forEach(res=>{
        ws_data.push([
            res.name,
            res.email,
            res.phone,
            res.experience.join(" | "),
            res.education.join(" | "),
            res.skillsList.join(" | "),
            res.specialty,
            res.status?"Accepted":"Rejected",
            res.reason,
            res.score
        ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"CV Data");
    XLSX.writeFile(wb,"Smart_CV_Analysis_Realistic.xlsx");
}
</script>
</body>
</html>
