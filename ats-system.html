<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI CV Analyzer v15 — Realistic ATS (English)</title>

<!-- PDF.js + XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b0b0d; --panel:#0f1113; --accent:#00f5ff; --muted:#9fb5bd;
    --accept:#2ef08a; --reject:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, Arial; background:var(--bg); color:#fff; -webkit-font-smoothing:antialiased;}
  #bgCanvas{position:fixed;inset:0;z-index:-2}
  .wrap{max-width:1100px;margin:28px auto;padding:18px;background:rgba(10,10,10,0.6);border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.6);display:none}
  h1{color:var(--accent);text-align:center;margin:6px 0 2px;font-weight:700}
  p.lead{text-align:center;color:var(--muted);margin:0 0 14px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-bottom:12px}
  input[type=file]{padding:10px;border-radius:8px;border:1px solid rgba(0,255,255,0.06);background:#0d0d0f;color:#fff}
  button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
  button:disabled{opacity:0.45;cursor:not-allowed}
  #loader{display:none;text-align:center;color:var(--accent);margin:8px 0}
  .cards{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  .card{background:var(--panel);padding:14px;border-radius:10px;flex:1 1 330px;min-width:260px;box-shadow:0 6px 18px rgba(0,0,0,0.4);transform:translateY(18px);opacity:0;transition:all .4s ease}
  .card.show{transform:none;opacity:1}
  .card h3{margin:0 0 8px;color:var(--accent)}
  .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:0.88rem;margin-bottom:8px}
  .badge{background:rgba(0,255,255,0.03);padding:6px 8px;border-radius:8px}
  .status{font-weight:800;margin-top:6px}
  .status.accept{color:var(--accept)}
  .status.reject{color:var(--reject)}
  .small{font-size:0.85rem;color:var(--muted)}
  .details{margin-top:10px;font-size:0.88rem;color:var(--muted);line-height:1.4}
  .bar{height:10px;background:#101214;border-radius:8px;overflow:hidden}
  .barInner{height:100%;background:linear-gradient(90deg,var(--accent),#00ff9a);width:0%}
  /* confetti canvas */
  #confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;display:none}
  /* accept pulse */
  .rejectPulse{animation:rejectPulse 1s ease-in-out 3;}
  @keyframes rejectPulse{0%{box-shadow:0 0 0 rgba(255,107,107,0);}50%{box-shadow:0 0 30px rgba(255,107,107,0.45);}100%{box-shadow:0 0 0 rgba(255,107,107,0);}}
  /* footer */
  #footerText{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);color:var(--muted);font-size:0.82rem}
  /* promo */
  #promo{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.86);z-index:1000}
  #promoBox{width:92%;max-width:860px;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  #promoBox video{width:100%;display:block;object-fit:cover;height:280px}
  #promoBox .txt{padding:14px;text-align:center;color:var(--accent)}
  @media(max-width:700px){#promoBox video{height:200px}}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>
<canvas id="confettiCanvas"></canvas>

<!-- Promo / Start (user can skip) -->
<div id="promo">
  <div id="promoBox">
    <video id="promoVideo" autoplay muted playsinline preload="auto">
      <source src="https://l.top4top.io/m_357976fbq1.mp4" type="video/mp4">
    </video>
    <div class="txt">
      <h2 style="margin:0;color:var(--accent)">AI CV Analyzer — Realistic ATS</h2>
      <p style="margin:6px 0 12px;color:#f66">This page runs analysis locally — no CV leaves your machine.</p>
      <button id="startBtn">Skip & Start</button>
    </div>
  </div>
</div>

<div class="wrap" id="mainWrap">
  <h1>AI CV Analyzer v15 — Realistic ATS</h1>
  <p class="lead">Upload PDF CVs. The analyzer infers the candidate's specialty (boosts detection if the file title contains the specialty), extracts top skills and experience, and makes an Accept/Reject decision. Background music plays during analysis and stops when done.</p>

  <div class="controls">
    <input id="pdfFiles" type="file" accept="application/pdf" multiple>
    <button id="analyzeBtn">Start Analysis</button>
    <button id="downloadExcel" style="display:none">Download Excel</button>
  </div>

  <div id="loader">⏳ Processing CVs — background music playing...</div>
  <div class="cards" id="resultsCards"></div>
</div>

<div id="footerText">© programmed by Rida Jomaa</div>

<!-- AUDIO (background during analysis) -->
<audio id="bgAudio" loop preload="auto">
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="acceptSound" preload="auto">
  <source src="https://freesound.org/data/previews/273/273183_5121236-lq.mp3" type="audio/mpeg">
</audio>
<audio id="rejectSound" preload="auto">
  <source src="https://freesound.org/data/previews/331/331912_3248244-lq.mp3" type="audio/mpeg">
</audio>

<script>
/* ---------------- Background animated lines ---------------- */
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
function resizeBG(){canvas.width=innerWidth;canvas.height=innerHeight}
resizeBG(); window.addEventListener('resize', resizeBG);
let lines=[];
for(let i=0;i<60;i++){lines.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,len:30+Math.random()*150,speed:0.4+Math.random()*1.8})}
(function ani(){ctx.fillStyle='rgba(11,11,13,0.4)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='#0ff';ctx.lineWidth=1;lines.forEach(l=>{ctx.beginPath();ctx.moveTo(l.x,l.y);ctx.lineTo(l.x,l.y+l.len);ctx.stroke();l.y+=l.speed;if(l.y>canvas.height) l.y=-l.len;});requestAnimationFrame(ani)})();

/* ---------------- Promo handling ---------------- */
const promo = document.getElementById('promo'), promoVideo=document.getElementById('promoVideo'), startBtn=document.getElementById('startBtn');
startBtn.onclick = ()=>{promo.style.display='none';document.getElementById('mainWrap').style.display='block';}
promoVideo.onended = ()=>{promo.style.display='none';document.getElementById('mainWrap').style.display='block'};

/* ---------------- PDF.js worker ---------------- */
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

/* ---------------- Specialties (english) ---------------- */
const SPECIALTIES = [
  {id:'AI', name:'AI / Machine Learning', keywords:['machine learning','deep learning','neural network','tensorflow','pytorch','scikit-learn','ai','artificial intelligence','nlp','python'], minExp:1},
  {id:'Data', name:'Data Science & Analytics', keywords:['data analysis','data scientist','pandas','numpy','sql','tableau','power bi','etl','data visualization','statistics'], minExp:1},
  {id:'Web', name:'Web & Mobile Development', keywords:['javascript','react','angular','vue','node.js','frontend','backend','mobile','flutter','android','ios','html','css'], minExp:1},
  {id:'Dev', name:'Software Development', keywords:['software engineer','c++','java','c#','python','git','rest api','spring','dotnet','backend','frontend'], minExp:1},
  {id:'Sec', name:'Cybersecurity', keywords:['security','penetration testing','kali','vulnerability','cve','cyber security','siem','firewall','encryption'], minExp:1},
  {id:'PM', name:'Project Management', keywords:['project manager','scrum','agile','pmp','kanban','stakeholders','milestone'], minExp:2},
  {id:'HR', name:'Human Resources', keywords:['human resources','recruitment','talent acquisition','hr','payroll','employee relations'], minExp:1},
  {id:'Fin', name:'Finance / Accounting', keywords:['accountant','finance','audit','bookkeeping','tax','financial analysis','sap','excel','accounting'], minExp:1},
  {id:'Mkt', name:'Marketing / Digital Marketing', keywords:['marketing','seo','sem','social media','content','campaign','google analytics','advertising'], minExp:1},
  {id:'Sales', name:'Sales / Customer Service', keywords:['sales','business development','account manager','customer service','crm','lead'], minExp:0},
  {id:'Design',name:'Graphic Design / UI-UX', keywords:['ux','ui','photoshop','illustrator','figma','adobe','design','user experience','wireframe'], minExp:0}
];

/* ---------------- Regex & Education mapping ---------------- */
const EMAIL_RE = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
const PHONE_RE = /(\+?\d{1,3}[-.\s]?)?(?:\(?\d{2,4}\)?[-.\s]?){1,3}\d{3,4}/g;
const YEAR_RANGE_RE = /(?:from|since|between|from|to|–|-|–|—|until|to|from|من)?\s*(\d{4})\s*(?:to|-|–|—|until|present|now)\s*(\d{4}|present|now)/ig;
const YEARS_RE = /(\d+)\s*(?:years|yrs|year)/i;
const SPECIFIC_YEAR_RE = /\b(19|20)\d{2}\b/g;

const EDUCATION_LEVELS = [
  {level:4, keywords:['phd','ph.d','doctorate','doctoral']},
  {level:3, keywords:['master','ms','m.sc','ma','msc','mba']},
  {level:2, keywords:['bachelor','b.sc','b.sc.','bachelors','bachelor\'s','degree','bs','ba']},
  {level:1, keywords:['diploma','certificate','certified']},
  {level:0, keywords:[]}
];

/* ---------------- Confetti system ---------------- */
const confettiCanvas = document.getElementById('confettiCanvas'), confCtx = confettiCanvas.getContext('2d');
function resizeConfetti(){confCanvas.width=innerWidth;confCanvas.height=innerHeight}
const confCanvas = confettiCanvas;
resizeConfetti(); window.addEventListener('resize', resizeConfetti);
let confettiParticles = [];
function launchConfetti(){
  confCanvas.style.display='block';
  confettiParticles = [];
  const count = 120;
  for(let i=0;i<count;i++){
    confettiParticles.push({
      x: Math.random()*confCanvas.width,
      y: -20 - Math.random()*confCanvas.height/2,
      vx: -3 + Math.random()*6,
      vy: 1 + Math.random()*6,
      size: 6 + Math.random()*8,
      color: `hsl(${Math.floor(Math.random()*360)},75%,60%)`,
      rot: Math.random()*360,
      rSpeed: -0.05 + Math.random()*0.1
    });
  }
  let frames=0;
  function confettiFrame(){
    confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
    confettiParticles.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.rot += p.rSpeed;
      confCtx.save();
      confCtx.translate(p.x,p.y);
      confCtx.rotate(p.rot);
      confCtx.fillStyle = p.color;
      confCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
      confCtx.restore();
    });
    frames++;
    if(frames < 180) requestAnimationFrame(confettiFrame);
    else { confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); confCanvas.style.display='none'; }
  }
  requestAnimationFrame(confettiFrame);
}

/* ---------------- Helper functions ---------------- */
function escapeRegex(s){ return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&'); }
function escapeHtml(unsafe){ return unsafe ? unsafe.replace(/[&<"'>]/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'" :'&#039;'}[m]}) : ""; }

/* ---------------- CV evaluation (realistic) ---------------- */
function evaluateCV(text, filename){
  const lower = text.toLowerCase();
  const fileLower = (filename||'').toLowerCase();

  // extract email
  const emailMatch = lower.match(EMAIL_RE);
  const email = emailMatch ? emailMatch[0] : "";

  // extract phone
  const phoneMatches = text.match(PHONE_RE) || [];
  let phone = "";
  if(phoneMatches.length){
    phone = phoneMatches.sort((a,b)=>b.replace(/\D/g,'').length - a.replace(/\D/g,'').length)[0].trim();
  }

  // estimate yearsExp
  let yearsExp = 0;
  const yrsMatch = lower.match(YEARS_RE);
  if(yrsMatch) yearsExp = parseInt(yrsMatch[1]) || 0;
  else {
    let foundRanges=[];
    let m;
    while((m = YEAR_RANGE_RE.exec(lower)) !== null){
      const y1 = parseInt(m[1]); let y2 = m[2].toLowerCase()==='present' || m[2].toLowerCase()==='now' ? new Date().getFullYear() : parseInt(m[2]);
      if(!isNaN(y1) && !isNaN(y2) && y2>=y1) foundRanges.push(y2-y1+1);
    }
    if(foundRanges.length) yearsExp = Math.max(...foundRanges);
    else {
      const years = lower.match(SPECIFIC_YEAR_RE) || [];
      if(years.length>=2){ const nums = years.map(y=>parseInt(y)); yearsExp = Math.max(0, Math.max(...nums) - Math.min(...nums)); }
    }
  }
  yearsExp = Math.min(45, Math.max(0, Math.round(yearsExp)));

  // education
  let eduLevel = 0;
  for(const e of EDUCATION_LEVELS) for(const k of e.keywords) if(lower.includes(k)) eduLevel = Math.max(eduLevel, e.level);

  // compute specialty scores by keyword matches
  const specialtyScores = SPECIALTIES.map(spec=>{
    let matches = 0;
    for(const kw of spec.keywords){
      const re = new RegExp('\\b' + escapeRegex(kw).replace(/\s+/g,'\\s+') + '\\b', 'i');
      if(re.test(text)) matches++;
    }
    // boost if filename/title clearly contains the specialty name or id
    let titleBoost = 0;
    const nameParts = (spec.name + ' ' + spec.id).toLowerCase().split(/[\s\/]+/);
    for(const p of nameParts){
      if(p && (fileLower.includes(p) || lower.split(/\n/)[0].includes(p))) titleBoost = 0.15; // small boost if title/filename implies specialty
    }
    const skillScore = Math.min(1, (matches / Math.max(1, spec.keywords.length)) + titleBoost);
    return {id:spec.id, name:spec.name, matches, skillScore, minExp:spec.minExp};
  });

  // pick best specialty by skillScore then matches
  specialtyScores.sort((a,b)=> b.skillScore === a.skillScore ? b.matches - a.matches : b.skillScore - a.skillScore);
  const best = specialtyScores[0];

  // weights that make sense for realistic scoring (modifiable)
  const WEIGHTS = {skills:0.55, experience:0.25, education:0.20};

  const skillComponent = Math.round(best.skillScore * 100);

  const targetExp = Math.max(1, best.minExp);
  let expComponent = 0;
  if(yearsExp <= 0) expComponent = 0;
  else {
    const fullAt = targetExp + 5;
    expComponent = Math.min(100, Math.round((yearsExp / fullAt) * 100));
  }

  const eduComponent = Math.round((eduLevel / 4) * 100);

  const finalPercent = Math.round(skillComponent*WEIGHTS.skills + expComponent*WEIGHTS.experience + eduComponent*WEIGHTS.education);
  const score10 = Math.max(1, Math.round(finalPercent / 10));
  const THRESHOLD = 60; // accept threshold (can be changed)

  const accept = finalPercent >= THRESHOLD;

  // matched top keywords for strongest skills
  const matched = [];
  for(const kw of best.keywords || []){
    const re = new RegExp('\\b' + escapeRegex(kw).replace(/\s+/g,'\\s+') + '\\b','i');
    if(re.test(text)) matched.push(kw);
  }
  // add generic matches from other specialties
  const otherMatches = [];
  for(const s of SPECIALTIES){
    if(s.id === best.id) continue;
    for(const kw of s.keywords){
      const re = new RegExp('\\b' + escapeRegex(kw).replace(/\s+/g,'\\s+') + '\\b','i');
      if(re.test(text)) otherMatches.push(kw);
    }
  }

  const strongestSkill = (matched.concat(otherMatches)).slice(0,6).join(', ') || 'Problem Solving';

  return {
    specialty: best.name,
    specialtyId: best.id,
    scorePercent: finalPercent,
    score10,
    accept,
    matchedCount: best.matches,
    strongestSkill,
    components: {skills: skillComponent, experience: expComponent, education: eduComponent},
    email,
    phone,
    yearsExp,
    eduLevel
  };
}

/* ---------------- PDF extraction ---------------- */
async function extractTextFromPDF(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  let fullText = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const txt = await page.getTextContent();
    fullText += txt.items.map(t=>t.str).join(' ') + '\n';
  }
  // append filename to text (helps title detection)
  fullText += '\n' + file.name.replace(/\.[^/.]+$/,' ');
  return fullText;
}

/* ---------------- UI & orchestration ---------------- */
let results = [];
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadBtn = document.getElementById('downloadExcel');
const loader = document.getElementById('loader');
const resultsCards = document.getElementById('resultsCards');
const bgAudio = document.getElementById('bgAudio');
const acceptSound = document.getElementById('acceptSound');
const rejectSound = document.getElementById('rejectSound');

async function analyzeBatch(){
  const files = document.getElementById('pdfFiles').files;
  if(!files || files.length===0){ alert('Select at least one PDF CV.'); return; }
  analyzeBtn.disabled = true;
  downloadBtn.style.display = 'none';
  resultsCards.innerHTML = '';
  results = [];
  loader.style.display = 'block';
  // try to play background audio (user may need to interact if blocked)
  try{ await bgAudio.play(); } catch(e){ /* ignore if autoplay blocked */ }

  for(const file of files){
    try{
      const text = await extractTextFromPDF(file);
      const res = evaluateCV(text, file.name);
      const nameGuess = file.name.split(/[-_]/)[0].replace(/\.[^/.]+$/,'').trim() || 'Unknown';

      const entry = {
        fileName: file.name,
        name: nameGuess,
        email: res.email,
        phone: res.phone,
        specialty: res.specialty,
        scorePercent: res.scorePercent,
        score10: res.score10,
        accepted: res.accept,
        yearsExp: res.yearsExp,
        eduLevel: res.eduLevel,
        matchedCount: res.matchedCount,
        strongestSkill: res.strongestSkill,
        components: res.components
      };
      results.push(entry);

      // render card
      const card = document.createElement('div'); card.className='card show';
      card.innerHTML = `
        <h3>${escapeHtml(entry.name)} <span class="small" style="font-weight:600">(${escapeHtml(entry.fileName)})</span></h3>
        <div class="meta">
          <div class="badge">Specialty: <strong style="margin-left:6px">${escapeHtml(entry.specialty)}</strong></div>
          <div class="badge">Email: ${escapeHtml(entry.email || 'N/A')}</div>
          <div class="badge">Phone: ${escapeHtml(entry.phone || 'N/A')}</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Score: <strong style="color:var(--accent)">${entry.scorePercent}%</strong> (${entry.score10}/10)</div>
          <div><strong class="status ${entry.accepted ? 'accept':'reject'}">${entry.accepted ? 'ACCEPTED' : 'REJECTED'}</strong></div>
        </div>
        <div class="details">
          <div class="small" style="margin-top:6px">Years experience: <strong>${entry.yearsExp}</strong></div>
          <div style="margin-top:8px">Top skills: <strong style="color:var(--accent)">${escapeHtml(entry.strongestSkill)}</strong></div>

          <div style="margin-top:10px">
            <div class="small">Skills component: ${entry.components.skills}%</div>
            <div class="bar" style="margin-top:6px"><div class="barInner" style="width:${entry.components.skills}%"></div></div>

            <div class="small" style="margin-top:8px">Experience component: ${entry.components.experience}%</div>
            <div class="bar" style="margin-top:6px"><div class="barInner" style="width:${entry.components.experience}%"></div></div>

            <div class="small" style="margin-top:8px">Education component: ${entry.components.education}%</div>
            <div class="bar" style="margin-top:6px"><div class="barInner" style="width:${entry.components.education}%"></div></div>
          </div>
        </div>
      `;
      resultsCards.appendChild(card);

      // Animation & sound per accept/reject
      if(entry.accepted){
        try{ acceptSound.currentTime=0; acceptSound.play().catch(()=>{}); }catch(e){}
        // show confetti
        launchConfetti();
      } else {
        try{ rejectSound.currentTime=0; rejectSound.play().catch(()=>{}); }catch(e){}
        card.classList.add('rejectPulse');
      }

      // small pause between items for UX
      await new Promise(r => setTimeout(r, 350));
    } catch(err){
      console.error('Error processing', file.name, err);
      const errCard = document.createElement('div'); errCard.className='card show';
      errCard.innerHTML = `<h3>${file.name}</h3><div class="small">Error analyzing this file.</div>`;
      resultsCards.appendChild(errCard);
    }
  }

  loader.style.display = 'none';
  // stop background music
  try{ bgAudio.pause(); bgAudio.currentTime = 0; } catch(e){}
  analyzeBtn.disabled = false;
  downloadBtn.style.display = 'inline-block';
}

/* ---------------- Download Excel ---------------- */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ["File Name","Name Guess","Email","Phone","Specialty","Score (%)","Score (1-10)","Accepted","Years Experience","Education Level(0-4)","Matched Count","Top Skills"]
  ];
  results.forEach(r=> ws_data.push([r.fileName, r.name, r.email, r.phone, r.specialty, r.scorePercent, r.score10, r.accepted ? "Accepted":"Rejected", r.yearsExp, r.eduLevel, r.matchedCount, r.strongestSkill]) );
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Results");
  XLSX.writeFile(wb, "CV_Analysis_Results.xlsx");
}

/* ---------------- Bind UI ---------------- */
document.getElementById('analyzeBtn').addEventListener('click', analyzeBatch);
downloadBtn.addEventListener('click', downloadExcel);

/* Make clicking file input show instructions if audio is blocked */
document.getElementById('pdfFiles').addEventListener('change', ()=>{ /* no-op */ });

</script>
</body>
</html>
