<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CV Analyzer - Simplified & Realistic</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; color: #333; padding: 15px; margin:0;}
.container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius:10px;}
h1 { color: #1e88e5; text-align:center; margin-bottom:20px;}
input[type=file] { margin-bottom: 15px; width:100%; padding:8px; font-size:1em; }
button { padding: 10px 15px; background: #1e88e5; color: #fff; border: none; cursor: pointer; border-radius: 5px; margin-bottom: 10px; display:inline-block; }
button:disabled { background: #999; cursor: not-allowed; }
.cards { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top:20px;}
.card { background: #e0f7fa; padding:15px; border-radius:10px; flex: 1 1 300px; box-shadow:0 0 8px rgba(0,0,0,0.1);}
.card h3 { margin: 0 0 10px 0; color: #1e88e5;}
.phone { font-weight:bold; color:#0d47a1; margin-top:5px; }
.status { font-weight:bold; margin-top:10px; }
.status.accept { color:green; }
.status.reject { color:red; }
.strongSkill { font-weight:bold; color:#1565c0; }
.specialty { font-weight:bold; margin-top:5px; color:#004d40; }
.score { font-weight:bold; margin-top:5px; color:#ff6f00; }
.reason { font-style: italic; margin-top:5px; color:#d84315;}
@media(max-width:600px){.cards{flex-direction:column;align-items:center;}}
</style>
</head>
<body>

<div class="container">
<h1>CV Analyzer - Simplified & Realistic</h1>
<p>Upload CV PDFs. System detects best specialty, evaluates CV realistically, and decides Accept/Reject.</p>

<input type="file" id="pdfFiles" accept="application/pdf" multiple>
<button id="analyzeBtn" onclick="analyzeBatch()">Analyze CVs</button>
<button id="downloadExcel" style="display:none;" onclick="downloadExcel()">Download Excel</button>

<div class="cards" id="resultsCards"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// قائمة الاختصاصات فقط
const specialties = [
    "IT / Software Development",
    "Web & Mobile Development",
    "Data Science & Analytics",
    "AI / Machine Learning",
    "Cybersecurity",
    "Project Management",
    "Human Resources / HR",
    "Finance / Accounting",
    "Marketing / Digital Marketing",
    "Sales / Customer Service",
    "Graphic Design / UI-UX",
    "Mechanical / Electrical / Civil Engineering",
    "Healthcare / Medical",
    "Education / Teaching",
    "Legal / Law",
    "Supply Chain / Logistics",
    "Hospitality / Tourism",
    "Media / Journalism",
    "Art / Music / Entertainment",
    "Research / Academia",
    "Consulting / Strategy",
    "Environmental / Sustainability",
    "Blockchain / Crypto",
    "Engineering Management",
    "Data Engineering",
    "Cloud Computing",
    "DevOps",
    "Customer Success",
    "Quality Assurance / Testing",
    "Product Management",
    "Social Work / NGOs",
    "Psychology / Counseling",
    "Sports / Fitness",
    "E-commerce / Retail",
    "Public Relations",
    "Advertising",
    "Real Estate",
    "Construction",
    "Automotive Engineering",
    "Telecommunications",
    "Pharmaceutical / Biotech",
    "Nutrition / Dietetics",
    "Fashion / Design",
    "Animation / Visual Effects",
    "Photography / Videography",
    "Translation / Linguistics",
    "Event Management",
    "Entrepreneurship / Startups",
    "Blockchain Development",
    "Robotics / AI Hardware",
    "Nanotechnology",
    "Renewable Energy",
    "Geology / Earth Sciences",
    "Marine / Oceanography",
    "Aerospace Engineering",
    "Gaming / Game Development"
];

let results = [];

// معالجة عدة ملفات CV
async function analyzeBatch() {
    const filesInput = document.getElementById('pdfFiles');
    const resultsCards = document.getElementById('resultsCards');
    const downloadBtn = document.getElementById('downloadExcel');
    const analyzeBtn = document.getElementById('analyzeBtn');
    resultsCards.innerHTML = "Processing PDFs, please wait... ⏳";
    downloadBtn.style.display = "none";
    analyzeBtn.disabled = true;

    if(filesInput.files.length === 0){
        alert("Please select at least one PDF file.");
        analyzeBtn.disabled = false;
        return;
    }

    results = [];
    for (let file of filesInput.files) {
        const text = await extractTextFromPDF(file);
        const info = extractInfo(text);
        const strongSkill = getStrongestSkill(text);
        const detectedSpecialty = detectSpecialty(text);
        const statusScore = evaluateCV(text, info);

        results.push({ 
            name: info.name || file.name, 
            phone: info.phone, 
            strongSkill, 
            specialty: detectedSpecialty, 
            status: statusScore.status, 
            reason: statusScore.reason, 
            score: statusScore.score
        });
    }

    displayResults();
}

// عرض النتائج
function displayResults(){
    const resultsCards = document.getElementById('resultsCards');
    resultsCards.innerHTML = "";
    results.sort((a,b)=>b.score-a.score);

    let cardsHTML = "";
    results.forEach(res=>{
        cardsHTML += `
        <div class="card">
            <h3>${res.name}</h3>
            ${res.phone?`<p class="phone">Phone: ${res.phone}</p>`:''}
            <p class="specialty">Detected Specialty: ${res.specialty}</p>
            <p>Strongest Skill: <span class="strongSkill">${res.strongSkill}</span></p>
            <p class="status ${res.status?'accept':'reject'}">Status: ${res.status?"Accepted ✅":"Rejected ❌"}</p>
            <p class="score">Score: ${res.score}/10</p>
            ${res.reason?`<p class="reason">${res.reason}</p>`:''}
        </div>`;
    });

    resultsCards.innerHTML = cardsHTML;
    document.getElementById('downloadExcel').style.display = "inline-block";
    document.getElementById('analyzeBtn').disabled = false;
}

// استخراج نص PDF + OCR عند الحاجة
async function extractTextFromPDF(file){
    const fileReader = new FileReader();
    return new Promise((resolve)=>{
        fileReader.onload = async function(){
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";

            for(let i=1;i<=pdf.numPages;i++){
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let pageText = textContent.items.map(item=>item.str).join(" ").trim();

                if(pageText.length<10){
                    const viewport = page.getViewport({scale:2});
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({canvasContext:context, viewport:viewport}).promise;
                    const {data:{text}} = await Tesseract.recognize(canvas,'eng');
                    pageText = text;
                }
                fullText += pageText + " ";
            }
            resolve(fullText.toLowerCase());
        };
        fileReader.readAsArrayBuffer(file);
    });
}

// استخراج معلومات أساسية
function extractInfo(text){
    const phoneMatch = text.match(/(\+?\d{1,4}[\s-]?)?(\(?\d{2,4}\)?[\s-]?)?[\d\s-]{5,15}/);
    let name = text.split(/\r?\n/).find(line=>line.length>2 && /^[a-zA-Z ]+$/.test(line))||"";
    return { name, phone: phoneMatch?phoneMatch[0]:'' };
}

// أقوى كلمة كمؤشر مهارة
function getStrongestSkill(text){
    const words = text.split(/\s+/);
    if(words.length===0) return "Not Detected";
    return words[0].substring(0,15);
}

// اكتشاف الاختصاص الأنسب (أقرب اسم)
function detectSpecialty(text){
    for(let spec of specialties){
        if(text.includes(spec.toLowerCase())) return spec;
    }
    return "General";
}

// تقييم واقعي بدون نقاط محددة
function evaluateCV(text, info){
    let score = 5;
    if(text.length>500) score+=3;
    if(info.name) score+=1;
    if(score>10) score=10;
    if(score<1) score=1;

    let status = true, reason = "All essential requirements met";
    if(text.length<100) {
        status=false;
        reason="Insufficient content or experience";
    }

    return {status, reason, score};
}

// تصدير Excel
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws_data=[["CV Name","Phone","Strongest Skill","Detected Specialty","Status","Reason","Score"]];
    results.forEach(res=>{
        ws_data.push([
            res.name,
            res.phone,
            res.strongSkill,
            res.specialty,
            res.status?"Accepted":"Rejected",
            res.reason,
            res.score
        ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"CV Data");
    XLSX.writeFile(wb,"Simplified_Realistic_CV_Report.xlsx");
}
</script>
</body>
</html>
