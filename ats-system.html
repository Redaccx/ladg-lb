<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CV Hiring Analyzer with Job Selection</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; color: #333; padding: 15px; margin:0;}
.container { max-width: 900px; margin: auto; background: #fff; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius:10px;}
h1 { color: #1e88e5; text-align:center; margin-bottom:20px;}
input[type=file], select { margin-bottom: 15px; width:100%; padding:8px; font-size:1em; }
button { padding: 10px 15px; background: #1e88e5; color: #fff; border: none; cursor: pointer; border-radius: 5px; margin-bottom: 10px; display:inline-block; }
button:disabled { background: #999; cursor: not-allowed; }
.cards { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top:20px;}
.card { background: #e0f7fa; padding:15px; border-radius:10px; flex: 1 1 300px; box-shadow:0 0 8px rgba(0,0,0,0.1);}
.card h3 { margin: 0 0 10px 0; color: #1e88e5;}
.phone { font-weight:bold; color:#0d47a1; margin-top:5px; }
.status { font-weight:bold; margin-top:10px; }
.status.accept { color:green; }
.status.reject { color:red; }
.strongSkill { font-weight:bold; color:#1565c0; }
.score { font-weight:bold; margin-top:5px; color:#ff6f00; }
@media(max-width:600px){.cards{flex-direction:column;align-items:center;}}
</style>
</head>
<body>

<div class="container">
<h1>CV Hiring Analyzer</h1>
<p>Select the job role, then upload CV PDFs. Each CV will show a card with Name, Phone, Strongest Skill, Status, Reason, and Score.</p>

<select id="jobRole">
    <option value="IT Developer">IT Developer</option>
    <option value="Project Manager">Project Manager</option>
    <option value="Customer Support">Customer Support</option>
    <option value="Data Analyst">Data Analyst</option>
</select>

<input type="file" id="pdfFiles" accept="application/pdf" multiple>
<button id="analyzeBtn" onclick="analyzeBatch()">Analyze CVs</button>
<button id="downloadExcel" style="display:none;" onclick="downloadExcel()">Download Excel</button>

<div class="cards" id="resultsCards"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// مهارات لكل وظيفة
const jobRoles = {
    "IT Developer": ["html","css","javascript","python","sql"],
    "Project Manager": ["management","planning","project","team lead"],
    "Customer Support": ["communication","customer service","problem solving","teamwork"],
    "Data Analyst": ["excel","sql","python","database"]
};

let results = [];

async function analyzeBatch() {
    const filesInput = document.getElementById('pdfFiles');
    const resultsCards = document.getElementById('resultsCards');
    const downloadBtn = document.getElementById('downloadExcel');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const jobRole = document.getElementById('jobRole').value;
    const requiredSkills = jobRoles[jobRole];

    resultsCards.innerHTML = "Processing PDFs, please wait... ⏳";
    downloadBtn.style.display = "none";
    analyzeBtn.disabled = true;

    if(filesInput.files.length === 0){
        alert("Please select at least one PDF file.");
        analyzeBtn.disabled = false;
        return;
    }

    results = [];
    for (let file of filesInput.files) {
        const text = await extractTextFromPDF(file);
        const info = extractInfo(text);
        const skillData = analyzeSkills(text);
        const strongSkill = getStrongestSkill(skillData.skillsList);
        const statusScore = evaluateCV(skillData.skillsList, info, requiredSkills);

        results.push({ 
            name: info.name || file.name, 
            phone: info.phone, 
            strongSkill, 
            status: statusScore.status, 
            reason: statusScore.reason, 
            score: statusScore.score,
            skillsList: skillData.skillsList,
            experience: info.experience,
            education: info.education,
            email: info.email
        });
    }

    resultsCards.innerHTML = "";
    results.sort((a,b)=>b.score-a.score);

    let cardsHTML = "";
    results.forEach(res=>{
        cardsHTML += `
        <div class="card">
            <h3>${res.name}</h3>
            ${res.phone?`<p class="phone">Phone: ${res.phone}</p>`:''}
            <p>Strongest Skill: <span class="strongSkill">${res.strongSkill}</span></p>
            <p class="status ${res.status?'accept':'reject'}">Status: ${res.status?"Accepted ✅":"Rejected ❌"}</p>
            <p class="score">Score: ${res.score}/10</p>
            ${res.reason?`<p>Reason: ${res.reason}</p>`:''}
        </div>`;
    });

    resultsCards.innerHTML = cardsHTML;
    downloadBtn.style.display = "inline-block";
    analyzeBtn.disabled = false;
}

// استخراج نص PDF + OCR عند الحاجة
async function extractTextFromPDF(file){
    const fileReader = new FileReader();
    return new Promise((resolve)=>{
        fileReader.onload = async function(){
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";

            for(let i=1;i<=pdf.numPages;i++){
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let pageText = textContent.items.map(item=>item.str).join(" ").trim();

                if(pageText.length<10){
                    const viewport = page.getViewport({scale:2});
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({canvasContext:context, viewport:viewport}).promise;
                    const {data:{text}} = await Tesseract.recognize(canvas,'eng');
                    pageText = text;
                }
                fullText += pageText + " ";
            }
            resolve(fullText.toLowerCase());
        };
        fileReader.readAsArrayBuffer(file);
    });
}

// استخراج المعلومات الأساسية
function extractInfo(text){
    const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
    const phoneMatch = text.match(/(\+?\d{1,4}[\s-]?)?(\(?\d{2,4}\)?[\s-]?)?[\d\s-]{5,15}/);

    let experience=[], education=[];
    const lines = text.split(/\r?\n/);
    let name = '';
    lines.forEach(line=>{
        line = line.trim();
        if(!name && line.length>2 && /^[a-zA-Z ]+$/.test(line)) name = line;
        if(/(company|position|worked at|experience|role|internship)/i.test(line)) experience.push(line);
        if(/(university|institute|bachelor|master|degree|diploma)/i.test(line)) education.push(line);
    });

    return { email: emailMatch?emailMatch[0]:'', phone: phoneMatch?phoneMatch[0]:'', experience, education, name };
}

// تحليل المهارات
function analyzeSkills(text){
    let skillsList = [];
    const words = text.split(/\W+/);
    words.forEach(word=>{
        if(word.length>2) skillsList.push(word);
    });
    return { skillsList };
}

// أقوى مهارة
function getStrongestSkill(skillsList){
    if(skillsList.length===0) return "N/A";
    const freq = {};
    skillsList.forEach(skill => { freq[skill]=(freq[skill]||0)+1; });
    let sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
    return sorted[0][0];
}

// تقييم CV + score 1-10 حسب الوظيفة
function evaluateCV(skillsList, info, requiredSkills){
    let missingSkills = [];
    requiredSkills.forEach(skill=>{
        if(!skillsList.includes(skill.toLowerCase())){
            missingSkills.push(skill);
        }
    });

    let score = 5; // نقطة أساسية
    if(info.experience.length>0) score += 2;
    if(info.education.length>0) score += 1;
    let matchedSkills = requiredSkills.filter(s=>skillsList.includes(s.toLowerCase())).length;
    score += matchedSkills * 1.5;
    if(score>10) score=10;
    if(score<1) score=1;

    if(missingSkills.length>0){
        return {status:false, reason:"Missing required skills: "+missingSkills.join(", "), score};
    }
    if(info.experience.length===0){
        return {status:false, reason:"No experience listed", score};
    }

    return {status:true, reason:"All requirements met", score};
}

// تصدير Excel مفصل
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws_data=[["CV Name","Email","Phone","Experience","Education","Skills","Status","Reason","Score"]];

    results.forEach(res=>{
        ws_data.push([
            res.name,
            res.email,
            res.phone,
            res.experience.join(" | "),
            res.education.join(" | "),
            res.skillsList.join(" | "),
            res.status?"Accepted":"Rejected",
            res.reason,
            res.score
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"CV Data");
    XLSX.writeFile(wb,"CV_Hiring_Analysis_Job.xlsx");
}
</script>

</body>
</html>
